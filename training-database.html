    <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FIB DATABASE</title>
    <link rel="icon" type="image/webp" href="https://kappa.lol/aDnGzF">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script type="module">
      // Function to toggle training procedures visibility
      function toggleTrainingProcedures() {
        const container = document.getElementById('trainingProceduresContainer');
        const section = document.querySelector('.training-procedures');
        const toggleIcon = section.querySelector('.toggle-icon');
        
        if (container.style.display === 'none') {
          container.style.display = 'block';
          section.classList.add('expanded');
        } else {
          container.style.display = 'none';
          section.classList.remove('expanded');
        }
      }
      window.toggleTrainingProcedures = toggleTrainingProcedures;

      // Function to toggle individual training modules
      function toggleTrainingModule(moduleId) {
        const content = document.getElementById(`module-content-${moduleId}`);
        const header = document.getElementById(`module-${moduleId}`);
        const toggleIcon = header.querySelector('.toggle-icon');
        
        if (content.style.display === 'none') {
          content.style.display = 'block';
          header.classList.add('expanded');
        } else {
          content.style.display = 'none';
          header.classList.remove('expanded');
        }
      }
      window.toggleTrainingModule = toggleTrainingModule;

      // Training modules data
      window.trainingModules = [
        {
          id: '10codes',
          title: '10 Codes',
          content: {
            goal: 'Learn and use radio codes.',
            setup: 'Instructor calls out scenarios.',
            pass: 'Quick, accurate code responses.',
            tip: 'Start with common codes first.'
          }
        },
        {
          id: 'caselaws',
          title: 'Case Laws',
          content: {
            goal: 'Understand key legal precedents.',
            setup: 'Review major cases and discuss.',
            pass: 'Can explain case impact on procedures.',
            tip: 'Focus on practical applications.'
          }
        },
        {
          id: 'pursuit',
          title: 'Pursuit',
          content: {
            goal: 'Evaluate control and radio during chase.',
            setup: 'Instructor drives suspect car.',
            pass: 'Clear comms, proper callouts, controlled turns.',
            tip: 'Lose sight > lose safety, disengage smartly.'
          }
        },
        {
          id: 'hostage',
          title: 'Hostage',
          content: {
            goal: 'Handle hostage negotiations.',
            setup: 'Role-play with instructor as suspect.',
            pass: 'De-escalates, protects hostages, resolves safely.',
            tip: 'Time is on your side.'
          }
        },
        {
          id: 'trafficstop',
          title: 'Traffic Stop',
          content: {
            goal: 'Conduct safe and lawful vehicle stop.',
            setup: 'Random vehicle, unknown risk.',
            pass: 'Proper positioning, approach, ID check, and closure.',
            tip: 'Always call plate before approach.'
          }
        },
        {
          id: 'closequartersbreaching',
          title: 'Close Quarters Breaching',
          content: {
            goal: 'Clear rooms and buildings safely.',
            setup: 'Multi-room scenario with threats.',
            pass: 'Methodical clearing, good angles, team coordination.',
            tip: 'Slow is smooth, smooth is fast.'
          }
        },
        {
          id: 'openareabreaching',
          title: 'Open Area Breaching',
          content: {
            goal: 'Secure large outdoor areas.',
            setup: 'Open field with multiple structures.',
            pass: 'Uses cover, maintains awareness, coordinates team.',
            tip: 'Distance is your friend.'
          }
        },
        {
          id: 'scenecontrol',
          title: 'Scene Control',
          content: {
            goal: 'Manage chaotic multi-unit scene.',
            setup: 'Random civilians, media, multiple officers.',
            pass: 'Establishes perimeter, delegates roles, stays calm.',
            tip: 'Loud voice ≠ leadership — clarity does.'
          }
        },
        {
          id: 'comms',
          title: 'COMMS',
          content: {
            goal: 'Clear radio communication.',
            setup: 'High-stress scenario requiring updates.',
            pass: 'Clear, concise, complete transmissions.',
            tip: 'Think before you speak.'
          }
        },
        {
          id: 'useofforce',
          title: 'Use of Force',
          content: {
            goal: 'Correct escalation/de-escalation.',
            setup: 'Angry suspect escalating verbally.',
            pass: 'Uses verbal, then less-lethal, then lethal only if justified.',
            tip: 'Force must always be proportional.'
          }
        },
        {
          id: 'filingcharges',
          title: 'Filing Charges',
          content: {
            goal: 'Proper charge selection and documentation.',
            setup: 'Complex scenario with multiple violations.',
            pass: 'Identifies correct charges, supports with evidence.',
            tip: 'Quality over quantity.'
          }
        },
        {
          id: 'reports',
          title: 'Reports',
          content: {
            goal: 'Professional, factual reporting.',
            setup: 'Give scene notes; trainee writes a brief report.',
            pass: 'Spelling, structure, and detail are accurate.',
            tip: 'Write as if a judge will read it.'
          }
        },
        {
          id: 'gunfight',
          title: 'Gunfight',
          content: {
            goal: 'Effective combat shooting.',
            setup: 'Range drills and scenario training.',
            pass: 'Accuracy, movement, cover usage.',
            tip: 'Speed comes from smoothness.'
          }
        },
        {
          id: 'undercovertraining',
          title: 'Undercover Training',
          content: {
            goal: 'Teach blending & intel gathering.',
            setup: 'Simple buy-bust or infiltration scenario.',
            pass: 'Keeps cover story, relays info quietly.',
            tip: 'Never reveal real name or badge.'
          }
        },
        {
          id: 'helicopterlicense',
          title: 'Helicopter License',
          content: {
            goal: 'Basic flight operations.',
            setup: 'Training flights with instructor.',
            pass: 'Safe takeoff, hovering, landing.',
            tip: 'Always check weather conditions.'
          }
        },
        {
          id: 'ammunationscenecommand',
          title: 'Ammunation Scene Command',
          content: {
            goal: 'Control active shooter scene.',
            setup: 'Multiple threats in store layout.',
            pass: 'Quick response, civilian safety, threat neutralization.',
            tip: 'First 5 minutes are critical.'
          }
        },
        {
          id: 'bankheistscenecommand',
          title: 'Bank Heist Scene Command',
          content: {
            goal: 'Manage complex robbery response.',
            setup: 'Multiple suspects, hostages, entry points.',
            pass: 'Perimeter control, negotiation, tactical resolution.',
            tip: 'Control outer perimeter first.'
          }
        },
        {
          id: 'pitmaneuvertraining',
          title: 'PIT Maneuver Training',
          content: {
            goal: 'Safe pursuit termination.',
            setup: 'High-speed chase scenario.',
            pass: 'Proper speed, angle, and execution.',
            tip: 'Location and timing are everything.'
          }
        }
      ];

      // Function to populate training modules
      function populateTrainingModules() {
        const container = document.getElementById('trainingProceduresContainer');
        if (!container) return;

        trainingModules.forEach(module => {
          const moduleDiv = document.createElement('div');
          moduleDiv.className = 'training-module';
          moduleDiv.id = `module-${module.id}`;
          
          const header = document.createElement('div');
          header.className = 'training-module-header';
          header.onclick = () => toggleTrainingModule(module.id);
          header.innerHTML = `
            ${module.title}
            <span class="toggle-icon">▼</span>
          `;
          
          const content = document.createElement('div');
          content.className = 'training-module-content';
          content.id = `module-content-${module.id}`;
          content.style.display = 'none';
          content.style.position = 'relative';

          // Edit button container
          const editBtnContainer = document.createElement('div');
          editBtnContainer.style.position = 'absolute';
          editBtnContainer.style.top = '12px';
          editBtnContainer.style.right = '12px';
          editBtnContainer.style.display = 'flex';
          editBtnContainer.style.gap = '8px';

          // Edit button
          const editBtn = document.createElement('button');
          editBtn.className = 'edit-module-btn';
          editBtn.title = 'Edit Module';
          editBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          `;
          editBtn.onclick = (e) => {
            e.stopPropagation();
            editTrainingModule(module.id);
          };
          editBtnContainer.appendChild(editBtn);
          content.appendChild(editBtnContainer);
          
          // Goal section
          const goalSection = document.createElement('div');
          goalSection.className = 'training-module-section';
          goalSection.innerHTML = `
            <h4>Goal</h4>
            <p>${module.content.goal}</p>
          `;
          
          // Setup section
          const setupSection = document.createElement('div');
          setupSection.className = 'training-module-section';
          setupSection.innerHTML = `
            <h4>Setup</h4>
            <p>${module.content.setup}</p>
          `;
          
          // Pass criteria section
          const passSection = document.createElement('div');
          passSection.className = 'training-module-section';
          passSection.innerHTML = `
            <h4>Pass if</h4>
            <p>${module.content.pass}</p>
          `;
          
          // Key tip section
          const tipSection = document.createElement('div');
          tipSection.className = 'training-module-section';
          tipSection.innerHTML = `
            <h4>Key tip</h4>
            <p>${module.content.tip}</p>
          `;
          
          content.appendChild(goalSection);
          content.appendChild(setupSection);
          content.appendChild(passSection);
          content.appendChild(tipSection);
          
          moduleDiv.appendChild(header);
          moduleDiv.appendChild(content);
          container.appendChild(moduleDiv);
        });
      }

      // Call populateTrainingModules after DOM is loaded
      document.addEventListener('DOMContentLoaded', populateTrainingModules);

      // Initialize Firebase immediately
      async function initializeFirebase() {
        try {
          const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
          const { getDatabase, ref, set, onValue, update, get: fbGet } = 
            await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
          const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js");

          const firebaseConfig = {
            apiKey: "AIzaSyC8MXihU-0-FRkYwx0qrs_Sv4CKZCVgFUs",
            authDomain: "fib-training-tracker.firebaseapp.com",
            projectId: "fib-training-tracker",
            storageBucket: "fib-training-tracker.appspot.com",
            messagingSenderId: "1086248091161",
            appId: "1:1086248091161:web:6e74e452d665123e88f488",
            measurementId: "G-ZHPFZNV4WZ",
            databaseURL: "https://fib-training-tracker-default-rtdb.firebaseio.com"
          };

          // Initialize Firebase
          const app = initializeApp(firebaseConfig);
          const database = getDatabase(app);

          // Make functions available globally
          window.fbDatabase = database;
          window.fbRef = ref;
          window.fbSet = set;
          window.fbOnValue = onValue;
          window.fbUpdate = update;
          window.fbGet = fbGet;

          // Initialize training modules
          if (!window.trainingModules) {
            window.trainingModules = [];
          }

          // Load training modules
          await window.loadTrainingModules();

          return true;
        } catch (error) {
          console.error('Firebase initialization error:', error);
          showDatabaseError('Failed to initialize database. Please refresh the page.');
          return false;
        }
      }

      // Make initializeFirebase available globally
      window.initializeFirebase = initializeFirebase;
    </script>
    <style>
      :root { color-scheme: dark; }
      * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0b0f; color:#fff; }
  
    .wrap { max-width: 1400px; margin: 0 auto; padding: 24px; }

    .internal-db-btn {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }

    .internal-db-btn:hover {
      background: rgba(34, 197, 94, 0.2);
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.2);
      transform: scale(1.05);
    }

    .internal-db-btn svg {
      width: 16px;
      height: 16px;
    }

  .toolbar {
    position: sticky; top: 0; z-index: 50;
    display:flex; flex-direction: column; gap:16px; margin-bottom:24px;
    padding: 10px 0 14px 0; background: #0b0b0f;
    border-bottom: 1px solid rgba(255,255,255,.08);
    transition: all 0.3s ease;
  }
  .toolbar.collapsed {
    padding: 8px 0;
  }
  .toolbar.collapsed .brand {
    padding: 8px 0;
  }
  .toolbar.collapsed .brand img {
    height: 64px;
  }
  .toolbar.collapsed h1 {
    font-size: 32px;
  }
  .collapse-btn {
    position: absolute;
    right: 20px;
    top: 20px;
    background: rgba(0,0,0,.3);
    color: #fde047;
    border: 2px solid #fde047;
    border-radius: 8px;
    padding: 7px 12px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background .15s, color .15s, border-color .15s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .collapse-btn:hover {
    background: rgba(253,224,71,.2);
    color: #fde047;
    border-color: #fde047;
  }
  .brand { 
    display: flex; 
    align-items: center; 
    gap: 24px;
    padding: 16px 0;
  }
  .brand img { 
    height: 120px; 
    width: auto; 
    border-radius: 4px;
    filter: drop-shadow(0 0 10px rgba(253,224,71,.2));
  }
  h1 { 
    font-size: 48px; 
    font-weight: 900; 
    margin: 0; 
    letter-spacing: 1px; 
    color: #fde047; 
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace; 
    text-shadow: 0 0 10px rgba(253,224,71,.3);
    line-height: 1.2;
  }

  h1 br {
    display: block;
    content: "";
    margin-top: 4px;
  }

  /* Training Procedures Section */
  .training-procedures .training-procedures-header {
    cursor: pointer;
    user-select: none;
    color: #22c55e;
    border-bottom-color: #22c55e;
    text-shadow: 0 0 8px rgba(34, 197, 94, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin: 0 0 16px;
    font-size: 18px;
    font-weight: 700;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
    border-bottom: 2px solid #22c55e;
    padding-bottom: 8px;
  }

  .training-procedures {
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .training-procedures .toggle-icon {
    font-size: 12px;
    transition: transform 0.3s ease;
  }

  .training-procedures.expanded .toggle-icon {
    transform: rotate(180deg);
  }

  .training-module {
    background: rgba(34, 197, 94, 0.05);
    border: 1px solid rgba(34, 197, 94, 0.1);
    border-radius: 8px;
    margin-bottom: 12px;
    overflow: hidden;
  }

  .training-module-header {
    padding: 12px;
    cursor: pointer;
    user-select: none;
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .training-module-content {
    padding: 16px;
    display: none;
    position: relative;
  }

  .training-module-content.expanded {
    display: block;
  }

  .edit-module-btn {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 4px;
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 10;
    position: absolute;
    top: 12px;
    right: 12px;
  }

  .edit-module-btn:hover {
    background: rgba(34, 197, 94, 0.2);
    box-shadow: 0 0 8px rgba(34, 197, 94, 0.2);
    transform: scale(1.05);
  }

  .edit-module-btn svg {
    width: 16px;
    height: 16px;
  }

  .training-module-content {
    position: relative !important;
    padding: 16px !important;
    padding-top: 24px !important;
  }

  .training-module-content {
    position: relative;
    padding: 16px;
    padding-top: 24px;
  }

  .training-module-section {
    margin-bottom: 12px;
  }

  .training-module-section h4 {
    color: #22c55e;
    margin: 0 0 8px 0;
    font-size: 14px;
  }

  .training-module-section p {
    margin: 0;
    color: #fff;
    font-size: 13px;
    line-height: 1.5;
  }

  /* Hover Preview Styles */
  .hover-preview {
    display: none;
    position: absolute;
    top: calc(100% + 5px);
    left: 50%;
    transform: translateX(-50%);
    z-index: 100000;
    background: rgba(0, 0, 0, 0.95);
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    pointer-events: none;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  td {
    position: relative;
  }

  .trainee-row td:hover .hover-preview {
    display: block !important;
  }

  .hover-preview img {
    display: block;
    max-width: 150px;
    max-height: 150px;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  /* Training Table Styles */
  .training-section {
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .training-section h2 {
    margin: 0 0 16px;
    font-size: 18px;
    font-weight: 700;
    color: #fde047;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
    text-shadow: 0 0 8px rgba(253,224,71,.2);
    border-bottom: 2px solid #fde047;
    padding-bottom: 8px;
  }

  /* Deleted Data Section */
  .deleted-section .deleted-header {
    cursor: pointer;
    user-select: none;
    color: #ef4444;
    border-bottom-color: #ef4444;
    text-shadow: 0 0 8px rgba(239,68,68,.2);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .deleted-section .toggle-icon {
    font-size: 12px;
    transition: transform 0.3s ease;
  }

  .deleted-section.expanded .toggle-icon {
    transform: rotate(180deg);
  }

  /* Promote Button */
  .promote-btn {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.4);
    border-radius: 4px;
    width: 24px;
    height: 24px;
    padding: 0;
    line-height: 1;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .promote-btn:hover {
    background: rgba(34, 197, 94, 0.3);
    box-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
  }

  /* Delete Dialog */
  .delete-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.95);
    border: 2px solid #ef4444;
    border-radius: 8px;
    padding: 24px;
    min-width: 300px;
    z-index: 100001;
    box-shadow: 0 0 30px rgba(239, 68, 68, 0.3);
  }

  .delete-dialog-title {
    color: #ef4444;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 16px;
    text-align: center;
  }

  .delete-input {
    width: 100%;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid #ef4444;
    border-radius: 4px;
    padding: 8px 12px;
    color: #ef4444;
    font-size: 14px;
    margin-bottom: 16px;
    outline: none;
  }

  .delete-dialog-buttons {
    display: flex;
    justify-content: center;
    gap: 8px;
  }

  .delete-dialog-btn {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid #ef4444;
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .delete-dialog-btn:hover {
    background: rgba(239, 68, 68, 0.2);
  }

  .delete-dialog-btn.cancel {
    background: rgba(0, 0, 0, 0.3);
    color: #fff;
    border-color: rgba(255, 255, 255, 0.2);
  }

  .delete-dialog-btn.cancel:hover {
    background: rgba(0, 0, 0, 0.4);
  }

  .training-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 8px;
    background: transparent;
    margin-bottom: 20px;
  }

  .training-table tr {
    background: rgba(0,0,0,.3);
    border-radius: 8px;
    margin-bottom: 8px;
  }

  .training-table td:first-child {
    border-top-left-radius: 8px;
    border-bottom-left-radius: 8px;
  }

  .training-table td:last-child {
    border-top-right-radius: 8px;
    border-bottom-right-radius: 8px;
  }

  .training-table th {
    background: #fde047;
    color: #000;
    padding: 12px 8px;
    font-weight: 700;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
    text-align: left;
  }

  .training-table td {
    padding: 10px 8px;
    border-bottom: 1px solid rgba(255,255,255,.1);
    font-size: 13px;
    color: #fff;
  }

  .training-table tr:hover {
    background: rgba(253,224,71,.1);
  }

  /* Form Styles */
  .add-trainee-form {
    background: rgba(0,0,0,.3);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .form-title {
    color: #fde047;
    font-size: 16px;
    font-weight: 600;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ef4444;
    transition: background-color 0.3s ease;
  }

  .status-dot.connected {
    background: #22c55e;
  }

  .status-text {
    font-size: 12px;
    color: #9ca3af;
  }

  .form-row {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
    align-items: flex-end;
  }

  .form-group {
    flex: 1;
  }

  #addTraineeBtn {
    margin-left: 16px;
    height: 41px;
    white-space: nowrap;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    color: #fff;
    font-size: 14px;
  }

  .form-group input {
    width: 100%;
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 8px;
    padding: 8px 12px;
    color: #fff;
    font-size: 14px;
  }

  .save-btn {
    background: #fde047;
    color: #000;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .save-btn:hover {
    background: #fff;
  }

  /* Dialog Styles */
  .password-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.95);
    border: 2px solid #00ff00;
    border-radius: 8px;
    padding: 24px;
    min-width: 300px;
    z-index: 100001;
    display: none;
    box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
  }

  .password-dialog-title {
    color: #00ff00;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 16px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
  }

  .password-input {
    width: 100%;
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid #00ff00;
    border-radius: 4px;
    padding: 8px 12px;
    color: #00ff00;
    font-size: 14px;
    margin-bottom: 16px;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
    outline: none;
  }

  .password-dialog-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }

  .password-dialog-btn {
    background: rgba(0, 255, 0, 0.1);
    color: #00ff00;
    border: 1px solid #00ff00;
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
  }

  .password-dialog-btn:hover {
    background: rgba(0, 255, 0, 0.2);
  }

  .checkbox-cell {
    text-align: center;
    padding: 8px 4px !important;
  }

  .checkbox-cell input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }

  .instructor-row td {
    text-align: center;
    font-size: 11px;
    color: #fde047;
    padding: 4px !important;
    border-bottom: 2px solid rgba(255,255,255,.1) !important;
  }

  .section-header td {
    background: rgba(253,224,71,.1);
    color: #fde047;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 8px !important;
    text-align: center;
  }


  .instructor-row:hover {
    background: none !important;
  }


  /* Classified Entry Screen */
      .classified-entry {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #000000 0%, #0a0a0a 25%, #000000 50%, #0a0a0a 75%, #000000 100%);
        background-size: 400% 400%;
        animation: classifiedBg 8s ease-in-out infinite;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      /* Z-index stack:
       * Modal dialogs: 100001
       * Access overlay: 99999
       * Classified entry: 9999
       * Regular modals: 9998
       * Tooltips/dropdowns: 100
       * Toolbar: 50
       */

      .classified-entry.fading {
        pointer-events: none;
      }

  .classified-watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    height: auto;
    opacity: 0.15;
    z-index: 1;
    filter: drop-shadow(0 0 30px #00ff00);
    animation: watermarkPulse 3s ease-in-out infinite;
  }

  @keyframes watermarkPulse {
    0%, 100% { 
      opacity: 0.1;
      filter: drop-shadow(0 0 20px #00ff00);
      transform: translate(-50%, -50%) scale(1);
    }
    50% { 
      opacity: 0.2;
      filter: drop-shadow(0 0 40px #00ff00);
      transform: translate(-50%, -50%) scale(1.05);
    }
  }

  /* Password Dialog */
  .password-dialog {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.95);
    border: 2px solid #00ff00;
    border-radius: 10px;
    padding: 20px;
    z-index: 100001;
    box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
    text-align: center;
    min-width: 300px;
  }

  .password-dialog-title {
    color: #00ff00;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
  }

  .password-input {
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid #00ff00;
    color: #00ff00;
    padding: 8px 12px;
    width: 100%;
    margin-bottom: 16px;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
    outline: none;
  }

  .password-input::placeholder {
    color: rgba(0, 255, 0, 0.5);
  }

  .password-dialog-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  .password-dialog-btn {
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid #00ff00;
    color: #00ff00;
    padding: 6px 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
  }

  .password-dialog-btn:hover {
    background: rgba(0, 255, 0, 0.2);
      }

      @keyframes classifiedBg {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
      }

    .classified-content {
      text-align: center;
      max-width: 800px;
      padding: 40px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #00ff00;
      border-radius: 10px;
      box-shadow: 
        0 0 30px rgba(0, 255, 0, 0.3),
        inset 0 0 30px rgba(0, 255, 0, 0.1);
      animation: classifiedGlow 2s ease-in-out infinite alternate;
      position: relative;
      z-index: 2;
    }

      @keyframes classifiedGlow {
        0% { box-shadow: 0 0 30px rgba(0, 255, 0, 0.3), inset 0 0 30px rgba(0, 255, 0, 0.1); }
        100% { box-shadow: 0 0 50px rgba(0, 255, 0, 0.5), inset 0 0 50px rgba(0, 255, 0, 0.2); }
  }

    .classified-logo {
      font-size: 96px;
      font-weight: 900;
      color: #00ff00;
      text-shadow: 0 0 20px #00ff00;
      font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
      letter-spacing: 8px;
      margin-bottom: 30px;
      animation: logoPulse 1.5s ease-in-out infinite;
      position: relative;
      z-index: 2;
    }

    @keyframes logoPulse {
      0%, 100% { transform: scale(1); text-shadow: 0 0 20px #00ff00; }
      50% { transform: scale(1.05); text-shadow: 0 0 30px #00ff00, 0 0 40px #00ff00; }
  }

      .classified-title {
        font-size: 36px;
        font-weight: 700;
        color: #ffffff;
        letter-spacing: 3px;
        margin-bottom: 15px;
        font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
      }

      .classified-subtitle {
        font-size: 28px;
        color: #00ff00;
        letter-spacing: 2px;
        margin-bottom: 50px;
        font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
        font-weight: bold;
      }

      .access-sequence {
        text-align: left;
        font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
        font-size: 14px;
        line-height: 1.8;
      }

      .access-line {
        margin-bottom: 8px;
        opacity: 0;
        animation: fadeInLine 0.5s ease-in forwards;
      }

      .access-line:nth-child(1) { animation-delay: 0.5s; }
      .access-line:nth-child(2) { animation-delay: 1s; }
      .access-line:nth-child(3) { animation-delay: 1.5s; }
      .access-line:nth-child(4) { animation-delay: 2s; }
      .access-line:nth-child(5) { animation-delay: 3.5s; }
      .access-line:nth-child(6) { animation-delay: 4s; }
      .access-line:nth-child(7) { animation-delay: 4.5s; }

      @keyframes fadeInLine {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
      }

      .prompt {
        color: #00ff00;
        font-weight: 600;
      }

      .password-display {
        color: #ff0000;
        font-weight: 700;
        letter-spacing: 2px;
      }

      .verification-status {
        color: #00ff00;
        font-weight: 700;
      }

      .access-status {
        color: #00ff00;
        font-weight: 700;
      }

      .welcome-message {
        color: #00ff00;
        font-weight: 700;
        font-size: 16px;
      }

  .delete-btn {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.4);
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .delete-btn:hover {
    background: rgba(239, 68, 68, 0.3);
  }


  /* Progress Bar Styles */
  .progress-cell {
    padding: 8px !important;
    position: relative;
  }

  .progress-bar {
    width: 100%;
    height: 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    cursor: pointer;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%);
    transition: width 0.3s ease;
    border-radius: 10px;
  }

  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    white-space: nowrap;
  }

  .progress-details {
    display: none;
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    padding: 12px;
    min-width: 200px;
    z-index: 100;
    font-size: 12px;
    color: #fff;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .progress-cell:hover .progress-details {
    display: block;
  }

  .progress-details ul {
    margin: 0;
    padding: 0 0 0 16px;
    list-style-type: none;
  }

  .progress-details li {
    margin: 4px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .progress-details li::before {
    content: '';
    display: block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-left: -16px;
  }

  .progress-details li.completed::before {
    background: #22c55e;
  }

  .progress-details li.pending::before {
    background: #ef4444;
  }

  /* Division Icons */
  .division-icon {
    width: 24px;
    height: 24px;
    margin-right: 8px;
    opacity: 0.8;
  }

  /* Animated Header */
  @keyframes headerPulse {
    0%, 100% { text-shadow: 0 0 10px rgba(253,224,71,.3); }
    50% { text-shadow: 0 0 20px rgba(253,224,71,.5); }
  }

  h1 {
    animation: headerPulse 2s ease-in-out infinite !important;
  }

  /* Clearance Tags */
  .clearance-tag {
      display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-left: 8px;
  }

  .clearance-tag.classified {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

  .clearance-tag.restricted {
    background: rgba(234, 179, 8, 0.2);
    color: #eab308;
    border: 1px solid rgba(234, 179, 8, 0.4);
  }

  .clearance-tag.public {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.4);
  }

  /* Rotating Seal */
  .fib-seal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    height: 400px;
    opacity: 0.03;
    pointer-events: none;
    animation: rotateSeal 60s linear infinite;
  }

  @keyframes rotateSeal {
    from { transform: translate(-50%, -50%) rotate(0deg); }
    to { transform: translate(-50%, -50%) rotate(360deg); }
  }

  /* Profile Modal */
  .profile-modal {
      display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    backdrop-filter: blur(4px);
  }

  .profile-content {
      position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    background: #0b0b0f;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    padding: 24px;
    overflow-y: auto;
  }

  .profile-header {
    display: flex;
      align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .profile-name {
    flex: 1;
    font-size: 24px;
    font-weight: 700;
      color: #fde047;
  }

  .profile-close, .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid #ef4444;
    border-radius: 4px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s ease;
    z-index: 1000;
  }

  .profile-close:hover, .close-btn:hover {
    background: rgba(239, 68, 68, 0.2);
    box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
  }

  .profile-picture-section {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 16px;
  }

  .profile-picture-container {
    position: relative;
    width: 200px;
    height: 200px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid rgba(253, 224, 71, 0.2);
  }

  .profile-picture {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .profile-picture-upload {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.7);
    padding: 8px;
    text-align: center;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .profile-picture-container:hover .profile-picture-upload {
    opacity: 1;
  }

  .upload-btn {
    color: #fde047;
    font-size: 12px;
    cursor: pointer;
    transition: color 0.2s;
  }

  .picture-url-input {
    width: 100%;
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid rgba(253, 224, 71, 0.2);
    border-radius: 4px;
    padding: 6px 8px;
    color: #fff;
    font-size: 12px;
    transition: all 0.2s ease;
  }

  .picture-url-input:focus {
    border-color: rgba(253, 224, 71, 0.4);
    outline: none;
  }

  .picture-url-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }

  .name-hover-picture {
    display: none;
    position: absolute;
    z-index: 1000;
    width: 200px;
    background: rgba(0, 0, 0, 0.95);
    border: 2px solid rgba(253, 224, 71, 0.2);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none; /* Make the card ignore mouse events */
  }

  .name-hover-picture img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-bottom: 1px solid rgba(253, 224, 71, 0.2);
  }

  .hover-info {
    padding: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .hover-name {
    color: #fde047;
    font-size: 14px;
    font-weight: 600;
    flex: 1;
  }

  .profile-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
  }

  .profile-section {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 16px;
  }

  .profile-section-title {
    font-size: 14px;
    font-weight: 600;
        color: #fde047; 
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .profile-info-list {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .profile-info-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .profile-info-item:last-child {
    border-bottom: none;
  }

  .profile-info-label {
    font-size: 12px;
    color: #9ca3af;
    min-width: 120px;
  }

  .profile-info-value {
    font-size: 13px;
    color: #fff;
  }

  .profile-timeline {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .timeline-item {
    position: relative;
    padding-left: 24px;
    padding-bottom: 16px;
    border-left: 2px solid rgba(255, 255, 255, 0.1);
  }

  .timeline-item:last-child {
    border-left: none;
  }

  .timeline-item::before {
    content: '';
    position: absolute;
    left: -5px;
    top: 0;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #fde047;
  }

  .timeline-date {
    font-size: 11px;
    color: #9ca3af;
    margin-bottom: 4px;
  }

  .timeline-content {
    font-size: 13px;
    color: #fff;
  }

  .timeline-instructor {
    font-size: 12px;
        color: #fde047;
    margin-top: 4px;
  }

  .profile-certificates {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  .certificate-badge {
    background: rgba(253, 224, 71, 0.1);
    border: 1px solid rgba(253, 224, 71, 0.2);
        border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
        color: #fde047;
        display: flex;
        align-items: center;
    gap: 8px;
  }

  .certificate-badge::before {
    content: '✓';
    font-weight: bold;
  }

  .profile-strikes {
        color: #ef4444;
  }

  .profile-commendations {
    color: #22c55e;
  }

  /* Department Styles */
  .dept-select-container {
    position: relative;
    display: inline-block;
  }

  .dept-select-btn {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.4);
    border-radius: 4px;
        padding: 4px 8px;
        font-size: 11px;
        cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .dept-select-btn:hover {
    background: rgba(34, 197, 94, 0.3);
  }

  .dept-select-btn::after {
    content: '▼';
    font-size: 8px;
  }

  .dept-select-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    z-index: 100;
    background: #0b0b0f;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    padding: 4px;
    min-width: 150px;
    display: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .dept-select-container.open .dept-select-dropdown {
    display: block;
  }

  .dept-option {
        display: flex;
        align-items: center;
    gap: 8px;
    padding: 6px 8px;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.2s ease;
  }

  .dept-option:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .dept-option input[type="checkbox"] {
    width: 14px;
    height: 14px;
  }

  .dept-badges {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: center;
  }

  .dept-badge {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .dept-badge.add-dept {
    background: rgba(34, 197, 94, 0.05);
    border-style: dashed;
  }

  .dept-badge.add-dept:hover {
    background: rgba(34, 197, 94, 0.1);
  }

  .dept-select-dialog {
    background: rgba(0, 0, 0, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 12px;
    min-width: 200px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .dept-select-title {
    color: #fde047;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .dept-select-content {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .dept-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .dept-option:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .dept-option input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }

  .dept-option span {
    color: #fff;
    font-size: 13px;
  }

  /* Speciality badges */
  .dept-badge.fa { background: rgba(239, 68, 68, 0.1); color: #ef4444; border-color: rgba(239, 68, 68, 0.2); }
  .dept-badge.inv { background: rgba(234, 179, 8, 0.1); color: #eab308; border-color: rgba(234, 179, 8, 0.2); }
  .dept-badge.ana { background: rgba(147, 51, 234, 0.1); color: #9333ea; border-color: rgba(147, 51, 234, 0.2); }
  .dept-badge.sn { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border-color: rgba(59, 130, 246, 0.2); }

  /* Division Badges */
  .div-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    margin-right: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .div-badge.add-div {
    background: rgba(253, 224, 71, 0.05);
    border-style: dashed;
    border-color: rgba(253, 224, 71, 0.2);
    color: #fde047;
  }

  .div-badge.add-div:hover {
    background: rgba(253, 224, 71, 0.1);
  }
  .div-badge.sn { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.2); }
  .div-badge.cl { background: rgba(249, 115, 22, 0.1); color: #f97316; border: 1px solid rgba(249, 115, 22, 0.2); }
  .div-badge.oc { background: rgba(168, 85, 247, 0.1); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.2); }
  .div-badge.ia { background: rgba(234, 179, 8, 0.1); color: #eab308; border: 1px solid rgba(234, 179, 8, 0.2); }

  /* Tooltip Styles */
  .badge-tooltip {
    position: absolute;
    bottom: calc(100% + 5px);
    left: 50%;
    transform: translateX(-50%);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }

  .badge-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-width: 4px;
    border-style: solid;
  }

  /* Rank badge tooltip */
  .rank-badge .badge-tooltip {
    background: rgba(148, 163, 184, 0.2);
    color: #94a3b8;
    border: 1px solid rgba(148, 163, 184, 0.2);
  }
  .rank-badge .badge-tooltip::after {
    border-color: #94a3b8 transparent transparent transparent;
  }

  /* Speciality badge tooltip */
  .dept-badge .badge-tooltip {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.2);
    color: #22c55e;
  }
  .dept-badge .badge-tooltip::after {
    border-color: #22c55e transparent transparent transparent;
  }

  /* Division badge tooltip */
  .div-badge .badge-tooltip {
    background: rgba(132, 204, 22, 0.1);
    border: 1px solid rgba(132, 204, 22, 0.2);
    color: #84cc16;
  }
  .div-badge .badge-tooltip::after {
    border-color: #84cc16 transparent transparent transparent;
  }

  /* Show tooltip on hover */
  .rank-badge:hover .badge-tooltip,
  .dept-badge:hover .badge-tooltip,
  .div-badge:hover .badge-tooltip {
    opacity: 1;
  }

  /* Position relative for tooltip positioning */
  .rank-badge,
  .dept-badge,
  .div-badge {
    position: relative;
  }

  /* Rank Styles */
  .rank-badge {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    padding: 2px 4px;
    border-radius: 4px;
    font-size: 11px;
    margin-right: 8px;
  }

  .rank-badge.intern { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }
  .rank-badge.trainee { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
  .rank-badge.recruit { background: rgba(234, 179, 8, 0.2); color: #eab308; }
  .rank-badge.agent { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
  .rank-badge.special { background: rgba(168, 85, 247, 0.2); color: #a855f7; }

  .rank-select {
    position: relative;
    display: inline-block;
  }

  .rank-select-btn {
    background: rgba(253, 224, 71, 0.1);
        color: #fde047;
    border: 1px solid rgba(253, 224, 71, 0.2);
    border-radius: 4px;
        padding: 4px 8px;
        font-size: 11px;
        cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .rank-select-btn:hover {
    background: rgba(253, 224, 71, 0.2);
  }

  .rank-select-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 100;
    background: #0b0b0f;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    padding: 4px;
    min-width: 150px;
    display: none;
  }

  .rank-select.open .rank-select-dropdown {
    display: block;
  }

  .rank-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.2s ease;
  }

  .rank-option:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .rank-option.selected {
    background: rgba(253, 224, 71, 0.1);
  }

  /* Agent Info Styles */
  .agent-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .callsign {
      color: #fde047;
    font-family: 'Courier New', monospace;
    font-weight: bold;
  }

  .codename {
    color: #22c55e;
    font-style: italic;
  }

  .uc-name {
    color: #ef4444;
    text-decoration: underline;
  }

  /* Handler Styles */
  .handler-cell {
    position: relative;
  }

  .handler-text {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .handler-text:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .handler-text::after {
    content: '✎';
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .handler-text:hover::after {
    opacity: 0.6;
  }

  .handler-edit {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    padding: 4px;
    border-radius: 4px;
    z-index: 10;
  }

  .handler-edit.active {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .handler-edit input {
    flex: 1;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    padding: 4px 8px;
    color: #fff;
    font-size: 13px;
  }

  .handler-edit button {
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s ease;
    padding: 4px;
  }

  .handler-edit button:hover {
    opacity: 1;
  }



  #mainContent {
    display: none;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
    </style>
        <style>
        #authScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #ff0000;
            font-family: 'Courier New', monospace;
        }
        
        #authScreen.hidden {
            display: none;
        }
        
        .auth-container {
            background-color: rgba(30, 30, 30, 0.9);
            padding: 2rem;
            border: 2px solid #ff0000;
            box-shadow: 0 0 20px #ff0000;
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 20px #ff0000; }
            50% { box-shadow: 0 0 40px #ff0000; }
            100% { box-shadow: 0 0 20px #ff0000; }
        }
        
        .auth-title {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            color: #ff0000;
            text-shadow: 0 0 10px #ff0000;
        }
        
        .password-input {
            background-color: #1a1a1a;
            border: 1px solid #ff0000;
            color: #ff0000;
            padding: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            text-align: center;
            outline: none;
            margin-bottom: 1rem;
        }
        
        .password-input:focus {
            box-shadow: 0 0 10px #ff0000;
        }
        
        .access-denied {
            color: #ff0000;
            font-size: 1.2rem;
            margin-top: 1rem;
            display: none;
        }
        
        .matrix-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.1;
        }
    </style>
</head>
    <body onload="showAuthScreen()">
    <div id="authScreen">
        <canvas id="matrixCanvas" class="matrix-bg"></canvas>
        <div class="auth-container">
            <h1 class="auth-title">CLASSIFIED DATA</h1>
            <input type="password" id="passwordInput" class="password-input" placeholder="ENTER ACCESS CODE" onkeypress="checkEnter(event)">
            <div id="accessDenied" class="access-denied">ACCESS DENIED - INVALID CODE</div>
        </div>
    </div>

    <script>
        // Matrix rain effect
        const canvas = document.getElementById('matrixCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()';
        const fontSize = 14;
        const columns = canvas.width / fontSize;
        const drops = [];
        
        for (let i = 0; i < columns; i++) {
            drops[i] = 1;
        }
        
        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#ff0000';
            ctx.font = fontSize + 'px monospace';
            
            for (let i = 0; i < drops.length; i++) {
                const text = characters.charAt(Math.floor(Math.random() * characters.length));
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }
        
        // Password checking
        function showAuthScreen() {
            setInterval(drawMatrix, 33);
        }
        
        function checkEnter(e) {
            if (e.key === 'Enter') {
                const password = document.getElementById('passwordInput').value;
                if (password === 'FIB42069') {
                    document.getElementById('authScreen').classList.add('hidden');
                } else {
                    const accessDenied = document.getElementById('accessDenied');
                    accessDenied.style.display = 'block';
                    setTimeout(() => {
                        accessDenied.style.display = 'none';
                    }, 2000);
                    document.getElementById('passwordInput').value = '';
                }
            }
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
  <img src="https://kappa.lol/3qib3z" alt="FIB Seal" class="fib-seal">
  

    <!-- CLASSIFIED ENTRY SCREEN -->
    <div id="classifiedEntry" class="classified-entry">
    <img src="https://kappa.lol/3qib3z" alt="FIB Logo" class="classified-watermark">
      <div class="classified-content">
          <div class="classified-logo">FIB</div>
          <div class="classified-title">FEDERAL INVESTIGATION BUREAU</div>
      <div class="classified-subtitle">EMPLOYEE DATABASE</div>
          
          <div class="access-sequence">
            <div class="access-line">
              <span class="prompt">> INITIALIZING SYSTEM...</span>
            </div>
            <div class="access-line">
              <span class="prompt">> ACCESSING SECURE SERVER...</span>
            </div>
            <div class="access-line">
              <span class="prompt">> ENCRYPTION: AES-256</span>
            </div>
            <div class="access-line">
              <span class="prompt">> AUTHENTICATING USER...</span>
            </div>
            <div class="access-line">
              <span class="prompt">> ACCESS GRANTED</span>
            </div>
            <div class="access-line">
              <span class="prompt">> LOADING DATABASE...</span>
            </div>
            <div class="access-line">
              <span class="prompt">> WELCOME TO FIB TRAINING SYSTEM</span>
            </div>
          </div>
        </div>
      </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="profile-modal">
    <div class="profile-content">
      <div class="profile-header">
        <div class="profile-name" id="profileName"></div>
        <button class="profile-close" onclick="closeProfile()">&times;</button>
          </div>
      <div class="profile-grid">
        <div class="profile-section">
          <div class="profile-section-title">Basic Information</div>
          <ul class="profile-info-list">
            <li class="profile-info-item">
              <span class="profile-info-label">Name:</span>
              <span class="profile-info-value" id="profileName2" style="cursor: pointer" onclick="editField(this, 'name')"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Rank:</span>
              <span class="profile-info-value" id="profileRank"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Callsign:</span>
              <span class="profile-info-value" id="profileCallsign" style="cursor: pointer" onclick="editField(this, 'callsign')"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Code Name:</span>
              <span class="profile-info-value" id="profileCodename" style="cursor: pointer" onclick="editField(this, 'codename')"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Undercover Alias:</span>
              <span class="profile-info-value" id="profileUC" style="cursor: pointer" onclick="editField(this, 'ucAlias')"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Date Joined:</span>
              <span class="profile-info-value" id="profileJoinDate"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Speciality:</span>
              <span class="profile-info-value" id="profileSpeciality"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Division:</span>
              <span class="profile-info-value" id="profileDivision"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">FIB Handler:</span>
              <span class="profile-info-value" id="profileHandler" style="cursor: pointer" onclick="editField(this, 'handler')"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Training Status:</span>
              <span class="profile-info-value" id="profileStatus"></span>
            </li>
          </ul>
          </div>
        <div class="profile-section">
          <div class="profile-section-title">Certificates</div>
          <div class="profile-certificates" id="profileCertificates"></div>
        </div>
        <div class="profile-section">
          <div class="profile-section-title">Profile Picture</div>
          <div class="profile-picture-section">
            <div class="profile-picture-container" id="profilePicture">
              <img src="https://kappa.lol/3qib3z" alt="Default Profile" class="profile-picture">
              <div class="profile-picture-upload">
                <input type="text" id="pictureUrl" placeholder="Paste image URL here..." class="picture-url-input" onkeydown="if(event.key === 'Enter') handleProfileImageUpload(currentTrainee)">
              </div>
            </div>
          </div>
        </div>
        <div class="profile-section">
          <div class="profile-section-title">Record</div>
          <ul class="profile-info-list">
            <li class="profile-info-item">
              <span class="profile-info-label">Strikes:</span>
              <span class="profile-info-value profile-strikes" id="profileStrikes">None</span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Commendations:</span>
              <span class="profile-info-value profile-commendations" id="profileCommendations">None</span>
            </li>
          </ul>
        </div>
        <div class="profile-section">
          <div class="profile-section-title">Notes</div>
          <div class="profile-notes">
            <textarea id="profileNotes" placeholder="Enter notes about this trainee..." rows="4" style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; padding: 8px; color: #fff; resize: vertical;" onchange="updateNotes(event, currentTrainee)"></textarea>
          </div>
        </div>
      </div>
      <div class="profile-section">
        <div class="profile-section-title">Training Timeline</div>
        <ul class="profile-timeline" id="profileTimeline"></ul>
      </div>
        </div>
        </div>
        
        
  <div class="wrap" id="mainContent">
    <div id="top" class="toolbar">
      <button id="collapseBtn" class="collapse-btn" type="button">
        <span class="collapse-text">Collapse</span>
      </button>
      <div class="brand">
        <img src="https://kappa.lol/aDnGzF" alt="FIB Logo" />
        <h1>FEDERAL INVESTIGATION BUREAU<br>EMPLOYEE DATABASE</h1>
      </div>
      <a href="https://fibdatabase.cloud/" target="_blank" rel="noopener noreferrer" class="internal-db-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
          <polyline points="15 3 21 3 21 9"></polyline>
          <line x1="10" y1="14" x2="21" y2="3"></line>
        </svg>
        Internal Database
      </a>
  </div>

    <div class="add-trainee-form">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div class="form-title">Add New Trainee</div>
        <div id="connectionStatus" style="display: flex; align-items: center; gap: 8px;">
          <span class="status-dot"></span>
          <span class="status-text">Connecting...</span>
    </div>
  </div>
      <div class="form-row" style="align-items: flex-end;">
        <div class="form-group">
          <label for="traineeName">Trainee Name</label>
          <input type="text" id="traineeName" placeholder="Enter trainee name">
        </div>
        <div class="form-group">
          <label for="traineeHandler">FIB Handler</label>
          <input type="text" id="traineeHandler" placeholder="Enter FIB handler">
        </div>
        <button type="button" class="save-btn" id="addTraineeBtn" style="margin-left: 16px; height: 41px;">Add Trainee</button>
      </div>
          </div>

    <!-- Training Procedures Section -->
    <div class="training-section training-procedures">
      <h2 class="training-procedures-header" onclick="toggleTrainingProcedures()">
        TRAINING PROCEDURES
        <span class="toggle-icon">▼</span>
      </h2>
      <div id="trainingProceduresContainer" style="display: none;">
        <!-- Training modules will be populated here -->
      </div>
    </div>

    <div class="training-section">
      <h2>Training Progress</h2>
      <div class="table-container">
        <table class="training-table" id="trainingTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Rank</th>
              <th>Name</th>
              <th>Speciality</th>
              <th>Division</th>
              <th>Code Name</th>
              <th>Alias</th>
              <th>FIB Handler</th>
              <th>Training Progress</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="trainingTableBody">
          </tbody>
        </table>
          </div>
          </div>

          <!-- FIB ROSTER Section -->
          <div class="training-section">
            <h2>FIB ROSTER</h2>
            <div class="table-container">
              <table class="training-table" id="rosterTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Rank</th>
                    <th>Name</th>
                    <th>Speciality</th>
                    <th>Division</th>
                    <th>Code Name</th>
                    <th>Alias</th>
                    <th>FIB Handler</th>
                    <th>Training Progress</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="rosterTableBody">
                </tbody>
              </table>
            </div>
          </div>

          <!-- DELETED DATA Section -->
          <div class="training-section deleted-section">
            <h2 class="deleted-header" onclick="toggleDeletedSection()">
              DELETED DATA
              <span class="toggle-icon">▼</span>
            </h2>
            <div class="table-container" id="deletedContainer" style="display: none;">
              <table class="training-table" id="deletedTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Rank</th>
                    <th>Name</th>
                    <th>Speciality</th>
                    <th>Division</th>
                    <th>Code Name</th>
                    <th>Alias</th>
                    <th>FIB Handler</th>
                    <th>Training Progress</th>
                    <th>Deleted By</th>
                    <th>Deleted On</th>
                  </tr>
                </thead>
                <tbody id="deletedTableBody">
          </tbody>
        </table>
          </div>
          </div>

          </div>

    <script>

    // Handle toolbar collapse/expand

    // Close dropdowns and edit fields when clicking outside
    document.addEventListener('click', (e) => {
      // Close all dropdowns if clicking outside
      if (!e.target.closest('.dept-select-container') || e.target.closest('.dept-badge') || e.target.closest('.div-badge')) {
        document.querySelectorAll('.dept-select-dropdown').forEach(dropdown => {
          dropdown.style.display = 'none';
        });
      }
      if (!e.target.closest('.rank-select')) {
        document.querySelectorAll('.rank-select').forEach(select => {
          select.classList.remove('open');
        });
      }
      if (!e.target.closest('.handler-edit') && !e.target.closest('.handler-text')) {
        document.querySelectorAll('.handler-edit').forEach(edit => {
          edit.classList.remove('active');
        });
      }
    });

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', async () => {
      try {
      // Get elements
      const mainContent = document.getElementById('mainContent');
      const classifiedEntry = document.getElementById('classifiedEntry');
        const toolbar = document.getElementById('top');
        const collapseBtn = document.getElementById('collapseBtn');
        const collapseText = collapseBtn.querySelector('.collapse-text');
        const addTraineeBtn = document.getElementById('addTraineeBtn');

      // Initial state
      mainContent.style.display = 'none';
      mainContent.style.opacity = '0';
      classifiedEntry.style.display = 'flex';
      classifiedEntry.style.opacity = '1';

        // Hide classified entry screen after animation
      setTimeout(() => {
        classifiedEntry.style.transition = 'opacity 1.5s ease-out';
        classifiedEntry.style.opacity = '0';
          classifiedEntry.style.pointerEvents = 'none';
        setTimeout(() => {
          classifiedEntry.style.display = 'none';
            
            // Show main content and initialize
          mainContent.style.display = 'block';
          requestAnimationFrame(() => {
            mainContent.style.opacity = '1';
          });

            // Initialize Firebase
            initializeFirebase().then(initialized => {
              if (initialized) {
                // Set up connection monitoring
                const connectedRef = fbRef(fbDatabase, '.info/connected');
                fbOnValue(connectedRef, (snap) => {
                  try {
                    const connected = snap.val() === true;
                    console.log('Connection state:', connected ? 'connected' : 'disconnected');
                    
                    if (connected) {
                      enableInterface();
                      loadTrainees(); // Load data when connected
                    } else {
                      showDatabaseError('Lost connection to database. Please check your internet connection.');
                    }
                  } catch (error) {
                    console.error('Error in connection handler:', error);
                    showDatabaseError('Error handling connection state. Please refresh the page.');
                  }
                }, (error) => {
                  console.error('Connection monitoring error:', error);
                  showDatabaseError('Unable to monitor database connection. Please refresh the page.');
                });
              }
            });
        }, 1500);
      }, 4000);

      // Initialize toolbar
      collapseBtn.addEventListener('click', () => {
        toolbar.classList.toggle('collapsed');
        collapseText.textContent = toolbar.classList.contains('collapsed') ? 'Expand' : 'Collapse';
      });

      // Set up add trainee button
      if (addTraineeBtn) {
        addTraineeBtn.addEventListener('click', addNewTrainee);
      } else {
        console.error('Add trainee button not found!');
      }

        } catch (error) {
        console.error('Error in initialization:', error);
        showDatabaseError('Error during initialization. Please refresh the page.');
        }
    });

    // Training data management
    let trainees = [];
    let roster = [];
    let deletedTrainees = [];
    let currentAgentId = null; // Track current agent ID globally

    // Available departments and divisions
    const departments = [
      { id: 'fa', name: 'Field Agent', abbr: 'FA' },
      { id: 'inv', name: 'Investigator', abbr: 'INV' },
      { id: 'ana', name: 'Analyst', abbr: 'ANA' },
      { id: 'sn', name: 'Supernatural', abbr: 'SN' }
    ];

    const divisions = [
      { id: 'oc', name: 'Organized Crime', abbr: 'OC' },
      { id: 'cl', name: 'Criminal Law', abbr: 'CL' },
      { id: 'sn', name: 'Supernatural', abbr: 'SN' },
      { id: 'ia', name: 'Internal Affairs', abbr: 'IA' }
    ];

    async function loadTrainees() {
      try {
        if (!window.fbRef || !window.fbDatabase) {
          showDatabaseError('Database not initialized. Please refresh the page.');
          return;
        }

        console.log('Loading data from database...');
        
        // Set up real-time listeners
        fbOnValue(fbRef(fbDatabase, 'trainees'), (snapshot) => {
          try {
            console.log('Received trainees update');
          const raw = snapshot.val() || {};
            trainees = Object.entries(raw).map(([id, data]) => {
              // Ensure trainee has required fields
              const trainee = {
                id,
                name: data.name || '',
                handler: data.handler || '',
                rank: data.rank || 'intern',
                callsign: data.callsign || '',
                codename: data.codename || '',
                alias: data.alias || '',
                ucAlias: data.ucAlias || '',
                departments: data.departments || [],
                divisions: data.divisions || [],
                skills: data.skills || {},
                strikes: data.strikes || [],
                commendations: data.commendations || [],
                timeline: data.timeline || [],
                ...data
              };
              return ensureTraineeSkills(trainee);
            });
            console.log('Processed trainees:', trainees);
            updateTrainingTable();
          } catch (error) {
            console.error('Error processing trainees update:', error);
          }
        }, (error) => {
          console.error('Trainees listener error:', error);
          showDatabaseError('Error reading trainees. Please refresh the page.');
        });

        fbOnValue(fbRef(fbDatabase, 'roster'), (snapshot) => {
          try {
            console.log('Received roster update');
            const raw = snapshot.val() || {};
            roster = Object.entries(raw).map(([id, data]) => {
              // Ensure roster entry has required fields
              const trainee = {
                id,
                name: data.name || '',
                handler: data.handler || '',
                rank: data.rank || 'intern',
                callsign: data.callsign || '',
                codename: data.codename || '',
                alias: data.alias || '',
                ucAlias: data.ucAlias || '',
                departments: data.departments || [],
                divisions: data.divisions || [],
                skills: data.skills || {},
                strikes: data.strikes || [],
                commendations: data.commendations || [],
                timeline: data.timeline || [],
                promotedOn: data.promotedOn || null,
                profilePicture: data.profilePicture || '',
                ...data
              };
              return ensureTraineeSkills(trainee);
            });
            console.log('Processed roster:', roster);
            updateRosterTable();
          } catch (error) {
            console.error('Error processing roster update:', error);
          }
        }, (error) => {
          console.error('Roster listener error:', error);
          showDatabaseError('Error reading roster. Please refresh the page.');
        });

        fbOnValue(fbRef(fbDatabase, 'deleted'), (snapshot) => {
          try {
            console.log('Received deleted update');
            const raw = snapshot.val() || {};
            deletedTrainees = Object.entries(raw).map(([id, data]) => {
              // Ensure deleted entry has required fields
              const trainee = {
                id,
                name: data.name || '',
                handler: data.handler || '',
                rank: data.rank || 'intern',
                callsign: data.callsign || '',
                codename: data.codename || '',
                alias: data.alias || '',
                ucAlias: data.ucAlias || '',
                departments: data.departments || [],
                divisions: data.divisions || [],
                skills: data.skills || {},
                strikes: data.strikes || [],
                commendations: data.commendations || [],
                timeline: data.timeline || [],
                deletedBy: data.deletedBy || '',
                deletedOn: data.deletedOn || new Date().toISOString(),
                ...data
              };
              return ensureTraineeSkills(trainee);
            });
            console.log('Processed deleted:', deletedTrainees);
            updateDeletedTable();
          } catch (error) {
            console.error('Error processing deleted update:', error);
          }
        }, (error) => {
          console.error('Deleted listener error:', error);
          showDatabaseError('Error reading deleted data. Please refresh the page.');
        });

      } catch (error) {
        console.error('Error in loadTrainees:', error);
        showDatabaseError('Failed to load trainees. Please refresh the page.');
      }
    }

    function showDatabaseError(message) {
      // Create error notice
      const notice = document.createElement('div');
      notice.style.background = 'rgba(239, 68, 68, 0.1)';
      notice.style.border = '1px solid #ef4444';
      notice.style.borderRadius = '8px';
      notice.style.padding = '12px';
      notice.style.marginBottom = '16px';
      notice.style.color = '#ef4444';
      notice.style.fontSize = '14px';
      notice.innerHTML = `<strong>⚠️ Database Error:</strong> ${message}`;
      
      // Clear the table and show error message
      const tbody = document.getElementById('trainingTableBody');
      if (tbody) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 20px; color: #ef4444;">
              Database connection required to view trainees
            </td>
          </tr>
        `;
      }

      // Show error notice above the form
      const addTraineeForm = document.querySelector('.add-trainee-form');
      if (addTraineeForm) {
        // Remove any existing notices
        const existingNotice = addTraineeForm.previousElementSibling;
        if (existingNotice && existingNotice.style.background.includes('rgba')) {
          existingNotice.remove();
        }
        addTraineeForm.parentNode.insertBefore(notice, addTraineeForm);
      }

      // Disable form inputs
      disableInterface();
      
      // Update connection status
      const statusDot = document.querySelector('.status-dot');
      const statusText = document.querySelector('.status-text');
      if (statusDot) statusDot.classList.remove('connected');
      if (statusText) {
        statusText.textContent = 'Disconnected';
        statusText.style.color = '#ef4444';
      }
    }

    function enableInterface() {
      // Enable all inputs except collapse button
      const inputs = document.querySelectorAll('input, button, select');
      inputs.forEach(input => {
        if (input.id !== 'collapseBtn') {
          input.disabled = false;
        }
      });

      // Update connection status
      const statusDot = document.querySelector('.status-dot');
      const statusText = document.querySelector('.status-text');
      if (statusDot) statusDot.classList.add('connected');
      if (statusText) {
        statusText.textContent = 'Connected';
        statusText.style.color = '#22c55e';
      }

      // Remove any error messages
      const addTraineeForm = document.querySelector('.add-trainee-form');
      if (addTraineeForm) {
        const existingNotice = addTraineeForm.previousElementSibling;
        if (existingNotice && existingNotice.style.background.includes('rgba')) {
          existingNotice.remove();
        }
      }
    }

    function disableInterface() {
      // Disable all inputs except collapse button
      const inputs = document.querySelectorAll('input, button, select');
      inputs.forEach(input => {
        if (input.id !== 'collapseBtn') {
          input.disabled = true;
        }
      });
    }

      // Function to handle profile image upload
      async function handleProfileImageUpload(trainee) {
        // Use the input field's value instead of prompt
        const imageUrl = document.getElementById('pictureUrl').value.trim();
        if (!imageUrl) return;

        try {
          // Get the current trainee from the window object
          trainee = window.currentTrainee;
          if (!trainee) {
            console.error('No trainee selected');
            return;
          }

          // Determine which collection the trainee belongs to
          let collection = 'trainees';
          if (roster.find(t => t.id === trainee.id)) {
            collection = 'roster';
          } else if (deletedTrainees.find(t => t.id === trainee.id)) {
            collection = 'deleted';
          }

          console.log('Saving profile picture for trainee:', trainee.id, 'in collection:', collection);

          // Update the profile picture in the database
          const updates = {};
          updates[`/${collection}/${trainee.id}/profilePicture`] = imageUrl;

          // Add to timeline
          const timelineUpdate = {
            date: new Date().toISOString(),
            content: 'Profile picture updated',
            instructor: 'System'
          };

          // Get current timeline
          const snapshot = await fbGet(fbRef(fbDatabase, `/${collection}/${trainee.id}/timeline`));
          const currentTimeline = snapshot.exists() ? snapshot.val() : [];
          
          // Update timeline in database
          updates[`/${collection}/${trainee.id}/timeline`] = [...currentTimeline, timelineUpdate];

          // Save to Firebase
          await fbUpdate(fbRef(fbDatabase), updates);

          // Update local data
          if (collection === 'trainees') {
            const index = trainees.findIndex(t => t.id === trainee.id);
            if (index !== -1) {
              trainees[index].profilePicture = imageUrl;
              trainees[index].timeline = [...currentTimeline, timelineUpdate];
            }
          } else if (collection === 'roster') {
            const index = roster.findIndex(t => t.id === trainee.id);
            if (index !== -1) {
              roster[index].profilePicture = imageUrl;
              roster[index].timeline = [...currentTimeline, timelineUpdate];
            }
          } else {
            const index = deletedTrainees.findIndex(t => t.id === trainee.id);
            if (index !== -1) {
              deletedTrainees[index].profilePicture = imageUrl;
              deletedTrainees[index].timeline = [...currentTimeline, timelineUpdate];
            }
          }

          // Update all tables to ensure the change is reflected everywhere
          updateTrainingTable();
          updateRosterTable();
          updateDeletedTable();

          // Refresh the profile view
          showProfile({...trainee, profilePicture: imageUrl});

          console.log('Successfully updated profile picture for trainee:', trainee.id);
        } catch (error) {
          console.error('Error saving profile image:', error);
          alert('Failed to save profile image. Please try again.');
        }
      }

      // Function to ensure trainee has all required skills
      function ensureTraineeSkills(trainee) {
      const requiredSkills = {
        '10Codes': { completed: false, instructor: '', completedDate: null },
        'CaseLaws': { completed: false, instructor: '', completedDate: null },
        'Pursuit': { completed: false, instructor: '', completedDate: null },
        'Hostage': { completed: false, instructor: '', completedDate: null },
        'TrafficStop': { completed: false, instructor: '', completedDate: null },
        'CloseQuartersBreaching': { completed: false, instructor: '', completedDate: null },
        'OpenAreaBreaching': { completed: false, instructor: '', completedDate: null },
        'SceneControl': { completed: false, instructor: '', completedDate: null },
        'COMMS': { completed: false, instructor: '', completedDate: null },
        'UseOfForce': { completed: false, instructor: '', completedDate: null },
        'FilingCharges': { completed: false, instructor: '', completedDate: null },
        'Reports': { completed: false, instructor: '', completedDate: null },
        'Gunfight': { completed: false, instructor: '', completedDate: null },
        'UndercoverTraining': { completed: false, instructor: '', completedDate: null },
        'HelicopterLicense': { completed: false, instructor: '', completedDate: null },
        'AmmunationSceneCommand': { completed: false, instructor: '', completedDate: null },
        'BankHeistSceneCommand': { completed: false, instructor: '', completedDate: null },
        'PITManeuverTraining': { completed: false, instructor: '', completedDate: null },
        'Interrogation': { completed: false, instructor: '', completedDate: null },
        'ShortTermInvestigations': { completed: false, instructor: '', completedDate: null },
        'LongTermInvestigations': { completed: false, instructor: '', completedDate: null },
        'Surveillance': { completed: false, instructor: '', completedDate: null },
        'DeepUCWork': { completed: false, instructor: '', completedDate: null },
        'CaseManagement': { completed: false, instructor: '', completedDate: null },
        'StatementGaining': { completed: false, instructor: '', completedDate: null },
        'EvidenceHandling': { completed: false, instructor: '', completedDate: null },
        'WarrantWriting': { completed: false, instructor: '', completedDate: null }
      };

      if (!trainee.skills) {
        trainee.skills = {};
      }

      // Add any missing skills while preserving existing ones
      Object.entries(requiredSkills).forEach(([skill, defaultValue]) => {
        if (!trainee.skills[skill]) {
          trainee.skills[skill] = defaultValue;
        }
      });

      return trainee;
    }

    async function saveTrainees() {
      try {
        if (!window.fbRef || !window.fbDatabase) {
          throw new Error('Database not initialized');
        }

        console.log('Saving to database...');
        
        // Create updates object for all collections
        const updates = {};
        
        // Process trainees
        trainees.forEach(trainee => {
          // Generate a unique ID if one doesn't exist
          const traineeId = trainee.id || `trainee_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          trainee.id = traineeId;
          
          // Ensure trainee has all required skills
          trainee = ensureTraineeSkills(trainee);
          
          updates[`/trainees/${traineeId}`] = {
            id: traineeId,
            name: trainee.name || '',
            handler: trainee.handler || '',
            rank: trainee.rank || 'intern',
            callsign: trainee.callsign || '',
            codename: trainee.codename || '',
            alias: trainee.alias || '',
            ucAlias: trainee.ucAlias || '',
            departments: trainee.departments || [],
            divisions: trainee.divisions || [],
            skills: trainee.skills,
            strikes: trainee.strikes || [],
            commendations: trainee.commendations || [],
            timeline: trainee.timeline || [],
            profilePicture: trainee.profilePicture || ''
          };
        });

        // Process roster
        roster.forEach(entry => {
          const entryId = entry.id;
          // Ensure arrays exist
          if (!entry.departments) entry.departments = [];
          if (!entry.divisions) entry.divisions = [];
          
          // Ensure entry has all required skills
          entry = ensureTraineeSkills(entry);
          
          updates[`/roster/${entryId}`] = {
            id: entryId,
            name: entry.name || '',
            handler: entry.handler || '',
            rank: entry.rank || 'intern',
            callsign: entry.callsign || '',
            codename: entry.codename || '',
            alias: entry.alias || '',
            ucAlias: entry.ucAlias || '',
            departments: entry.departments,
            divisions: entry.divisions,
            skills: entry.skills,
            strikes: entry.strikes || [],
            commendations: entry.commendations || [],
            timeline: entry.timeline || [],
            promotedOn: entry.promotedOn || new Date().toISOString(),
            profilePicture: entry.profilePicture || ''
          };
        });

        // Process deleted
        deletedTrainees.forEach(entry => {
          const entryId = entry.id;
          // Ensure entry has all required skills
          entry = ensureTraineeSkills(entry);
          
          updates[`/deleted/${entryId}`] = {
            id: entryId,
            name: entry.name || '',
            handler: entry.handler || '',
            rank: entry.rank || 'intern',
            callsign: entry.callsign || '',
            codename: entry.codename || '',
            alias: entry.alias || '',
            ucAlias: entry.ucAlias || '',
            departments: entry.departments || [],
            divisions: entry.divisions || [],
            skills: entry.skills,
            strikes: entry.strikes || [],
            commendations: entry.commendations || [],
            timeline: entry.timeline || [],
            profilePicture: entry.profilePicture || '',
            deletedBy: entry.deletedBy || '',
            deletedOn: entry.deletedOn || new Date().toISOString()
          };
        });

        // Save all updates in one transaction
        await fbUpdate(fbRef(fbDatabase), updates);
        console.log('Successfully saved all data to database');
        return true;
      } catch (error) {
        console.error('Error saving to database:', error);
        showDatabaseError('Failed to save changes. Please try again.');
        return false;
      }
    }

    async function addNewTrainee() {
      try {
        const nameInput = document.getElementById('traineeName');
        const handlerInput = document.getElementById('traineeHandler');
        
        const name = nameInput.value.trim();
        const handler = handlerInput.value.trim();
        
        if (!name || !handler) {
          alert('Please enter both trainee name and FIB handler');
          return;
        }

        // Create new trainee with proper structure
        const traineeId = `trainee_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const newTrainee = {
          name: name,
          handler: handler,
          rank: 'intern',
          callsign: '',
          codename: '',
          ucAlias: '',
          departments: [],
          divisions: [],
          joinDate: new Date().toISOString(),
          skills: {
            '10Codes': { completed: false, instructor: '', completedDate: null },
            'CaseLaws': { completed: false, instructor: '', completedDate: null },
            'Pursuit': { completed: false, instructor: '', completedDate: null },
            'Hostage': { completed: false, instructor: '', completedDate: null },
            'TrafficStop': { completed: false, instructor: '', completedDate: null },
            'CloseQuartersBreaching': { completed: false, instructor: '', completedDate: null },
            'OpenAreaBreaching': { completed: false, instructor: '', completedDate: null },
            'SceneControl': { completed: false, instructor: '', completedDate: null },
            'COMMS': { completed: false, instructor: '', completedDate: null },
            'UseOfForce': { completed: false, instructor: '', completedDate: null },
            'FilingCharges': { completed: false, instructor: '', completedDate: null },
            'Reports': { completed: false, instructor: '', completedDate: null },
            'Gunfight': { completed: false, instructor: '', completedDate: null },
            'UndercoverTraining': { completed: false, instructor: '', completedDate: null },
            'HelicopterLicense': { completed: false, instructor: '', completedDate: null },
            'AmmunationSceneCommand': { completed: false, instructor: '', completedDate: null },
            'BankHeistSceneCommand': { completed: false, instructor: '', completedDate: null },
            'PITManeuverTraining': { completed: false, instructor: '', completedDate: null },
            'Interrogation': { completed: false, instructor: '', completedDate: null },
            'ShortTermInvestigations': { completed: false, instructor: '', completedDate: null },
            'LongTermInvestigations': { completed: false, instructor: '', completedDate: null },
            'Surveillance': { completed: false, instructor: '', completedDate: null },
            'DeepUCWork': { completed: false, instructor: '', completedDate: null },
            'CaseManagement': { completed: false, instructor: '', completedDate: null },
            'StatementGaining': { completed: false, instructor: '', completedDate: null },
            'EvidenceHandling': { completed: false, instructor: '', completedDate: null },
            'WarrantWriting': { completed: false, instructor: '', completedDate: null }
          },
          strikes: [],
          commendations: [],
          timeline: [{
            date: new Date().toISOString(),
            content: 'Added to training program',
            instructor: handler
          }]
        };

        // Write to specific path in database
        const updates = {};
        updates[`/trainees/${traineeId}`] = newTrainee;
        
        await fbUpdate(fbRef(fbDatabase), updates);
        console.log('Successfully added trainee:', traineeId);

        // Clear inputs
        nameInput.value = '';
        handlerInput.value = '';
      } catch (error) {
        console.error('Error adding trainee:', error);
        showDatabaseError('Failed to add trainee. Please try again.');
      }
    }

    function toggleDeletedSection() {
      const section = document.querySelector('.deleted-section');
      const container = document.getElementById('deletedContainer');
      const icon = document.querySelector('.toggle-icon');
      
      section.classList.toggle('expanded');
      container.style.display = container.style.display === 'none' ? 'block' : 'none';
      icon.style.transform = container.style.display === 'none' ? 'rotate(0deg)' : 'rotate(180deg)';
    }

    function updateRosterTable() {
      const tbody = document.getElementById('rosterTableBody');
      tbody.innerHTML = '';
      
      roster.forEach(trainee => {
        try {
          const row = document.createElement('tr');
          row.className = 'trainee-row';
          row.onclick = () => showProfile(trainee);
          
          // # (Callsign) cell
          const callsignCell = createEditableCell(trainee, 'callsign', 'callsign');
          row.appendChild(callsignCell);

          // Rank cell
          const rankCell = document.createElement('td');
          const rankSelect = document.createElement('div');
          rankSelect.className = 'rank-select';
          
          const rankBtn = document.createElement('button');
          rankBtn.className = 'rank-select-btn';
          const currentRank = RANKS.find(r => r.id === trainee.rank) || RANKS[0];
          rankBtn.innerHTML = `<span class="rank-badge ${currentRank.id}"><span class="badge-tooltip">${currentRank.name}</span>${currentRank.abbr}</span>`;
          rankBtn.onclick = (e) => {
            e.stopPropagation();
            rankSelect.classList.toggle('open');
          };
          rankSelect.appendChild(rankBtn);

          const rankDropdown = document.createElement('div');
          rankDropdown.className = 'rank-select-dropdown';
          RANKS.forEach(rank => {
            const option = document.createElement('div');
            option.className = `rank-option${rank.id === trainee.rank ? ' selected' : ''}`;
            option.innerHTML = `<span class="rank-badge ${rank.id}">${rank.abbr}</span> ${rank.name}`;
            option.onclick = (e) => {
              e.stopPropagation();
              trainee.rank = rank.id;
              trainee.timeline.push({
                date: new Date().toISOString(),
                content: `Rank updated to ${rank.name}`,
                instructor: 'System'
              });
              saveTrainees();
              updateRosterTable();
              rankSelect.classList.remove('open');
            };
            rankDropdown.appendChild(option);
          });
          rankSelect.appendChild(rankDropdown);
          rankCell.appendChild(rankSelect);
          row.appendChild(rankCell);

          // Name cell with hover effect
          const nameCell = document.createElement('td');
          nameCell.textContent = trainee.name || '-';
          nameCell.style.position = 'relative';
          
          // Add hover effect for profile picture
          if (trainee.profilePicture) {
            const hoverPreview = document.createElement('div');
            hoverPreview.className = 'hover-preview';
            hoverPreview.style.display = 'none';
            hoverPreview.style.position = 'absolute';
            hoverPreview.style.top = '100%';
            hoverPreview.style.left = '50%';
            hoverPreview.style.transform = 'translateX(-50%)';
            hoverPreview.style.zIndex = '1000';
            hoverPreview.style.background = '#000';
            hoverPreview.style.padding = '4px';
            hoverPreview.style.borderRadius = '4px';
            hoverPreview.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
            
            const img = document.createElement('img');
            img.src = trainee.profilePicture;
            img.alt = trainee.name;
            img.style.maxWidth = '150px';
            img.style.maxHeight = '150px';
            img.style.borderRadius = '2px';
            hoverPreview.appendChild(img);
            nameCell.appendChild(hoverPreview);
            
            nameCell.addEventListener('mouseenter', () => {
              hoverPreview.style.display = 'block';
            });
            
            nameCell.addEventListener('mouseleave', () => {
              hoverPreview.style.display = 'none';
            });
          }
          
          row.appendChild(nameCell);

          // Speciality cell
          const deptCell = document.createElement('td');
          const deptContainer = document.createElement('div');
          deptContainer.className = 'dept-select-container';
          deptCell.appendChild(deptContainer);

          // Create badges container
          const badgesContainer = document.createElement('div');
          badgesContainer.className = 'dept-badges';
          badgesContainer.style.display = 'inline-flex';
          badgesContainer.style.flexWrap = 'wrap';
          badgesContainer.style.gap = '4px';

          // Add department badges or Add button
          if (trainee.departments && trainee.departments.length > 0) {
            // Add existing badges
            trainee.departments.forEach(deptId => {
              const dept = departments.find(d => d.id === deptId);
              if (dept) {
                const badge = document.createElement('div');
                badge.className = `dept-badge ${deptId}`;
                badge.innerHTML = `<span class="badge-tooltip">${dept.name}</span>${dept.abbr}`;
                badge.style.cursor = 'pointer';
                badge.onclick = (e) => {
                  e.stopPropagation();
                  showDeptSelectDialog(trainee, e.target);
                };
                badgesContainer.appendChild(badge);
              }
            });
            deptCell.appendChild(badgesContainer);
          } else {
            // Add "Add Spec" button
            const addDeptBtn = document.createElement('div');
            addDeptBtn.className = 'dept-badge add-dept';
            addDeptBtn.textContent = 'Add Spec';
            addDeptBtn.style.cursor = 'pointer';
          addDeptBtn.onclick = (e) => {
            e.stopPropagation();
            showDeptSelectDialog(trainee, e.target);
          };
            badgesContainer.appendChild(addDeptBtn);
            deptCell.appendChild(badgesContainer);
          }

          row.appendChild(deptCell);

          // Division cell
          const divisionCell = document.createElement('td');
          const divisionContainer = document.createElement('div');
          divisionContainer.className = 'dept-select-container';
          divisionCell.appendChild(divisionContainer);

          // Create badges container
          const divBadgesContainer = document.createElement('div');
          divBadgesContainer.className = 'dept-badges';
          divBadgesContainer.style.display = 'inline-flex';
          divBadgesContainer.style.flexWrap = 'wrap';
          divBadgesContainer.style.gap = '4px';

          // Add division badges if any divisions are selected
          if (trainee.divisions && trainee.divisions.length > 0) {

            trainee.divisions.forEach(divId => {
              const div = divisions.find(d => d.id === divId);
              if (div) {
                const badge = document.createElement('div');
                badge.className = `div-badge ${divId}`;
                badge.innerHTML = `<span class="badge-tooltip">${div.name}</span>${div.abbr}`;
                badge.style.cursor = 'pointer';
                badge.onclick = (e) => {
                  e.stopPropagation();
                  showDivSelectDialog(trainee, e.target);
                };
                divBadgesContainer.appendChild(badge);
              }
            });
            divisionCell.appendChild(divBadgesContainer);
          } else {
            // Add "Add Division" button
            const addDivBtn = document.createElement('div');
            addDivBtn.className = 'div-badge add-div';
            addDivBtn.textContent = 'Add Division';
            addDivBtn.style.cursor = 'pointer';
          addDivBtn.onclick = (e) => {
            e.stopPropagation();
            showDivSelectDialog(trainee, e.target);
          };
            divBadgesContainer.appendChild(addDivBtn);
            divisionCell.appendChild(divBadgesContainer);
          }

          row.appendChild(divisionCell);

          // Code Name cell
          const codenameCell = createEditableCell(trainee, 'codename', 'codename');
          row.appendChild(codenameCell);

          // Alias cell
          const aliasCell = document.createElement('td');
          aliasCell.textContent = trainee.ucAlias || trainee.alias || '-';
          aliasCell.className = 'uc-name';
          aliasCell.style.cursor = 'pointer';
          aliasCell.onclick = (e) => {
            e.stopPropagation();
            const newAlias = prompt('Enter new alias:', trainee.ucAlias || trainee.alias || '');
            if (newAlias !== null) {
              trainee.ucAlias = newAlias;
              trainee.timeline.push({
                date: new Date().toISOString(),
                content: `Alias updated to: ${newAlias}`,
                instructor: 'System'
              });
              saveTrainees();
              updateRosterTable();
            }
          };
          row.appendChild(aliasCell);

          // FIB Handler cell
          const handlerCell = document.createElement('td');
          handlerCell.textContent = trainee.handler || '-';
          row.appendChild(handlerCell);

          // Training Progress cell
          const progressCell = document.createElement('td');
          progressCell.className = 'progress-cell';

          const progressBar = document.createElement('div');
          progressBar.className = 'progress-bar';
          progressBar.onclick = (e) => {
            e.stopPropagation();
            showSkillsDialog(trainee, Object.keys(trainee.skills));
          };

          // Calculate progress
          const totalSkills = Object.keys(trainee.skills).length;
          const completedSkills = Object.values(trainee.skills).filter(skill => skill.completed).length;
          const progress = Math.round((completedSkills / totalSkills) * 100);

          const progressFill = document.createElement('div');
          progressFill.className = 'progress-fill';
          progressFill.style.width = `${progress}%`;

          const progressText = document.createElement('div');
          progressText.className = 'progress-text';
          progressText.textContent = `${progress}% Complete`;

          // Add hover details
          const progressDetails = document.createElement('div');
          progressDetails.className = 'progress-details';
          const skillsList = document.createElement('ul');
          
          Object.entries(trainee.skills).forEach(([skill, data]) => {
            const item = document.createElement('li');
            item.className = data.completed ? 'completed' : 'pending';
            item.innerHTML = `${skill.replace(/([A-Z])/g, ' $1').trim()}${data.completed ? ` (${data.instructor})` : ''}`;
            skillsList.appendChild(item);
          });
          
          progressDetails.appendChild(skillsList);
          progressCell.appendChild(progressDetails);

          progressBar.appendChild(progressFill);
          progressBar.appendChild(progressText);
          progressCell.appendChild(progressBar);
          row.appendChild(progressCell);

          // Delete button cell
          const actionCell = document.createElement('td');
          actionCell.style.width = '40px';
          actionCell.style.textAlign = 'center';
          const deleteButton = document.createElement('button');
          deleteButton.className = 'delete-btn';
          deleteButton.innerHTML = '&times;';
          deleteButton.onclick = (e) => {
            e.stopPropagation();
            showDeleteDialog(trainee);
          };
          actionCell.appendChild(deleteButton);
          row.appendChild(actionCell);

          tbody.appendChild(row);
        } catch (error) {
          console.error('Error creating row for roster trainee:', trainee, error);
        }
      });
    }

    function showDeptSkillsDialog(trainee, dept) {
      // Show a dialog with department-specific skills
      const skills = Object.entries(trainee.skills)
        .filter(([skill]) => skill.startsWith(dept.name.replace(/\s+/g, '')))
        .map(([skill, data]) => ({ skill, ...data }));

      showSkillsDialog(trainee, skills.map(s => s.skill));
    }

    function showDivSkillsDialog(trainee, div) {
      // Show a dialog with division-specific skills
      const skills = Object.entries(trainee.skills)
        .filter(([skill]) => skill.startsWith(div.name.replace(/\s+/g, '')))
        .map(([skill, data]) => ({ skill, ...data }));

      showSkillsDialog(trainee, skills.map(s => s.skill));
    }

    function showDeptSelectDialog(trainee, sourceElement = null) {
      const dialog = document.createElement('div');
      dialog.className = 'dept-select-dialog';
      dialog.style.zIndex = '100001';

      const title = document.createElement('div');
      title.className = 'dept-select-title';
      title.textContent = 'Select Speciality';
      dialog.appendChild(title);

      const content = document.createElement('div');
      content.className = 'dept-select-content';

      departments.forEach(dept => {
        const option = document.createElement('div');
        option.className = 'dept-option';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = trainee.departments?.includes(dept.id) || false;
        checkbox.onchange = async () => {
          if (!trainee.departments) trainee.departments = [];
          if (checkbox.checked) {
            if (!trainee.departments.includes(dept.id)) {
              trainee.departments.push(dept.id);
              trainee.timeline.push({
                date: new Date().toISOString(),
                content: `Added to ${dept.name} speciality`,
                instructor: 'System'
              });
            }
          } else {
            const index = trainee.departments.indexOf(dept.id);
            if (index > -1) {
              trainee.departments.splice(index, 1);
              trainee.timeline.push({
                date: new Date().toISOString(),
                content: `Removed from ${dept.name} speciality`,
                instructor: 'System'
              });
            }
          }
          // If all departments are removed, make sure the array exists but is empty
          if (trainee.departments.length === 0) {
            trainee.departments = [];
          }
          // Save changes and update UI
          await saveTrainees();
          // Update both tables since entries can move between them
          updateTrainingTable();
          updateRosterTable();
          // Close the dialog after selection
          dialog.remove();
        };
        option.appendChild(checkbox);

        const label = document.createElement('span');
        label.textContent = dept.name;
        option.appendChild(label);

        content.appendChild(option);
      });

      dialog.appendChild(content);

      // Position the dialog near the source element if provided
      if (sourceElement) {
        const rect = sourceElement.getBoundingClientRect();
        dialog.style.position = 'fixed';
        dialog.style.top = rect.bottom + 'px';
        dialog.style.left = rect.left + 'px';
      }

      document.body.appendChild(dialog);

      // Close when clicking outside
      document.addEventListener('click', function closeDialog(e) {
        if (!dialog.contains(e.target) && e.target !== sourceElement) {
          dialog.remove();
          document.removeEventListener('click', closeDialog);
        }
      });
    }

    function showDivSelectDialog(trainee, sourceElement = null) {
      const dialog = document.createElement('div');
      dialog.className = 'dept-select-dialog';
      dialog.style.zIndex = '100001';

      const title = document.createElement('div');
      title.className = 'dept-select-title';
      title.textContent = 'Select Division';
      dialog.appendChild(title);

      const content = document.createElement('div');
      content.className = 'dept-select-content';

      divisions.forEach(div => {
        const option = document.createElement('div');
        option.className = 'dept-option';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = trainee.divisions?.includes(div.id) || false;
        checkbox.onchange = async () => {
          if (!trainee.divisions) trainee.divisions = [];
          if (checkbox.checked) {
            if (!trainee.divisions.includes(div.id)) {
              trainee.divisions.push(div.id);
              trainee.timeline.push({
                date: new Date().toISOString(),
                content: `Added to ${div.name} division`,
                instructor: 'System'
              });
            }
          } else {
            const index = trainee.divisions.indexOf(div.id);
            if (index > -1) {
              trainee.divisions.splice(index, 1);
              trainee.timeline.push({
                date: new Date().toISOString(),
                content: `Removed from ${div.name} division`,
                instructor: 'System'
              });
            }
          }
          // If all divisions are removed, make sure the array exists but is empty
          if (trainee.divisions.length === 0) {
            trainee.divisions = [];
          }
          // Save changes and update UI
          await saveTrainees();
          // Update both tables since entries can move between them
          updateTrainingTable();
          updateRosterTable();
          // Close the dialog after selection
          dialog.remove();
        };
        option.appendChild(checkbox);

        const label = document.createElement('span');
        label.textContent = div.name;
        option.appendChild(label);

        content.appendChild(option);
      });

      dialog.appendChild(content);

      // Position the dialog near the source element if provided
      if (sourceElement) {
        const rect = sourceElement.getBoundingClientRect();
        dialog.style.position = 'fixed';
        dialog.style.top = rect.bottom + 'px';
        dialog.style.left = rect.left + 'px';
      }

      document.body.appendChild(dialog);

      // Close when clicking outside
      document.addEventListener('click', function closeDialog(e) {
        if (!dialog.contains(e.target) && e.target !== sourceElement) {
          dialog.remove();
          document.removeEventListener('click', closeDialog);
        }
      });
    }

    function updateDeletedTable() {
      const tbody = document.getElementById('deletedTableBody');
      tbody.innerHTML = '';
      
      deletedTrainees.forEach(trainee => {
        try {
          const row = document.createElement('tr');
          row.className = 'trainee-row';
          row.onclick = () => showProfile(trainee, true); // true indicates it's a deleted trainee
          
          // # (Callsign) cell
          const callsignCell = createEditableCell(trainee, 'callsign', 'callsign');
          row.appendChild(callsignCell);

          // Rank cell with badge
          const rankCell = document.createElement('td');
          const currentRank = RANKS.find(r => r.id === trainee.rank) || RANKS[0];
          rankCell.innerHTML = `<span class="rank-badge ${currentRank.id}"><span class="badge-tooltip">${currentRank.name}</span>${currentRank.abbr}</span>`;
          row.appendChild(rankCell);

          // Name cell
          const nameCell = document.createElement('td');
          nameCell.textContent = trainee.name || '-';
          row.appendChild(nameCell);

          // Speciality cell
          const deptCell = document.createElement('td');
          const deptContainer = document.createElement('div');
          deptContainer.className = 'dept-select-container';
          if (trainee.departments && trainee.departments.length > 0) {
            const badgesContainer = document.createElement('div');
            badgesContainer.className = 'dept-badges';
            badgesContainer.style.display = 'inline-flex';
            badgesContainer.style.flexWrap = 'wrap';
            badgesContainer.style.gap = '4px';
            trainee.departments.forEach(deptId => {
              const dept = departments.find(d => d.id === deptId);
              if (dept) {
                const badge = document.createElement('div');
                badge.className = `dept-badge ${deptId}`;
                badge.innerHTML = `<span class="badge-tooltip">${dept.name}</span>${dept.abbr}`;
                badgesContainer.appendChild(badge);
              }
            });
            deptContainer.appendChild(badgesContainer);
          } else {
            deptContainer.textContent = 'N/A';
          }
          deptCell.appendChild(deptContainer);
          row.appendChild(deptCell);

          // Division cell
          const divisionCell = document.createElement('td');
          const divisionContainer = document.createElement('div');
          divisionContainer.className = 'dept-select-container';
          if (trainee.divisions && trainee.divisions.length > 0) {
            const divBadgesContainer = document.createElement('div');
            divBadgesContainer.className = 'dept-badges';
            divBadgesContainer.style.display = 'inline-flex';
            divBadgesContainer.style.flexWrap = 'wrap';
            divBadgesContainer.style.gap = '4px';
            trainee.divisions.forEach(divId => {
              const div = divisions.find(d => d.id === divId);
              if (div) {
                const badge = document.createElement('div');
                badge.className = `div-badge ${divId}`;
                badge.innerHTML = `<span class="badge-tooltip">${div.name}</span>${div.abbr}`;
                divBadgesContainer.appendChild(badge);
              }
            });
            divisionContainer.appendChild(divBadgesContainer);
          } else {
            divisionContainer.textContent = 'N/A';
          }
          divisionCell.appendChild(divisionContainer);
          row.appendChild(divisionCell);

          // Code Name cell
          const codenameCell = createEditableCell(trainee, 'codename', 'codename');
          row.appendChild(codenameCell);

          // Alias cell
          const aliasCell = document.createElement('td');
          aliasCell.textContent = trainee.ucAlias || trainee.alias || '-';
          aliasCell.className = 'uc-name';
          row.appendChild(aliasCell);

          // FIB Handler cell
          const handlerCell = document.createElement('td');
          handlerCell.textContent = trainee.handler || '-';
          row.appendChild(handlerCell);

          // Training Progress cell
          const progressCell = document.createElement('td');
          progressCell.className = 'progress-cell';
          const progressBar = document.createElement('div');
          progressBar.className = 'progress-bar';
          const totalSkills = Object.keys(trainee.skills || {}).length;
          const completedSkills = Object.values(trainee.skills || {}).filter(skill => skill.completed).length;
          const progress = totalSkills > 0 ? Math.round((completedSkills / totalSkills) * 100) : 0;
          const progressFill = document.createElement('div');
          progressFill.className = 'progress-fill';
          progressFill.style.width = `${progress}%`;
          
          const progressText = document.createElement('div');
          progressText.className = 'progress-text';
          progressText.textContent = `${progress}% Complete`;
          
          progressBar.appendChild(progressFill);
          progressBar.appendChild(progressText);
          progressCell.appendChild(progressBar);
          row.appendChild(progressCell);

          // Deleted By cell
          const deletedByCell = document.createElement('td');
          deletedByCell.textContent = trainee.deletedBy || '-';
          row.appendChild(deletedByCell);

          // Deleted On cell
          const deletedOnCell = document.createElement('td');
          deletedOnCell.textContent = trainee.deletedOn ? new Date(trainee.deletedOn).toLocaleString() : '-';
          row.appendChild(deletedOnCell);
          
          tbody.appendChild(row);
        } catch (error) {
          console.error('Error creating row for deleted trainee:', trainee, error);
        }
      });
    }

    // Helper function to create badges HTML
    function createBadgesHTML(items, type) {
      if (!items || !items.length) return 'N/A';
      
      const config = type === 'dept' ? departments : divisions;
      
      return `<div class="${type}-badges">` + items.map(itemId => {
        const item = config.find(c => c.id === itemId);
        return item ? `<div class="${type}-badge ${itemId}"><span class="badge-tooltip">${item.name}</span>${item.abbr}</div>` : '';
      }).join('') + '</div>';
    }

    function showDeleteDialog(trainee) {
      const dialog = document.createElement('div');
      dialog.className = 'delete-dialog';
      dialog.innerHTML = `
        <div class="delete-dialog-title">DELETE TRAINEE</div>
        <input type="text" class="delete-input" placeholder="Enter your name to confirm deletion" />
        <div class="delete-dialog-buttons">
          <button class="delete-dialog-btn" onclick="confirmDelete(this, '${trainee.id}')">DELETE</button>
          <button class="delete-dialog-btn cancel" onclick="this.closest('.delete-dialog').remove()">CANCEL</button>
        </div>
      `;
      document.body.appendChild(dialog);
    }

    async function confirmDelete(button, traineeId) {
      const dialog = button.closest('.delete-dialog');
      const input = dialog.querySelector('.delete-input');
      const deletedBy = input.value.trim();
      
      if (!deletedBy) {
        alert('Please enter your name to confirm deletion');
        return;
      }

      try {
        // Check both trainees and roster arrays
        const trainee = trainees.find(t => t.id === traineeId) || roster.find(t => t.id === traineeId);
        if (!trainee) {
          console.error('Trainee not found:', traineeId);
          return;
        }

        // Move trainee to deleted collection
        const deletedTrainee = {
          ...trainee,
          deletedBy,
          deletedOn: new Date().toISOString()
        };

          const updates = {};
        // Remove from appropriate collection
        if (trainees.find(t => t.id === traineeId)) {
          updates[`/trainees/${traineeId}`] = null;
        } else {
          updates[`/roster/${traineeId}`] = null;
        }
        updates[`/deleted/${traineeId}`] = deletedTrainee;
          
          await fbUpdate(fbRef(fbDatabase), updates);
        console.log('Successfully moved trainee to deleted:', traineeId);
        dialog.remove();
      } catch (error) {
        console.error('Error deleting trainee:', error);
        showDatabaseError('Failed to delete trainee. Please try again.');
      }
    }

    async function promoteTrainee(traineeId) {
      try {
        const trainee = trainees.find(t => t.id === traineeId);
        if (!trainee) return;

        // Create a complete copy of the trainee data
        const promotedTrainee = {
          id: trainee.id,
          name: trainee.name || '',
          handler: trainee.handler || '',
          rank: trainee.rank || 'intern',
          callsign: trainee.callsign || '',
          codename: trainee.codename || '',
          alias: trainee.alias || '',
          ucAlias: trainee.ucAlias || '',
          departments: trainee.departments || [],
          divisions: trainee.divisions || [],
          skills: trainee.skills || {
            'CloseQuartersBreaching': { completed: false, instructor: '', completedDate: null },
            'OpenAreaBreaching': { completed: false, instructor: '', completedDate: null },
            'SceneControl': { completed: false, instructor: '', completedDate: null },
            'COMMS': { completed: false, instructor: '', completedDate: null },
            'UseOfForce': { completed: false, instructor: '', completedDate: null },
            'FilingCharges': { completed: false, instructor: '', completedDate: null },
            'Reports': { completed: false, instructor: '', completedDate: null },
            'Gunfight': { completed: false, instructor: '', completedDate: null },
            'UndercoverTraining': { completed: false, instructor: '', completedDate: null },
            'HelicopterLicense': { completed: false, instructor: '', completedDate: null }
          },
          strikes: trainee.strikes || [],
          commendations: trainee.commendations || [],
          timeline: [...(trainee.timeline || []), {
            date: new Date().toISOString(),
            content: 'Promoted to FIB Roster',
            instructor: 'System'
          }],
          promotedOn: new Date().toISOString()
        };

        // Move trainee to roster collection
        const updates = {};
        updates[`/trainees/${traineeId}`] = null;
        updates[`/roster/${traineeId}`] = promotedTrainee;
        
        await fbUpdate(fbRef(fbDatabase), updates);
        console.log('Successfully promoted trainee:', traineeId);
      } catch (error) {
        console.error('Error promoting trainee:', error);
        showDatabaseError('Failed to promote trainee. Please try again.');
      }
    }

    async function updateTraineeField(traineeId, field, value) {
      try {
        if (!traineeId || !field) return;
        
        // Update specific field only
        const updates = {};
        updates[`/trainees/${traineeId}/${field}`] = value;
        
        await fbUpdate(fbRef(fbDatabase), updates);
        console.log(`Updated trainee ${traineeId} ${field}:`, value);
      } catch (error) {
        console.error('Error updating trainee:', error);
        showDatabaseError('Failed to save changes. Please try again.');
      }
    }




    function updateTrainingTable() {
      try {
        console.log('Updating training table...');
        console.log('Current trainees:', trainees);
        
        // Ensure trainees is an array
        if (!Array.isArray(trainees)) {
          console.error('Trainees is not an array, resetting...');
          trainees = [];
        }
        
        const tbody = document.getElementById('trainingTableBody');
        if (!tbody) {
          console.error('Training table body not found!');
          return;
        }
        
        // Clear the table
        tbody.innerHTML = '';
        
        // If no trainees, show empty message
        if (trainees.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 8; // Updated colspan for our columns
          cell.style.textAlign = 'center';
          cell.style.padding = '20px';
          cell.textContent = 'No trainees added yet';
          row.appendChild(cell);
          tbody.appendChild(row);
          return;
        }

      // Add each trainee to the table
      trainees.forEach((trainee, index) => {
        try {
          const row = document.createElement('tr');

          // # (Callsign) cell
          const callsignCell = createEditableCell(trainee, 'callsign', 'callsign');
          row.appendChild(callsignCell);

          // Rank cell
          const rankCell = document.createElement('td');
          const rankSelect = document.createElement('div');
          rankSelect.className = 'rank-select';
          
          const rankBtn = document.createElement('button');
          rankBtn.className = 'rank-select-btn';
          const currentRank = RANKS.find(r => r.id === trainee.rank) || RANKS[0];
          rankBtn.innerHTML = `<span class="rank-badge ${currentRank.id}"><span class="badge-tooltip">${currentRank.name}</span>${currentRank.abbr}</span>`;
          rankBtn.onclick = (e) => {
            e.stopPropagation();
            rankSelect.classList.toggle('open');
          };
          rankSelect.appendChild(rankBtn);

          const rankDropdown = document.createElement('div');
          rankDropdown.className = 'rank-select-dropdown';
          RANKS.forEach(rank => {
            const option = document.createElement('div');
            option.className = `rank-option${rank.id === trainee.rank ? ' selected' : ''}`;
            option.innerHTML = `<span class="rank-badge ${rank.id}">${rank.abbr}</span> ${rank.name}`;
            option.onclick = (e) => {
              e.stopPropagation();
              trainee.rank = rank.id;
              saveTrainees();
              updateTrainingTable();
              rankSelect.classList.remove('open');
            };
            rankDropdown.appendChild(option);
          });
          rankSelect.appendChild(rankDropdown);
          rankCell.appendChild(rankSelect);
          row.appendChild(rankCell);

          // Name cell
          const nameCell = document.createElement('td');
          const nameWrapper = document.createElement('div');
          nameWrapper.style.display = 'flex';
          nameWrapper.style.alignItems = 'center';
          nameWrapper.style.gap = '8px';
          
          const nameText = document.createElement('button');
          nameText.textContent = trainee.name || 'Unknown';
          nameText.style.cursor = 'pointer';
          nameText.style.background = 'rgba(253, 224, 71, 0.1)';
          nameText.style.border = '1px solid rgba(253, 224, 71, 0.2)';
          nameText.style.borderRadius = '4px';
          nameText.style.padding = '4px 8px';
          nameText.style.color = '#fde047';
          nameText.style.fontSize = '13px';
          nameText.style.transition = 'all 0.2s ease';
          nameText.onmouseover = (e) => {
            nameText.style.background = 'rgba(253, 224, 71, 0.2)';
            showNameHover(e, trainee);
          };
          nameText.onmouseout = () => {
            nameText.style.background = 'rgba(253, 224, 71, 0.1)';
            hideNameHover();
          };
          nameText.onclick = () => {
            const traineeData = trainees.find(t => t.id === trainee.id);
            if (traineeData) {
              showProfile(traineeData);
            }
          };
          nameWrapper.appendChild(nameText);

          nameWrapper.appendChild(nameText);
          
          nameCell.appendChild(nameWrapper);
          row.appendChild(nameCell);

          // Department cell
          const deptCell = document.createElement('td');
          const deptContainer = document.createElement('div');
          deptContainer.className = 'dept-select-container';

          const deptButton = document.createElement('button');
          deptButton.className = 'dept-select-btn';
          deptButton.style.display = trainee.departments && trainee.departments.length > 0 ? 'none' : 'block';
          deptButton.textContent = 'Add Spec';
          deptButton.onclick = (e) => {
            e.stopPropagation();
            const dropdown = e.target.closest('.dept-select-container').querySelector('.dept-select-dropdown');
            const wasOpen = dropdown.style.display === 'block';
            // Close all dropdowns first
            document.querySelectorAll('.dept-select-dropdown').forEach(d => {
              d.style.display = 'none';
            });
            // Toggle this dropdown
            dropdown.style.display = wasOpen ? 'none' : 'block';
          };
          deptContainer.appendChild(deptButton);

          const deptDropdown = document.createElement('div');
          deptDropdown.className = 'dept-select-dropdown';

          const departments = [
            { id: 'fa', name: 'Field Agents', abbr: 'FA' },
            { id: 'inv', name: 'Investigators', abbr: 'INV' },
            { id: 'ana', name: 'Analysts', abbr: 'ANA' },
            { id: 'sup', name: 'Supernatural', abbr: 'SUP' }
          ];

          departments.forEach(dept => {
            const option = document.createElement('label');
            option.className = 'dept-option';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = trainee.departments && trainee.departments.includes(dept.id);
            checkbox.onchange = (e) => {
              e.stopPropagation();
              if (!trainee.departments) trainee.departments = [];
              
              if (e.target.checked) {
                trainee.departments.push(dept.id);
                trainee.timeline.push({
                  date: new Date().toISOString(),
                  content: `Added to ${dept.name} Department`,
                  instructor: 'System'
                });
              } else {
                trainee.departments = trainee.departments.filter(d => d !== dept.id);
                trainee.timeline.push({
                  date: new Date().toISOString(),
                  content: `Removed from ${dept.name} Department`,
                  instructor: 'System'
                });
              }
              saveTrainees();
              updateTrainingTable();
            };

            option.appendChild(checkbox);
            option.appendChild(document.createTextNode(dept.name));
            deptDropdown.appendChild(option);
          });

          deptContainer.appendChild(deptDropdown);
          deptCell.appendChild(deptContainer);

          // Add department badges if any departments are selected
          if (trainee.departments && trainee.departments.length > 0) {
            const badgesContainer = document.createElement('div');
            badgesContainer.className = 'dept-badges';

            trainee.departments.forEach(deptId => {
              const dept = departments.find(d => d.id === deptId);
              if (dept) {
                const badge = document.createElement('div');
                badge.className = `dept-badge ${deptId}`;
                badge.innerHTML = `<span class="badge-tooltip">${dept.name}</span>${dept.abbr}`;
                badge.style.cursor = 'pointer';
                badge.onclick = (e) => {
                  e.stopPropagation();
                  const container = e.target.closest('td').querySelector('.dept-select-dropdown');
                  if (container) {
                    const wasOpen = container.style.display === 'block';
                    // Close all other dropdowns first
                    document.querySelectorAll('.dept-select-dropdown').forEach(dropdown => {
                      dropdown.style.display = 'none';
                    });
                    // Toggle this dropdown
                    container.style.display = wasOpen ? 'none' : 'block';
                  }
                };
                badgesContainer.appendChild(badge);
              }
            });

            deptCell.appendChild(badgesContainer);
          }

          row.appendChild(deptCell);

          // Division cell
          const divisionCell = document.createElement('td');
          const divisionContainer = document.createElement('div');
          divisionContainer.className = 'dept-select-container';

          const divisionButton = document.createElement('button');
          divisionButton.className = 'dept-select-btn';
          divisionButton.style.display = trainee.divisions && trainee.divisions.length > 0 ? 'none' : 'block';
          divisionButton.textContent = 'Add Div';
          divisionButton.onclick = (e) => {
            e.stopPropagation();
            const dropdown = e.target.closest('.dept-select-container').querySelector('.dept-select-dropdown');
            const wasOpen = dropdown.style.display === 'block';
            // Close all dropdowns first
            document.querySelectorAll('.dept-select-dropdown').forEach(d => {
              d.style.display = 'none';
            });
            // Toggle this dropdown
            dropdown.style.display = wasOpen ? 'none' : 'block';
          };
          divisionContainer.appendChild(divisionButton);

          const divisionDropdown = document.createElement('div');
          divisionDropdown.className = 'dept-select-dropdown';

          const divisions = [
            { id: 'sup', name: 'Supernatural', abbr: 'SUP' },
            { id: 'cl', name: 'Criminal Law', abbr: 'CL' },
            { id: 'oc', name: 'Organised Crime', abbr: 'OC' },
            { id: 'ia', name: 'Internal Affairs', abbr: 'IA' }
          ];

          divisions.forEach(div => {
            const option = document.createElement('label');
            option.className = 'dept-option';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = trainee.divisions && trainee.divisions.includes(div.id);
            checkbox.onchange = (e) => {
              e.stopPropagation();
              if (!trainee.divisions) trainee.divisions = [];
              
              if (e.target.checked) {
                trainee.divisions.push(div.id);
                trainee.timeline.push({
                  date: new Date().toISOString(),
                  content: `Added to ${div.name} Division`,
                  instructor: 'System'
                });
              } else {
                trainee.divisions = trainee.divisions.filter(d => d !== div.id);
                trainee.timeline.push({
                  date: new Date().toISOString(),
                  content: `Removed from ${div.name} Division`,
                  instructor: 'System'
                });
              }
              
              // Update specific fields in Firebase
              const updates = {};
              updates[`/trainees/${trainee.id}/divisions`] = trainee.divisions;
              updates[`/trainees/${trainee.id}/timeline`] = trainee.timeline;
              
              fbUpdate(fbRef(fbDatabase), updates).then(() => {
                console.log('Successfully updated divisions for trainee:', trainee.id);
                updateTrainingTable();
              }).catch(error => {
                console.error('Error updating divisions:', error);
                alert('Failed to update divisions. Please try again.');
              });
            };

            option.appendChild(checkbox);
            option.appendChild(document.createTextNode(div.name));
            divisionDropdown.appendChild(option);
          });

          divisionContainer.appendChild(divisionDropdown);
          divisionCell.appendChild(divisionContainer);

          // Add division badges if any divisions are selected
          if (trainee.divisions && trainee.divisions.length > 0) {
            const badgesContainer = document.createElement('div');
            badgesContainer.className = 'dept-badges';
            badgesContainer.style.display = 'inline-flex';
            badgesContainer.style.flexWrap = 'wrap';
            badgesContainer.style.gap = '4px';

            trainee.divisions.forEach(divId => {
              const div = divisions.find(d => d.id === divId);
              if (div) {
                const badge = document.createElement('div');
                badge.className = `div-badge ${divId}`;
                badge.innerHTML = `<span class="badge-tooltip">${div.name}</span>${div.abbr}`;
                badge.style.cursor = 'pointer';
                badge.onclick = (e) => {
                  e.stopPropagation();
                  const container = e.target.closest('td').querySelector('.dept-select-dropdown');
                  if (container) {
                    const wasOpen = container.style.display === 'block';
                    // Close all other dropdowns first
                    document.querySelectorAll('.dept-select-dropdown').forEach(dropdown => {
                      dropdown.style.display = 'none';
                    });
                    // Toggle this dropdown
                    container.style.display = wasOpen ? 'none' : 'block';
                  }
                };
                badgesContainer.appendChild(badge);
              }
            });

            divisionCell.appendChild(badgesContainer);
          }

          row.appendChild(divisionCell);

          // Code Name cell
          const codenameCell = createEditableCell(trainee, 'codename', 'codename');
          row.appendChild(codenameCell);

          // Alias cell
          const aliasCell = document.createElement('td');
          aliasCell.textContent = trainee.ucAlias || trainee.alias || '-';
          aliasCell.className = 'uc-name';
          aliasCell.style.cursor = 'pointer';
          aliasCell.onclick = () => makeFieldEditable(aliasCell, trainee, 'ucAlias');
          row.appendChild(aliasCell);

          // FIB Handler cell
          const handlerCell = document.createElement('td');
          handlerCell.textContent = trainee.handler || '-';
          row.appendChild(handlerCell);

          // Training Progress cell
          const progressCell = document.createElement('td');
          progressCell.className = 'progress-cell';

          const progressBar = document.createElement('div');
          progressBar.className = 'progress-bar';
          progressBar.onclick = () => showSkillsDialog(trainee, Object.keys(trainee.skills));

          // Calculate progress
          const totalSkills = Object.keys(trainee.skills).length;
          const completedSkills = Object.values(trainee.skills).filter(skill => skill.completed).length;
          const progress = Math.round((completedSkills / totalSkills) * 100);

          const progressFill = document.createElement('div');
          progressFill.className = 'progress-fill';
          progressFill.style.width = `${progress}%`;

          const progressText = document.createElement('div');
          progressText.className = 'progress-text';
          progressText.textContent = `${progress}% Complete`;

          // Add hover details
          const progressDetails = document.createElement('div');
          progressDetails.className = 'progress-details';
          const skillsList = document.createElement('ul');
          
          Object.entries(trainee.skills).forEach(([skill, data]) => {
            const item = document.createElement('li');
            item.className = data.completed ? 'completed' : 'pending';
            item.innerHTML = `${skill.replace(/([A-Z])/g, ' $1').trim()}${data.completed ? ` (${data.instructor})` : ''}`;
            skillsList.appendChild(item);
          });
          
          progressDetails.appendChild(skillsList);
          progressCell.appendChild(progressDetails);

          progressBar.appendChild(progressFill);
          progressBar.appendChild(progressText);
          progressCell.appendChild(progressBar);
          row.appendChild(progressCell);

          // Action button cell
          const actionCell = document.createElement('td');
          actionCell.style.width = '40px';
          actionCell.style.textAlign = 'center';
          const actionButton = document.createElement('button');
          actionButton.className = 'promote-btn';
          actionButton.innerHTML = '+';
          actionButton.title = 'Promote to FIB Roster';
          actionButton.onclick = () => promoteTrainee(trainee.id);
          actionCell.appendChild(actionButton);
          row.appendChild(actionCell);

          // Add row to table
          tbody.appendChild(row);
        } catch (error) {
          console.error('Error creating row for trainee:', trainee, error);
        }
      });
      } catch (error) {
        console.error('Error updating training table:', error);
      }
    }

    function showSkillsDialog(trainee, skills) {
      const dialog = document.createElement('div');
      dialog.className = 'password-dialog';
      dialog.style.display = 'block';

      const title = document.createElement('div');
      title.className = 'password-dialog-title';
      title.textContent = `Select Training for ${trainee.name}`;
      dialog.appendChild(title);

      const list = document.createElement('div');
      list.style.marginBottom = '20px';
      list.style.maxHeight = '300px';
      list.style.overflowY = 'auto';

      skills.forEach((skill, index) => {
        const data = trainee.skills[skill];
        const item = document.createElement('div');
        item.style.padding = '8px';
        item.style.cursor = 'pointer';
        item.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.gap = '8px';

        const number = document.createElement('span');
        number.style.color = '#fde047';
        number.style.fontWeight = 'bold';
        number.textContent = `${index + 1}.`;
        item.appendChild(number);

        const text = document.createElement('span');
        text.textContent = `${skill.replace(/([A-Z])/g, ' $1').trim()}`;
        if (data.completed) {
          text.style.color = '#22c55e';
          text.textContent += ` (✓ ${data.instructor})`;
        }
        item.appendChild(text);

        item.onclick = () => {
          dialog.remove();
          toggleSkill(trainee, skill);
        };

        item.onmouseover = () => {
          item.style.backgroundColor = 'rgba(255,255,255,0.05)';
        };
        item.onmouseout = () => {
          item.style.backgroundColor = '';
        };

        list.appendChild(item);
      });
      dialog.appendChild(list);

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'password-dialog-buttons';
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'password-dialog-btn';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.onclick = () => dialog.remove();
      buttonContainer.appendChild(cancelBtn);
      
      dialog.appendChild(buttonContainer);
      document.body.appendChild(dialog);
    }

    function toggleSkill(trainee, skill) {
      
      if (trainee.skills[skill].completed) {
        if (confirm(`Remove completion status for ${skill.replace(/([A-Z])/g, ' $1').trim()}?`)) {
          trainee.skills[skill].completed = false;
          trainee.skills[skill].instructor = '';
          trainee.skills[skill].completedDate = null;
          trainee.timeline = trainee.timeline.filter(event => 
            !event.content.includes(`Completed ${skill.replace(/([A-Z])/g, ' $1').trim()} Training`)
          );
              saveTrainees();
              updateTrainingTable();
        }
          } else {
        const instructor = prompt(`Enter instructor name for ${skill.replace(/([A-Z])/g, ' $1').trim()}:`);
        if (instructor) {
          const now = new Date();
          trainee.skills[skill].completed = true;
          trainee.skills[skill].instructor = instructor;
          trainee.skills[skill].completedDate = now.toISOString();
          trainee.timeline.push({
            date: now.toISOString(),
            content: `Completed ${skill.replace(/([A-Z])/g, ' $1').trim()} Training`,
            instructor: instructor
          });
              saveTrainees();
              updateTrainingTable();
        }
      }
    }

    async function showStrikeForm(trainee, type) {
      const dialog = document.createElement('div');
      dialog.className = 'password-dialog';
      dialog.style.display = 'block';

      const title = document.createElement('div');
      title.className = 'password-dialog-title';
      title.textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
      dialog.appendChild(title);

      const form = document.createElement('div');
      form.style.marginBottom = '20px';

      // Submitting Agent field
      const agentLabel = document.createElement('div');
      agentLabel.style.marginBottom = '8px';
      agentLabel.textContent = 'Submitting Agent:';
      form.appendChild(agentLabel);

      const agentInput = document.createElement('input');
      agentInput.className = 'password-input';
      agentInput.style.marginBottom = '16px';
      agentInput.placeholder = 'Enter agent name';
      form.appendChild(agentInput);

      // Reason field
      const reasonLabel = document.createElement('div');
      reasonLabel.style.marginBottom = '8px';
      reasonLabel.textContent = type === 'strike' ? 'Strike Details:' : 'Commendation Details:';
      form.appendChild(reasonLabel);

      const reasonInput = document.createElement('textarea');
      reasonInput.className = 'password-input';
      reasonInput.style.height = '100px';
      reasonInput.style.resize = 'vertical';
      reasonInput.placeholder = type === 'strike' ? 'Enter detailed strike information' : 'Enter detailed commendation';
      form.appendChild(reasonInput);

      dialog.appendChild(form);

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'password-dialog-buttons';
      
      const submitBtn = document.createElement('button');
      submitBtn.className = 'password-dialog-btn';
      submitBtn.textContent = 'Submit';
      submitBtn.onclick = async () => {
        try {
          const agent = agentInput.value.trim();
          const reason = reasonInput.value.trim();
          
          if (!agent || !reason) {
            alert('Please fill in all fields');
            return;
          }

          const entry = `${reason} (by ${agent})`;
          const updates = {};
          
          // Initialize arrays if they don't exist
          if (!trainee[type + 's']) {
            trainee[type + 's'] = [];
          }
          if (!trainee.timeline) {
            trainee.timeline = [];
          }

          // Add the new entry
          trainee[type + 's'].push(entry);
          trainee.timeline.push({
            date: new Date().toISOString(),
            content: type === 'strike' ? `Received Strike: ${reason}` : `Received Commendation: ${reason}`,
            instructor: agent
          });

          // Update specific fields in Firebase
          updates[`/trainees/${trainee.id}/${type}s`] = trainee[type + 's'];
          updates[`/trainees/${trainee.id}/timeline`] = trainee.timeline;

          await fbUpdate(fbRef(fbDatabase), updates);
          console.log(`Successfully added ${type} to trainee:`, trainee.id);
          
          dialog.remove();
          showProfile(trainee);
        } catch (error) {
          console.error(`Error adding ${type}:`, error);
          alert(`Failed to add ${type}. Please try again.`);
        }
      };
      buttonContainer.appendChild(submitBtn);
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'password-dialog-btn';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.onclick = () => dialog.remove();
      buttonContainer.appendChild(cancelBtn);
      
      dialog.appendChild(buttonContainer);
      document.body.appendChild(dialog);
    }

    function showRecordDetails(record, type) {
      const dialog = document.createElement('div');
      dialog.className = 'password-dialog';
      dialog.style.display = 'block';

      const title = document.createElement('div');
      title.className = 'password-dialog-title';
      title.textContent = type;
      dialog.appendChild(title);

      const content = document.createElement('div');
      content.style.marginBottom = '20px';
      content.style.whiteSpace = 'pre-wrap';
      content.style.wordBreak = 'break-word';
      
      const reason = record.replace(/\s*\(by .*?\)$/, '');
      const agent = record.match(/by (.*?)\)$/)[1];

      const reasonText = document.createElement('div');
      reasonText.style.marginBottom = '16px';
      reasonText.style.fontSize = '14px';
      reasonText.textContent = reason;
      content.appendChild(reasonText);

      const agentText = document.createElement('div');
      agentText.style.color = '#fde047';
      agentText.style.fontSize = '12px';
      agentText.textContent = `Submitted by: ${agent}`;
      content.appendChild(agentText);

      dialog.appendChild(content);

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'password-dialog-buttons';
      
      const closeBtn = document.createElement('button');
      closeBtn.className = 'password-dialog-btn';
      closeBtn.textContent = 'Close';
      closeBtn.onclick = () => dialog.remove();
      buttonContainer.appendChild(closeBtn);
      
      dialog.appendChild(buttonContainer);
      document.body.appendChild(dialog);
    }

    function createEditableCell(trainee, field, className = '') {
      const cell = document.createElement('td');
      cell.textContent = trainee[field] || '-';
      if (className) cell.className = className;
      cell.style.cursor = 'pointer';
      cell.onclick = () => makeFieldEditable(cell, trainee, field);
      return cell;
    }

    function makeFieldEditable(element, trainee, field, onSave) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = element.textContent === '-' ? '' : element.textContent;
      input.style.width = '100%';
      input.style.background = 'rgba(255,255,255,.05)';
      input.style.border = '1px solid rgba(255,255,255,.1)';
      input.style.borderRadius = '4px';
      input.style.padding = '4px 8px';
      input.style.color = '#fff';
      input.style.fontSize = '13px';

      const save = () => {
        const newValue = input.value.trim();
        if (newValue !== trainee[field]) {
          trainee[field] = newValue;
          trainee.timeline.push({
            date: new Date().toISOString(),
            content: `${field.charAt(0).toUpperCase() + field.slice(1)} updated to: ${newValue}`,
            instructor: 'System'
          });
          saveTrainees();
          updateTrainingTable();
          if (onSave) onSave(newValue);
        }
        element.textContent = newValue || '-';
      };

      input.onblur = save;
      input.onkeydown = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          save();
          input.blur();
        }
        if (e.key === 'Escape') {
          element.textContent = trainee[field] || '-';
          input.blur();
        }
      };

      element.textContent = '';
      element.appendChild(input);
      input.focus();
      input.select();
    }

    const RANKS = [
      { id: 'intern', name: 'INTERN', abbr: 'INT' },
      { id: 'trainee', name: 'TRAINEE', abbr: 'TRN' },
      { id: 'recruit', name: 'RECRUIT', abbr: 'RCT' },
      { id: 'agent', name: 'AGENT', abbr: 'AGT' },
      { id: 'special', name: 'SPECIAL AGENT', abbr: 'SA' }
    ];

    let currentTrainee = null;

    function showSecureDeleteDialog(trainee) {
      const dialog = document.createElement('div');
      dialog.className = 'password-dialog';
      dialog.style.display = 'block';

      const title = document.createElement('div');
      title.className = 'password-dialog-title';
      title.textContent = 'SECURE DELETE';
      dialog.appendChild(title);

      const form = document.createElement('div');
      form.style.marginBottom = '20px';

      const passwordInput = document.createElement('input');
      passwordInput.type = 'password';
      passwordInput.className = 'password-input';
      passwordInput.placeholder = 'Enter password';
      passwordInput.style.marginBottom = '16px';
      form.appendChild(passwordInput);

      dialog.appendChild(form);

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'password-dialog-buttons';
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'password-dialog-btn';
      deleteBtn.style.background = '#ef4444';
      deleteBtn.textContent = 'DELETE';
      deleteBtn.onclick = () => {
        if (passwordInput.value === 'FIBDELETE') {
          showDeleteDialog(trainee);
          dialog.remove();
        } else {
          alert('Incorrect password');
        }
      };
      buttonContainer.appendChild(deleteBtn);
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'password-dialog-btn';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.onclick = () => dialog.remove();
      buttonContainer.appendChild(cancelBtn);
      
      dialog.appendChild(buttonContainer);
      document.body.appendChild(dialog);
    }

    function showProfile(trainee, isDeleted = false) {
      if (!trainee) {
        console.error('No trainee data provided to showProfile');
        return;
      }

      try {
        console.log('Showing profile for trainee:', trainee);
        window.currentTrainee = trainee;
        const modal = document.getElementById('profileModal');
        if (!modal) {
          console.error('Profile modal element not found');
          return;
        }
        
        // Clear any existing deleted trainee alerts
        const existingAlerts = document.querySelectorAll('.profile-content > div[style*="background: rgba(239, 68, 68, 0.1)"]');
        existingAlerts.forEach(alert => alert.remove());

        // Set basic info
        const currentRank = RANKS.find(r => r.id === trainee.rank) || RANKS[0];

        // Add close button if it doesn't exist
        let closeBtn = document.querySelector('.close-btn');
        if (!closeBtn) {
            closeBtn = document.createElement('button');
            closeBtn.className = 'close-btn';
            closeBtn.innerHTML = '×';
            closeBtn.onclick = closeProfile;
            document.querySelector('.profile-content').appendChild(closeBtn);
        }

        // Set profile picture
        const profilePicture = document.querySelector('.profile-picture');
        if (profilePicture) {
          profilePicture.src = trainee.profilePicture || 'https://kappa.lol/3qib3z';
          profilePicture.setAttribute('data-trainee-id', trainee.id);
          if (isDeleted) {
            profilePicture.style.cursor = 'default';
            profilePicture.onclick = null;
          }
        }

        // If deleted, add a notice at the top
        if (isDeleted) {
          const deleteInfo = document.createElement('div');
          deleteInfo.style.background = 'rgba(239, 68, 68, 0.1)';
          deleteInfo.style.border = '1px solid rgba(239, 68, 68, 0.2)';
          deleteInfo.style.color = '#ef4444';
          deleteInfo.style.padding = '12px';
          deleteInfo.style.borderRadius = '8px';
          deleteInfo.style.marginBottom = '16px';
          deleteInfo.style.fontSize = '14px';
          deleteInfo.innerHTML = `
            <strong>DELETED TRAINEE</strong><br>
            Deleted by: ${trainee.deletedBy}<br>
            Deleted on: ${new Date(trainee.deletedOn).toLocaleString()}
          `;
          document.querySelector('.profile-content').insertBefore(deleteInfo, document.querySelector('.profile-content').firstChild);
        }

        // Set notes
        const notesTextarea = document.getElementById('profileNotes');
        if (notesTextarea) {
          notesTextarea.value = trainee.notes || '';
          if (isDeleted) {
            notesTextarea.disabled = true;
            notesTextarea.style.opacity = '0.7';
          }
        }
        
        // Safely set each element, checking for existence first
        const elements = {
          'profileName': `<span class="rank-badge ${currentRank.id}">${currentRank.abbr}</span> FEDERAL INVESTIGATION BUREAU<br><span style="font-size: 16px; opacity: 0.8; font-weight: normal;">${currentRank.name === 'SPECIAL AGENT' ? 'Special Agent' : currentRank.name === 'AGENT' ? 'Agent' : currentRank.name}</span> ${trainee.name}`,
          'profileName2': trainee.name || 'Not Set',
          'profileRank': currentRank.name
        };

        // Set non-editable elements
        Object.entries(elements).forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = value;
          } else {
            console.warn(`Element ${id} not found`);
          }
        });

        // Set editable elements
        const editableElements = {
          'profileCallsign': { field: 'callsign', value: trainee.callsign || 'Not Set' },
          'profileCodename': { field: 'codename', value: trainee.codename || 'Not Set' },
          'profileUC': { field: 'ucAlias', value: trainee.ucAlias || 'Not Set' },
          'profileHandler': { field: 'handler', value: trainee.handler || 'Not Assigned' },
          'profileJoinDate': { field: 'joinDate', value: trainee.joinDate ? new Date(trainee.joinDate).toLocaleDateString() : new Date().toLocaleDateString() }
        };

        Object.entries(editableElements).forEach(([id, { field, value }]) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value;
            if (!isDeleted) {
              element.style.cursor = 'pointer';
              element.onclick = () => makeFieldEditable(element, trainee, field);
            }
          } else {
            console.warn(`Element ${id} not found`);
          }
        });

        // Show specialities as badges
        const specDiv = document.getElementById('profileSpeciality');
        if (specDiv) {
          specDiv.innerHTML = '';
          if (trainee.departments && trainee.departments.length > 0) {
            const specBadges = document.createElement('div');
            specBadges.className = 'dept-badges';
            trainee.departments.forEach(deptId => {
              const badge = document.createElement('div');
              badge.className = `dept-badge ${deptId}`;
              const dept = departments.find(d => d.id === deptId);
              badge.textContent = dept ? dept.abbr : deptId.toUpperCase();
              specBadges.appendChild(badge);
            });
            specDiv.appendChild(specBadges);
          } else {
            specDiv.textContent = 'Not Assigned';
          }
        }

        // Show divisions as badges
        const divDiv = document.getElementById('profileDivision');
        if (divDiv) {
          divDiv.innerHTML = '';
          if (trainee.divisions && trainee.divisions.length > 0) {
            const divBadges = document.createElement('div');
            divBadges.className = 'dept-badges';
            divBadges.style.display = 'flex';
            divBadges.style.flexWrap = 'wrap';
            divBadges.style.gap = '4px';
            divBadges.style.marginTop = '4px';
            trainee.divisions.forEach(divId => {
              const badge = document.createElement('div');
              badge.className = `div-badge ${divId}`;
              const div = divisions.find(d => d.id === divId);
              badge.textContent = div ? div.abbr : divId.toUpperCase();
              divBadges.appendChild(badge);
            });
            divDiv.appendChild(divBadges);
          } else {
            divDiv.textContent = 'Not Assigned';
          }
        }

        // Calculate and show training status
        const skills = [
          '10Codes', 'CaseLaws', 'Pursuit', 'Hostage', 'TrafficStop', 
          'CloseQuartersBreaching', 'OpenAreaBreaching', 'SceneControl', 'COMMS', 'UseOfForce', 
          'FilingCharges', 'Reports', 'Gunfight', 'UndercoverTraining', 'HelicopterLicense',
          'AmmunationSceneCommand', 'BankHeistSceneCommand', 'PITManeuverTraining'
        ];

        if (trainee.skills) {
          const completedSkills = skills.filter(skill => 
            trainee.skills[skill] && trainee.skills[skill].completed
          ).length;
          const totalSkills = skills.length;
          const progress = Math.round((completedSkills / totalSkills) * 100);
          
          const status = progress === 100 
            ? '<span style="color: #22c55e">Training Complete ✓</span>'
            : `<span style="color: #9ca3af">In Training (${progress}%)</span>`;
          
          const statusElement = document.getElementById('profileStatus');
          if (statusElement) {
            statusElement.innerHTML = status;
          }

          // Set certificates
          const certificates = document.getElementById('profileCertificates');
          if (certificates) {
            certificates.innerHTML = '';
            skills.forEach(skill => {
              if (trainee.skills[skill] && trainee.skills[skill].completed) {
                const badge = document.createElement('div');
                badge.className = 'certificate-badge';
                badge.textContent = skill.replace(/([A-Z])/g, ' $1').trim();
                certificates.appendChild(badge);
              }
            });
          }
        }

        // Make all fields non-editable for deleted trainees
        if (isDeleted) {
          // Only disable click handlers inside the profile content, not the close button
          document.querySelectorAll('.profile-content [onclick]:not(.close-btn)').forEach(el => {
            el.onclick = null;
            el.style.cursor = 'default';
          });
          
          // Ensure close button works for deleted trainees
          const closeBtn = document.querySelector('.close-btn');
          if (closeBtn) {
            closeBtn.onclick = closeProfile;
          }
        }

        // Set record (strikes and commendations)
        const setupRecordSection = (type) => {
          const records = trainee[type + 's'] || [];
          const div = document.getElementById(`profile${type.charAt(0).toUpperCase() + type.slice(1)}`);
          if (!div) return;

          div.innerHTML = '';
          const wrapper = document.createElement('div');
          wrapper.style.display = 'flex';
          wrapper.style.alignItems = 'flex-start';
          wrapper.style.gap = '8px';
          
          const text = document.createElement('div');
          text.className = `profile-${type}`;
          text.style.flex = '1';
          
          if (records.length > 0) {
            const list = document.createElement('div');
            list.style.display = 'flex';
            list.style.flexDirection = 'column';
            list.style.gap = '8px';
            
            records.forEach(record => {
              if (typeof record === 'string' && record.includes('by')) {
                const [content, agent] = record.split(' (by ');
                const recordDiv = document.createElement('div');
                recordDiv.style.background = 'rgba(0, 0, 0, 0.3)';
                recordDiv.style.padding = '8px';
                recordDiv.style.borderRadius = '4px';
                recordDiv.style.cursor = 'pointer';
                recordDiv.onclick = () => showRecordDetails(record, type.charAt(0).toUpperCase() + type.slice(1));
                
                const contentDiv = document.createElement('div');
                contentDiv.style.marginBottom = '4px';
                contentDiv.textContent = content;
                
                const agentDiv = document.createElement('div');
                agentDiv.style.fontSize = '11px';
                agentDiv.style.color = '#9ca3af';
                agentDiv.textContent = `by ${agent.replace(')', '')}`;
                
                recordDiv.appendChild(contentDiv);
                recordDiv.appendChild(agentDiv);
                list.appendChild(recordDiv);
              }
            });
            text.appendChild(list);
          } else {
            text.textContent = 'No ' + type + 's on record';
          }
          wrapper.appendChild(text);
          
          const addBtn = document.createElement('button');
          addBtn.className = 'dept-btn';
          addBtn.textContent = '+';
          addBtn.onclick = () => showStrikeForm(trainee, type);
          wrapper.appendChild(addBtn);
          div.appendChild(wrapper);
        };

        setupRecordSection('strikes');
        setupRecordSection('commendations');

        // Set timeline
        const timeline = document.getElementById('profileTimeline');
        if (timeline) {
          timeline.innerHTML = '';
          const events = [];

          // Add skill completions to timeline
          if (trainee.skills) {
            skills.forEach(skill => {
              const data = trainee.skills[skill];
              if (data && data.completed && data.completedDate) {
                events.push({
                  date: new Date(data.completedDate),
                  content: `Completed ${skill.replace(/([A-Z])/g, ' $1').trim()} Training`,
                  instructor: data.instructor
                });
              }
            });
          }

          // Add custom timeline events
          if (trainee.timeline) {
            trainee.timeline.forEach(event => {
              if (event.date) {
                events.push({
                  date: new Date(event.date),
                  content: event.content,
                  instructor: event.instructor
                });
              }
            });
          }

          // Sort events by date (newest first)
          events.sort((a, b) => b.date - a.date);

          events.forEach(event => {
            const item = document.createElement('li');
            item.className = 'timeline-item';
            
            const date = document.createElement('div');
            date.className = 'timeline-date';
            date.textContent = event.date.toLocaleDateString();
            
            const content = document.createElement('div');
            content.className = 'timeline-content';
            content.textContent = event.content;
            
            const instructor = document.createElement('div');
            instructor.className = 'timeline-instructor';
            instructor.textContent = `Signed by ${event.instructor}`;
            
            item.appendChild(date);
            item.appendChild(content);
            item.appendChild(instructor);
            timeline.appendChild(item);
          });
        }

        // Remove any existing delete buttons
        const existingDeleteSections = document.querySelectorAll('.profile-content > div[style*="margin-top: 32px"]');
        existingDeleteSections.forEach(section => section.remove());

        // Add delete button at the bottom of the profile (only for non-deleted trainees)
        if (!isDeleted) {
          const deleteSection = document.createElement('div');
          deleteSection.style.marginTop = '32px';
          deleteSection.style.borderTop = '1px solid rgba(255, 255, 255, 0.1)';
          deleteSection.style.paddingTop = '16px';
          deleteSection.style.textAlign = 'center';

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'password-dialog-btn';
          deleteBtn.style.background = '#ef4444';
          deleteBtn.style.color = '#fff';
          deleteBtn.style.padding = '8px 16px';
          deleteBtn.textContent = 'DELETE TRAINEE';
          deleteBtn.onclick = () => showSecureDeleteDialog(trainee);
          
          deleteSection.appendChild(deleteBtn);
          document.querySelector('.profile-content').appendChild(deleteSection);
        }

        modal.style.display = 'block';
      } catch (error) {
        console.error('Error showing profile:', error);
      }
    }
    
    function closeProfile() {
      document.getElementById('profileModal').style.display = 'none';
    }
    
    async function handleProfilePictureUrl(url, trainee) {
      if (!url) return;

      try {
        // Validate URL
        const urlInput = document.getElementById('pictureUrl');
        // Allow both direct image URLs and kappa.lol URLs
        if (!url.match(/^https?:\/\/(.*\.(jpg|jpeg|png|gif|webp)|kappa\.lol\/[a-zA-Z0-9]+)(\?.*)?$/i)) {
          alert('Please enter a valid image URL (direct image URL or kappa.lol link)');
          return;
        }

        // Update trainee's profile picture in Firebase
        const updates = {};
        updates[`/trainees/${trainee.id}/profilePicture`] = url;
        
        await fbUpdate(fbRef(fbDatabase), updates);
        
        // Update UI
        document.querySelectorAll(`.profile-picture[data-trainee-id="${trainee.id}"]`).forEach(img => {
          img.src = url;
        });

        // Clear input
        urlInput.value = '';
        
      } catch (error) {
        console.error('Error setting profile picture:', error);
        alert('Failed to set profile picture. Please try again with a different URL.');
      }
    }

    async function updateNotes(event, trainee) {
      try {
        const notes = event.target.value.trim();
        
        // Update trainee's notes in Firebase
        const updates = {};
        updates[`/trainees/${trainee.id}/notes`] = notes;
        
        await fbUpdate(fbRef(fbDatabase), updates);
      } catch (error) {
        console.error('Error updating notes:', error);
        alert('Failed to save notes. Please try again.');
      }
    }

    function showNameHover(event, trainee) {
      if (!trainee.profilePicture) return;

      // Remove any existing hovers
      hideNameHover();

      const hoverDiv = document.createElement('div');
      hoverDiv.className = 'name-hover-picture';
      
      const img = document.createElement('img');
      img.src = trainee.profilePicture;
      img.alt = trainee.name;
      img.onerror = () => {
        img.src = 'https://kappa.lol/3qib3z'; // Default image if load fails
      };
      
      const rankBadge = document.createElement('div');
      rankBadge.className = `rank-badge ${trainee.rank || 'intern'}`;
      rankBadge.textContent = RANKS.find(r => r.id === trainee.rank)?.abbr || 'INT';
      
      const nameDiv = document.createElement('div');
      nameDiv.className = 'hover-name';
      nameDiv.textContent = trainee.name;

      const infoDiv = document.createElement('div');
      infoDiv.className = 'hover-info';
      infoDiv.appendChild(rankBadge);
      infoDiv.appendChild(nameDiv);
      
      hoverDiv.appendChild(img);
      hoverDiv.appendChild(infoDiv);
      document.body.appendChild(hoverDiv);

      // Position hover near the name but ensure it stays in viewport
      const rect = event.target.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      const viewportWidth = window.innerWidth;
      
      // Default position
      let top = rect.top + window.scrollY - 220;
      let left = rect.left + window.scrollX - 100;
      
      // Adjust if too close to edges
      if (top < 10) top = 10;
      if (top + 250 > viewportHeight) top = viewportHeight - 260;
      if (left < 10) left = 10;
      if (left + 200 > viewportWidth) left = viewportWidth - 210;
      
      hoverDiv.style.top = top + 'px';
      hoverDiv.style.left = left + 'px';
      hoverDiv.style.display = 'block';
      
      // Add fade-in animation
      requestAnimationFrame(() => {
        hoverDiv.style.opacity = '1';
      });
    }

    function hideNameHover() {
      const hovers = document.querySelectorAll('.name-hover-picture');
      hovers.forEach(hover => hover.remove());
    }

    function showDeptSkillsDialog(trainee, skills) {
      const skillsList = skills.map(skill => {
        const data = trainee.skills[skill];
        return `${skill} Speciality: ${data.completed ? '✓' : '✗'}${data.completed ? ` (${data.instructor})` : ''}`;
      }).join('\n');

      const selectedSkill = prompt(`Select a department to toggle for ${trainee.name}:\n\n${skillsList}\n\nType the department name exactly as shown (e.g. "Supernatural"):`);
      
      if (!selectedSkill) return;
      
      const skill = skills.find(s => s.toLowerCase() === selectedSkill.toLowerCase());
      if (!skill) {
        alert('Invalid department name. Please try again.');
        return;
      }
      
      if (trainee.skills[skill].completed) {
        if (confirm(`Remove ${skill} Speciality assignment?`)) {
          trainee.skills[skill].completed = false;
          trainee.skills[skill].instructor = '';
              saveTrainees();
              updateTrainingTable();
        }
      } else {
        const instructor = prompt(`Enter instructor name for ${skill} Speciality assignment:`);
        if (instructor) {
          trainee.skills[skill].completed = true;
          trainee.skills[skill].instructor = instructor;
              saveTrainees();
              updateTrainingTable();
        }
      }
    }
    // Training Procedures Functions
      async function initializeTrainingProcedures() {
      const container = document.getElementById('trainingProceduresContainer');
      if (!container) return;
      
      container.innerHTML = ''; // Clear existing content
      
      if (!window.trainingModules) {
        await window.initializeModules();
      }
      
      // Create the module elements
      window.trainingModules.forEach(module => {
        const moduleDiv = document.createElement('div');
        moduleDiv.className = 'training-module';
        moduleDiv.id = `module-${module.id}`;
        
        const header = document.createElement('div');
        header.className = 'training-module-header';
        header.onclick = () => toggleTrainingModule(module.id);
        header.innerHTML = `
          ${module.title}
          <span class="toggle-icon">▼</span>
        `;
        
        const content = document.createElement('div');
        content.className = 'training-module-content';
        content.id = `module-content-${module.id}`;
        content.style.display = 'none';
        content.style.position = 'relative';

        // Edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-module-btn';
        editBtn.title = 'Edit Module';
        editBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
        `;
        editBtn.style.position = 'absolute';
        editBtn.style.top = '12px';
        editBtn.style.right = '12px';
        editBtn.onclick = (e) => {
          e.stopPropagation();
          window.editTrainingModule(module.id);
        };
        content.appendChild(editBtn);
        
        // Goal section
        const goalSection = document.createElement('div');
        goalSection.className = 'training-module-section';
        goalSection.innerHTML = `
          <h4>Goal</h4>
          <p>${module.content.goal}</p>
        `;
        
        // Setup section
        const setupSection = document.createElement('div');
        setupSection.className = 'training-module-section';
        setupSection.innerHTML = `
          <h4>Setup</h4>
          <p>${module.content.setup}</p>
        `;
        
        // Pass criteria section
        const passSection = document.createElement('div');
        passSection.className = 'training-module-section';
        passSection.innerHTML = `
          <h4>Pass if</h4>
          <p>${module.content.pass}</p>
        `;
        
        // Key tip section
        const tipSection = document.createElement('div');
        tipSection.className = 'training-module-section';
        tipSection.innerHTML = `
          <h4>Key tip</h4>
          <p>${module.content.tip}</p>
        `;
        
        content.appendChild(goalSection);
        content.appendChild(setupSection);
        content.appendChild(passSection);
        content.appendChild(tipSection);
        
        moduleDiv.appendChild(header);
        moduleDiv.appendChild(content);
        container.appendChild(moduleDiv);
      });
    }

    async function toggleTrainingProcedures() {
      const section = document.querySelector('.training-procedures');
      const container = document.getElementById('trainingProceduresContainer');
      const icon = section.querySelector('.toggle-icon');
      
      if (container.style.display === 'none') {
        container.style.display = 'block';
        section.classList.add('expanded');
        icon.style.transform = 'rotate(180deg)';
        
        // Initialize content if it's empty
        if (container.children.length === 0) {
          await initializeTrainingProcedures();
        }
      } else {
        container.style.display = 'none';
        section.classList.remove('expanded');
        icon.style.transform = 'rotate(0deg)';
      }
    }

    function toggleTrainingModule(moduleId) {
      const content = document.getElementById(`module-content-${moduleId}`);
      const icon = document.querySelector(`#module-${moduleId} .toggle-icon`);
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }

    // Load training modules from Firebase
    window.loadTrainingModules = async function() {
      try {
        // Always start with default modules to ensure all required modules exist
        window.trainingModules = [...window.defaultModules];

        const snapshot = await window.fbGet(window.fbRef(window.fbDatabase, 'trainingModules'));
        if (snapshot.exists()) {
          // Merge existing modules with defaults to ensure all new modules are included
          const existingModules = Object.values(snapshot.val());
          existingModules.forEach(existingModule => {
            const index = window.trainingModules.findIndex(m => m.id === existingModule.id);
            if (index !== -1) {
              window.trainingModules[index] = existingModule;
            }
          });
        }
        
        // Save the merged modules back to Firebase
        await saveTrainingModules();
        
        // Initialize the procedures display
        await initializeTrainingProcedures();
      } catch (error) {
        console.error('Error loading training modules:', error);
        // Fallback to default modules if there's an error
        window.trainingModules = [...window.defaultModules];
        await initializeTrainingProcedures();
      }
    }

    // Save training modules to Firebase
    window.saveTrainingModules = async function() {
      try {
        if (!window.trainingModules || !Array.isArray(window.trainingModules)) {
          console.error('Invalid training modules data');
          return;
        }

        const updates = {};
        window.trainingModules.forEach(module => {
          if (module && module.id) {
            updates[`/trainingModules/${module.id}`] = module;
          }
        });

        if (Object.keys(updates).length > 0) {
          await window.fbUpdate(window.fbRef(window.fbDatabase), updates);
          console.log('Training modules saved successfully');
        }
      } catch (error) {
        console.error('Error saving training modules:', error);
        throw error; // Re-throw to handle in calling function
      }
    }

    // Edit training module
    window.editTrainingModule = async function(moduleId) {
      const module = window.trainingModules.find(m => m.id === moduleId);
      if (!module) return;

      const title = prompt('Enter new title:', module.title);
      if (!title) return;

      const goal = prompt('Enter new goal:', module.content.goal);
      if (!goal) return;

      const setup = prompt('Enter new setup:', module.content.setup);
      if (!setup) return;

      const pass = prompt('Enter new pass criteria:', module.content.pass);
      if (!pass) return;

      const tip = prompt('Enter new tip:', module.content.tip);
      if (!tip) return;

      module.title = title;
      module.content = {
        goal,
        setup,
        pass,
        tip
      };

      await saveTrainingModules();
      await initializeTrainingProcedures();
    }

    // Define default modules globally
    window.defaultModules = [
        {
          id: '10codes',
          title: '10 Codes',
          content: {
            goal: 'Learn and use radio codes.',
            setup: 'Instructor calls out scenarios.',
            pass: 'Quick, accurate code responses.',
            tip: 'Start with common codes first.'
          }
        },
        {
          id: 'ammunation',
          title: 'Ammunation Scene Command',
          content: {
            goal: 'Control active shooter scene.',
            setup: 'Multiple threats in store layout.',
            pass: 'Quick response, civilian safety, threat neutralization.',
            tip: 'First 5 minutes are critical.'
          }
        },
        {
          id: 'bankheist',
          title: 'Bank Heist Scene Command',
          content: {
            goal: 'Manage complex robbery response.',
            setup: 'Multiple suspects, hostages, entry points.',
            pass: 'Perimeter control, negotiation, tactical resolution.',
            tip: 'Control outer perimeter first.'
          }
        },
        {
          id: 'caselaws',
          title: 'Case Laws',
          content: {
            goal: 'Understand key legal precedents.',
            setup: 'Review major cases and discuss.',
            pass: 'Can explain case impact on procedures.',
            tip: 'Focus on practical applications.'
          }
        },
        {
          id: 'casemanagement',
          title: 'Case Management',
          content: {
            goal: 'Structure and maintain active investigations professionally.',
            setup: 'Provide a half-complete case file.',
            pass: 'The case file is clear, chronological, and labeled. They add next actionable step.',
            tip: 'If someone else opens your case tomorrow, they should instantly understand it.'
          }
        },
        {
          id: 'closequarters',
          title: 'Close Quarters Breaching',
          content: {
            goal: 'Clear rooms and buildings safely.',
            setup: 'Multi-room scenario with threats.',
            pass: 'Methodical clearing, good angles, team coordination.',
            tip: 'Slow is smooth, smooth is fast.'
          }
        },
        {
          id: 'comms',
          title: 'COMMS',
          content: {
            goal: 'Clear radio communication.',
            setup: 'High-stress scenario requiring updates.',
            pass: 'Clear, concise, complete transmissions.',
            tip: 'Think before you speak.'
          }
        },
        {
          id: 'deepuc',
          title: 'Deep UC Work',
          content: {
            goal: 'Long-term undercover operation management.',
            setup: 'Build cover story and maintain over time.',
            pass: 'Keeps character consistent, manages stress, relays intel safely.',
            tip: 'Your cover story is your shield.'
          }
        },
        {
          id: 'evidence',
          title: 'Evidence Handling',
          content: {
            goal: 'Proper evidence collection and chain of custody.',
            setup: 'Process complex scene with multiple evidence types.',
            pass: 'Correct collection, packaging, and documentation.',
            tip: 'If in doubt, document more.'
          }
        },
        {
          id: 'filing',
          title: 'Filing Charges',
          content: {
            goal: 'Correctly input and justify charges.',
            setup: 'Give an arrest scenario with 3-4 offenses.',
            pass: 'Each charge matches evidence and is formatted properly.',
            tip: 'Overcharging = fail.'
          }
        },
        {
          id: 'gunfight',
          title: 'Gunfight',
          content: {
            goal: 'Proper cover, crossfire, and comms.',
            setup: 'Simulate an ambush with 2 hostiles.',
            pass: 'Takes cover, returns fire, communicates locations.',
            tip: 'Don\'t peek twice from same angle.'
          }
        },
        {
          id: 'helicopter',
          title: 'Helicopter License',
          content: {
            goal: 'Basic flight and pursuit tracking.',
            setup: 'Fly from base to city, hover above target, track a vehicle.',
            pass: 'Maintains smooth flight, steady altitude, and stable camera tracking.',
            tip: 'Altitude + distance = safety.'
          }
        },
        {
          id: 'hostage',
          title: 'Hostage',
          content: {
            goal: 'Negotiation under pressure.',
            setup: '1 hostage taker, 1 hostage. Trainee negotiates 3 demands.',
            pass: 'Maintains calm tone, stalls for time, keeps control.',
            tip: 'Never trade lives for money.'
          }
        },
        {
          id: 'interrogation',
          title: 'Interrogation Questioning',
          content: {
            goal: 'Train controlled, structured suspect interviews.',
            setup: 'Give the trainee a mock suspect (trainer plays the role). Scenario Example: A suspect denies being at a robbery scene.',
            pass: 'Trainee uses open questions, not leading ones. Maintains calm tone and documents responses. Detects inconsistencies without aggression.',
            tip: 'Don\'t fill silence. Let the suspect talk themselves into mistakes.'
          }
        },
        {
          id: 'longinvestigations',
          title: 'Long Term Investigations',
          content: {
            goal: 'Learn sustained intelligence and evidence management.',
            setup: 'Present a criminal organization with recurring activity.',
            pass: 'They create a solid investigation outline (3 suspects minimum). Knows when to escalate to warrant stage.',
            tip: 'Never burn an investigation early for small arrests.'
          }
        },
        {
          id: 'openarea',
          title: 'Open Area Breaching',
          content: {
            goal: 'Tactical approach on large compound.',
            setup: 'Multi-angle team movement on open site.',
            pass: 'Good spacing, callouts, use of cover.',
            tip: 'Don\'t group — move like chess pieces.'
          }
        },
        {
          id: 'pit',
          title: 'PIT Maneuver Training',
          content: {
            goal: 'Teach safe PIT execution.',
            setup: 'Controlled pursuit at 60–80 km/h.',
            pass: 'Executes PIT correctly, calls it in before performing.',
            tip: 'No blind PITs — always have clearance.'
          }
        },
        {
          id: 'pursuit',
          title: 'Pursuit',
          content: {
            goal: 'Evaluate control and radio during chase.',
            setup: 'Instructor drives suspect car.',
            pass: 'Clear comms, proper callouts, controlled turns.',
            tip: 'Lose sight > lose safety, disengage smartly.'
          }
        },
        {
          id: 'reports',
          title: 'Reports',
          content: {
            goal: 'Professional, factual reporting.',
            setup: 'Give scene notes; trainee writes a brief report.',
            pass: 'Spelling, structure, and detail are accurate.',
            tip: 'Write as if a judge will read it.'
          }
        },
        {
          id: 'scenecontrol',
          title: 'Scene Control',
          content: {
            goal: 'Manage chaotic multi-unit scene.',
            setup: 'Random civilians, media, multiple officers.',
            pass: 'Establishes perimeter, delegates roles, stays calm.',
            tip: 'Loud voice ≠ leadership — clarity does.'
          }
        },
        {
          id: 'shortinvestigations',
          title: 'Short Term Investigations',
          content: {
            goal: 'Teach quick turnaround intel work for active crimes.',
            setup: 'Provide 3 clues (vehicle plate, CCTV, description).',
            pass: 'Logical order of investigation steps. Clear communication of findings.',
            tip: 'Always verify info before broadcasting it.'
          }
        },
        {
          id: 'statements',
          title: 'Statement Gaining',
          content: {
            goal: 'Train how to extract clear and admissible statements.',
            setup: 'Civillian or officer involved in a crime as a witness.',
            pass: 'Statement includes time, location, actions, ID details. Language is quoted accurately.',
            tip: 'Write exactly what they said — don\'t interpret it.'
          }
        },
        {
          id: 'surveillance',
          title: 'Surveillance',
          content: {
            goal: 'Teach silent observation and data logging.',
            setup: 'One suspect vehicle or location under watch.',
            pass: 'No tail exposure or unnecessary radio chatter. Logs times, movements, and persons.',
            tip: 'Distance and patience win — not proximity.'
          }
        },
        {
          id: 'traffic',
          title: 'Traffic Stop',
          content: {
            goal: 'Conduct safe and lawful vehicle stop.',
            setup: 'Random vehicle, unknown risk.',
            pass: 'Proper positioning, approach, ID check, and closure.',
            tip: 'Always call plate before approach.'
          }
        },
        {
          id: 'undercover',
          title: 'Deep Undercover Work',
          content: {
            goal: 'Teach full immersion and identity discipline.',
            setup: 'Provide undercover alias, fake backstory, and a meet with a "criminal contact."',
            pass: 'Trainee stays in character and recalls their alias details. Keeps radio use subtle or non-verbal.',
            tip: 'Think like a criminal, report like an agent.'
          }
        },
        {
          id: 'useofforce',
          title: 'Use of Force',
          content: {
            goal: 'Correct escalation/de-escalation.',
            setup: 'Angry suspect escalating verbally.',
            pass: 'Uses verbal, then less-lethal, then lethal only if justified.',
            tip: 'Force must always be proportional.'
          }
        },
        {
          id: 'warrants',
          title: 'Warrant Writing',
          content: {
            goal: 'Teach professional and legally sound warrant preparation.',
            setup: 'Give trainee probable cause info (intel, statements, CCTV).',
            pass: 'Justification is clear, concise, and lawful. Spelling, layout, and reasoning meet FIB standards.',
            tip: 'Judges approve confidence, not chaos — write like you already have proof.'
          }
        },
        {
          id: 'ammunation',
          title: 'Ammunation Scene Command',
          content: {
            goal: 'Simulate armed suspect inside Ammunation.',
            setup: 'Trainee leads perimeter setup, negotiates or plans breach.',
            pass: 'Communicates roles clearly and ensures civilian safety.',
            tip: 'Use LEO voice, don\'t rush breach.'
          }
        },
        {
          id: 'bankheist',
          title: 'Bank Heist Scene Command',
          content: {
            goal: 'Test large-scale coordination.',
            setup: '4 suspects, 2 hostages. Trainee acts as scene commander.',
            pass: 'They issue clear radio updates, form outer/inner cordon, and keep control.',
            tip: 'Prioritize hostage life, not kills.'
          }
        },
        {
          id: 'comms',
          title: 'COMMS',
          content: {
            goal: 'Master clear, concise radio structure.',
            setup: 'Run 3 short pursuit updates or code-6 checks.',
            pass: 'Uses proper call signs, keeps radio short & factual.',
            tip: 'No "uh" or "yeah" — use confirmations.'
          }
        },
        {
          id: 'caselaws',
          title: 'Case Laws',
          content: {
            goal: 'Confirm understanding of legal rights.',
            setup: 'Ask 5 random quickfire questions ("Can you detain for suspicion?" etc).',
            pass: 'Answers confidently & gives amendment or reasoning.',
            tip: 'They should know why, not just what.'
          }
        },
        {
          id: 'cqb',
          title: 'Close Quarters Breaching',
          content: {
            goal: 'Teach safe team entry & comms.',
            setup: '2-3 rooms with suspects. Use sim-rounds or verbal roleplay.',
            pass: 'Stack formed, callouts ("Left clear") used, no friendly fire.',
            tip: 'Slice the pie, don\'t rush corners.'
          }
        },
        {
          id: 'filing',
          title: 'Filing Charges',
          content: {
            goal: 'Correctly input and justify charges.',
            setup: 'Give an arrest scenario with 3-4 offenses.',
            pass: 'Each charge matches evidence and is formatted properly.',
            tip: 'Overcharging = fail.'
          }
        },
        {
          id: 'gunfight',
          title: 'Gunfight',
          content: {
            goal: 'Proper cover, crossfire, and comms.',
            setup: 'Simulate an ambush with 2 hostiles.',
            pass: 'Takes cover, returns fire, communicates locations.',
            tip: 'Don\'t peek twice from same angle.'
          }
        },
        {
          id: 'helicopter',
          title: 'Helicopter License',
          content: {
            goal: 'Basic flight and pursuit tracking.',
            setup: 'Fly from base to city, hover above target, track a vehicle.',
            pass: 'Maintains smooth flight, steady altitude, and stable camera tracking.',
            tip: 'Altitude + distance = safety.'
          }
        },
        {
          id: 'hostage',
          title: 'Hostage',
          content: {
            goal: 'Negotiation under pressure.',
            setup: '1 hostage taker, 1 hostage. Trainee negotiates 3 demands.',
            pass: 'Maintains calm tone, stalls for time, keeps control.',
            tip: 'Never trade lives for money.'
          }
        },
        {
          id: 'openarea',
          title: 'Open Area Breaching',
          content: {
            goal: 'Tactical approach on large compound.',
            setup: 'Multi-angle team movement on open site.',
            pass: 'Good spacing, callouts, use of cover.',
            tip: 'Don\'t group — move like chess pieces.'
          }
        },
        {
          id: 'pit',
          title: 'PIT Maneuver Training',
          content: {
            goal: 'Teach safe PIT execution.',
            setup: 'Controlled pursuit at 60–80 km/h.',
            pass: 'Executes PIT correctly, calls it in before performing.',
            tip: 'No blind PITs — always have clearance.'
          }
        },
        {
          id: 'pursuit',
          title: 'Pursuit',
          content: {
            goal: 'Evaluate control and radio during chase.',
            setup: 'Instructor drives suspect car.',
            pass: 'Clear comms, proper callouts, controlled turns.',
            tip: 'Lose sight > lose safety, disengage smartly.'
          }
        },
        {
          id: 'reports',
          title: 'Reports',
          content: {
            goal: 'Professional, factual reporting.',
            setup: 'Give scene notes; trainee writes a brief report.',
            pass: 'Spelling, structure, and detail are accurate.',
            tip: 'Write as if a judge will read it.'
          }
        },
        {
          id: 'scenecontrol',
          title: 'Scene Control',
          content: {
            goal: 'Manage chaotic multi-unit scene.',
            setup: 'Random civilians, media, multiple officers.',
            pass: 'Establishes perimeter, delegates roles, stays calm.',
            tip: 'Loud voice ≠ leadership — clarity does.'
          }
        },
        {
          id: 'traffic',
          title: 'Traffic Stop',
          content: {
            goal: 'Conduct safe and lawful vehicle stop.',
            setup: 'Random vehicle, unknown risk.',
            pass: 'Proper positioning, approach, ID check, and closure.',
            tip: 'Always call plate before approach.'
          }
        },
        {
          id: 'undercover',
          title: 'Undercover Training',
          content: {
            goal: 'Teach blending & intel gathering.',
            setup: 'Simple buy-bust or infiltration scenario.',
            pass: 'Keeps cover story, relays info quietly.',
            tip: 'Never reveal real name or badge.'
          }
        },
        {
          id: 'useofforce',
          title: 'Use of Force',
          content: {
            goal: 'Correct escalation/de-escalation.',
            setup: 'Angry suspect escalating verbally.',
            pass: 'Uses verbal, then less-lethal, then lethal only if justified.',
            tip: 'Force must always be proportional.'
          }
        },
        {
          id: 'interrogation',
          title: 'Interrogation',
          content: {
            goal: 'Master interview techniques and suspect psychology.',
            setup: 'Role-play interrogation with complex suspect story.',
            pass: 'Gets truthful information without coercion, documents properly.',
            tip: 'Watch for body language, control the room.'
          }
        },
        {
          id: 'shortinvestigations',
          title: 'Short Term Investigations',
          content: {
            goal: 'Handle immediate follow-up investigations.',
            setup: 'Process active crime scene and develop leads.',
            pass: 'Proper evidence collection, witness statements, quick follow-up.',
            tip: 'First 48 hours are critical.'
          }
        },
        {
          id: 'longinvestigations',
          title: 'Long Term Investigations',
          content: {
            goal: 'Manage complex, multi-week investigations.',
            setup: 'Build case file on ongoing criminal enterprise.',
            pass: 'Maintains organized timeline, connects evidence threads.',
            tip: 'Document everything - memory fades.'
          }
        },
        {
          id: 'surveillance',
          title: 'Surveillance',
          content: {
            goal: 'Conduct covert observation without detection.',
            setup: 'Track target through city without being made.',
            pass: 'Maintains visual while staying undetected.',
            tip: 'Blend in, look boring.'
          }
        },
        {
          id: 'deepuc',
          title: 'Deep UC Work',
          content: {
            goal: 'Long-term undercover operation management.',
            setup: 'Build cover story and maintain over time.',
            pass: 'Keeps character consistent, manages stress, relays intel safely.',
            tip: 'Your cover story is your shield.'
          }
        },
        {
          id: 'casemanagement',
          title: 'Case Management',
          content: {
            goal: 'Organize and track multiple active cases.',
            setup: 'Handle 3+ simultaneous investigations.',
            pass: 'Maintains clear files, meets deadlines, proper handoffs.',
            tip: 'System beats memory every time.'
          }
        },
        {
          id: 'statements',
          title: 'Statement Gaining',
          content: {
            goal: 'Obtain detailed witness/victim statements.',
            setup: 'Interview traumatized/reluctant witness.',
            pass: 'Gets key details while maintaining witness comfort.',
            tip: 'Listen more than you talk.'
          }
        },
        {
          id: 'evidence',
          title: 'Evidence Handling',
          content: {
            goal: 'Proper evidence collection and chain of custody.',
            setup: 'Process complex scene with multiple evidence types.',
            pass: 'Correct collection, packaging, and documentation.',
            tip: 'If in doubt, document more.'
          }
        },
        {
          id: 'warrants',
          title: 'Warrant Writing',
          content: {
            goal: 'Draft clear, legally sound warrants.',
            setup: 'Write search warrant for complex location.',
            pass: 'Clear probable cause, specific scope, proper format.',
            tip: 'Be specific but comprehensive.'
          }
        }
      ];

      // Initialize modules from Firebase or defaults
      window.initializeModules = async function() {
        try {
          const modulesSnapshot = await window.fbGet(window.fbRef(window.fbDatabase, 'trainingModules'));
          if (modulesSnapshot.exists()) {
            window.trainingModules = Object.values(modulesSnapshot.val());
          } else {
            window.trainingModules = [...window.defaultModules];
            // Save default modules to Firebase
            const updates = {};
            window.defaultModules.forEach(module => {
              updates[`/trainingModules/${module.id}`] = module;
            });
            await window.fbUpdate(window.fbRef(window.fbDatabase), updates);
          }
        } catch (error) {
          console.error('Error loading training modules:', error);
          window.trainingModules = [...window.defaultModules];
        }
      };

      // Initialize Firebase when the page loads
      window.addEventListener('load', async () => {
        await initializeFirebase();
        await window.initializeModules();
      });

    </script>

    <!-- Embedded trainee data -->
    <script id="traineeData" type="application/json">[]</script>
    </body>
    </html>
