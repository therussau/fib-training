    <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FIB Training Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script type="module">
      // Initialize Firebase immediately
      let fbApp, fbDatabase, fbRef, fbSet, fbOnValue, fbUpdate;

      async function initializeFirebase() {
        try {
          const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
          const { getDatabase, ref, set, onValue, update } = 
            await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
          const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js");

          const firebaseConfig = {
            apiKey: "AIzaSyC8MXihU-0-FRkYwx0qrs_Sv4CKZCVgFUs",
            authDomain: "fib-training-tracker.firebaseapp.com",
            projectId: "fib-training-tracker",
            storageBucket: "fib-training-tracker.appspot.com",
            messagingSenderId: "1086248091161",
            appId: "1:1086248091161:web:6e74e452d665123e88f488",
            measurementId: "G-ZHPFZNV4WZ",
            databaseURL: "https://fib-training-tracker-default-rtdb.firebaseio.com"
          };

          // Initialize Firebase
          fbApp = initializeApp(firebaseConfig);
          fbDatabase = getDatabase(fbApp);
          fbRef = ref;
          fbSet = set;
          fbOnValue = onValue;
          fbUpdate = update;

          // Make functions available globally
          window.fbDatabase = fbDatabase;
          window.fbRef = fbRef;
          window.fbSet = fbSet;
          window.fbOnValue = fbOnValue;
          window.fbUpdate = fbUpdate;

          return true;
        } catch (error) {
          console.error('Firebase initialization error:', error);
          showDatabaseError('Failed to initialize database. Please refresh the page.');
          return false;
        }
      }

      // Initialize Firebase immediately and then start the app
      document.addEventListener('DOMContentLoaded', async () => {
        // Disable interface until we confirm connection
        disableInterface();
        
        const initialized = await initializeFirebase();
        if (!initialized) {
          showDatabaseError('Database initialization failed. Please refresh the page.');
          return;
        }

        // Set up connection monitoring
        const connectedRef = fbRef(fbDatabase, '.info/connected');
        fbOnValue(connectedRef, (snap) => {
          const connected = snap.val() === true;
          console.log('Connection state:', connected ? 'connected' : 'disconnected');
          
          if (connected) {
            enableInterface();
            loadTrainees(); // Load data when connected
          } else {
            showDatabaseError('Lost connection to database. Please check your internet connection.');
          }
        }, (error) => {
          console.error('Connection monitoring error:', error);
          showDatabaseError('Unable to monitor database connection. Please refresh the page.');
        });
      });
    </script>
    <style>
      :root { color-scheme: dark; }
      * { box-sizing: border-box; }
      body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0b0f; color:#fff; }

  .wrap { max-width: 1400px; margin: 0 auto; padding: 24px; }

  .toolbar {
    position: sticky; top: 0; z-index: 50;
    display:flex; flex-direction: column; gap:16px; margin-bottom:24px;
    padding: 10px 0 14px 0; background: #0b0b0f;
    border-bottom: 1px solid rgba(255,255,255,.08);
    transition: all 0.3s ease;
  }
  .toolbar.collapsed {
    padding: 8px 0;
  }
  .toolbar.collapsed .brand img {
    height: 48px;
  }
  .toolbar.collapsed h1 {
    font-size: 24px;
  }
  .collapse-btn {
    position: absolute;
    right: 20px;
    top: 20px;
    background: rgba(0,0,0,.3);
    color: #fde047;
    border: 2px solid #fde047;
    border-radius: 8px;
    padding: 7px 12px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background .15s, color .15s, border-color .15s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .collapse-btn:hover {
    background: rgba(253,224,71,.2);
    color: #fde047;
    border-color: #fde047;
  }
  .brand { display:flex; align-items:center; gap:12px; }
  .brand img { height: 128px; width:auto; border-radius:4px; }
  h1 { font-size:42px; font-weight:800; margin:0; letter-spacing:.02em; color: #fde047; font-family: 'Courier New', 'Monaco', 'Menlo', monospace; text-shadow: 0 0 10px rgba(253,224,71,.3); }

  /* Training Table Styles */
  .training-section {
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .training-section h2 {
    margin: 0 0 16px;
    font-size: 18px;
    font-weight: 700;
    color: #fde047;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
    text-shadow: 0 0 8px rgba(253,224,71,.2);
    border-bottom: 2px solid #fde047;
    padding-bottom: 8px;
  }

  .training-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 8px;
    background: transparent;
    margin-bottom: 20px;
  }

  .training-table tr {
    background: rgba(0,0,0,.3);
    border-radius: 8px;
    margin-bottom: 8px;
  }

  .training-table td:first-child {
    border-top-left-radius: 8px;
    border-bottom-left-radius: 8px;
  }

  .training-table td:last-child {
    border-top-right-radius: 8px;
    border-bottom-right-radius: 8px;
  }

  .training-table th {
    background: #fde047;
    color: #000;
    padding: 12px 8px;
    font-weight: 700;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
    text-align: left;
  }

  .training-table td {
    padding: 10px 8px;
    border-bottom: 1px solid rgba(255,255,255,.1);
    font-size: 13px;
    color: #fff;
  }

  .training-table tr:hover {
    background: rgba(253,224,71,.1);
  }

  /* Form Styles */
  .add-trainee-form {
    background: rgba(0,0,0,.3);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .form-title {
    color: #fde047;
    font-size: 16px;
    font-weight: 600;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ef4444;
    transition: background-color 0.3s ease;
  }

  .status-dot.connected {
    background: #22c55e;
  }

  .status-text {
    font-size: 12px;
    color: #9ca3af;
  }

  .form-row {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
  }

  .form-group {
    flex: 1;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    color: #fff;
    font-size: 14px;
  }

  .form-group input {
    width: 100%;
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 8px;
    padding: 8px 12px;
    color: #fff;
    font-size: 14px;
  }

  .save-btn {
    background: #fde047;
    color: #000;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .save-btn:hover {
    background: #fff;
  }

  /* Dialog Styles */
  .password-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.95);
    border: 2px solid #00ff00;
    border-radius: 8px;
    padding: 24px;
    min-width: 300px;
    z-index: 100001;
    display: none;
    box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
  }

  .password-dialog-title {
    color: #00ff00;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 16px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
  }

  .password-input {
    width: 100%;
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid #00ff00;
    border-radius: 4px;
    padding: 8px 12px;
    color: #00ff00;
    font-size: 14px;
    margin-bottom: 16px;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
    outline: none;
  }

  .password-dialog-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }

  .password-dialog-btn {
    background: rgba(0, 255, 0, 0.1);
    color: #00ff00;
    border: 1px solid #00ff00;
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
  }

  .password-dialog-btn:hover {
    background: rgba(0, 255, 0, 0.2);
  }

  .checkbox-cell {
    text-align: center;
    padding: 8px 4px !important;
  }

  .checkbox-cell input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }

  .instructor-row td {
    text-align: center;
    font-size: 11px;
    color: #fde047;
    padding: 4px !important;
    border-bottom: 2px solid rgba(255,255,255,.1) !important;
  }

  .section-header td {
    background: rgba(253,224,71,.1);
    color: #fde047;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 8px !important;
    text-align: center;
  }


  .instructor-row:hover {
    background: none !important;
  }


  /* Classified Entry Screen */
      .classified-entry {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #000000 0%, #0a0a0a 25%, #000000 50%, #0a0a0a 75%, #000000 100%);
        background-size: 400% 400%;
        animation: classifiedBg 8s ease-in-out infinite;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

  .classified-watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    height: auto;
    opacity: 0.15;
    z-index: 1;
    filter: drop-shadow(0 0 30px #00ff00);
    animation: watermarkPulse 3s ease-in-out infinite;
  }

  @keyframes watermarkPulse {
    0%, 100% { 
      opacity: 0.1;
      filter: drop-shadow(0 0 20px #00ff00);
      transform: translate(-50%, -50%) scale(1);
    }
    50% { 
      opacity: 0.2;
      filter: drop-shadow(0 0 40px #00ff00);
      transform: translate(-50%, -50%) scale(1.05);
    }
  }

  .password-dialog {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.95);
    border: 2px solid #00ff00;
    border-radius: 10px;
    padding: 20px;
    z-index: 10000;
    box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
    text-align: center;
    min-width: 300px;
  }

  .password-dialog-title {
    color: #00ff00;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
  }

  .password-input {
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid #00ff00;
    color: #00ff00;
    padding: 8px 12px;
    width: 100%;
    margin-bottom: 16px;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
    outline: none;
  }

  .password-input::placeholder {
    color: rgba(0, 255, 0, 0.5);
  }

  .password-dialog-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  .password-dialog-btn {
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid #00ff00;
    color: #00ff00;
    padding: 6px 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
  }

  .password-dialog-btn:hover {
    background: rgba(0, 255, 0, 0.2);
      }

      @keyframes classifiedBg {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
      }

    .classified-content {
      text-align: center;
      max-width: 800px;
      padding: 40px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #00ff00;
      border-radius: 10px;
      box-shadow: 
        0 0 30px rgba(0, 255, 0, 0.3),
        inset 0 0 30px rgba(0, 255, 0, 0.1);
      animation: classifiedGlow 2s ease-in-out infinite alternate;
      position: relative;
      z-index: 2;
    }

      @keyframes classifiedGlow {
        0% { box-shadow: 0 0 30px rgba(0, 255, 0, 0.3), inset 0 0 30px rgba(0, 255, 0, 0.1); }
        100% { box-shadow: 0 0 50px rgba(0, 255, 0, 0.5), inset 0 0 50px rgba(0, 255, 0, 0.2); }
  }

    .classified-logo {
      font-size: 72px;
      font-weight: 900;
      color: #00ff00;
      text-shadow: 0 0 20px #00ff00;
      font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
      letter-spacing: 8px;
      margin-bottom: 20px;
      animation: logoPulse 1.5s ease-in-out infinite;
      position: relative;
      z-index: 2;
    }

    @keyframes logoPulse {
      0%, 100% { transform: scale(1); text-shadow: 0 0 20px #00ff00; }
      50% { transform: scale(1.05); text-shadow: 0 0 30px #00ff00, 0 0 40px #00ff00; }
  }

      .classified-title {
        font-size: 24px;
        font-weight: 700;
        color: #ffffff;
        letter-spacing: 3px;
        margin-bottom: 10px;
        font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
      }

      .classified-subtitle {
        font-size: 16px;
        color: #00ff00;
        letter-spacing: 2px;
        margin-bottom: 40px;
        font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
      }

      .access-sequence {
        text-align: left;
        font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
        font-size: 14px;
        line-height: 1.8;
      }

      .access-line {
        margin-bottom: 8px;
        opacity: 0;
        animation: fadeInLine 0.5s ease-in forwards;
      }

      .access-line:nth-child(1) { animation-delay: 0.5s; }
      .access-line:nth-child(2) { animation-delay: 1s; }
      .access-line:nth-child(3) { animation-delay: 1.5s; }
      .access-line:nth-child(4) { animation-delay: 2s; }
      .access-line:nth-child(5) { animation-delay: 3.5s; }
      .access-line:nth-child(6) { animation-delay: 4s; }
      .access-line:nth-child(7) { animation-delay: 4.5s; }

      @keyframes fadeInLine {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
      }

      .prompt {
        color: #00ff00;
        font-weight: 600;
      }

      .password-display {
        color: #ff0000;
        font-weight: 700;
        letter-spacing: 2px;
      }

      .verification-status {
        color: #00ff00;
        font-weight: 700;
      }

      .access-status {
        color: #00ff00;
        font-weight: 700;
      }

      .welcome-message {
        color: #00ff00;
        font-weight: 700;
        font-size: 16px;
      }

  .delete-btn {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.4);
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .delete-btn:hover {
    background: rgba(239, 68, 68, 0.3);
  }


  /* Progress Bar Styles */
  .progress-cell {
    padding: 8px !important;
    position: relative;
  }

  .progress-bar {
    width: 100%;
    height: 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    cursor: pointer;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%);
    transition: width 0.3s ease;
    border-radius: 10px;
  }

  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    white-space: nowrap;
  }

  .progress-details {
    display: none;
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    padding: 12px;
    min-width: 200px;
    z-index: 100;
    font-size: 12px;
    color: #fff;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .progress-cell:hover .progress-details {
    display: block;
  }

  .progress-details ul {
    margin: 0;
    padding: 0 0 0 16px;
    list-style-type: none;
  }

  .progress-details li {
    margin: 4px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .progress-details li::before {
    content: '';
    display: block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-left: -16px;
  }

  .progress-details li.completed::before {
    background: #22c55e;
  }

  .progress-details li.pending::before {
    background: #ef4444;
  }

  /* Division Icons */
  .division-icon {
    width: 24px;
    height: 24px;
    margin-right: 8px;
    opacity: 0.8;
  }

  /* Animated Header */
  @keyframes headerPulse {
    0%, 100% { text-shadow: 0 0 10px rgba(253,224,71,.3); }
    50% { text-shadow: 0 0 20px rgba(253,224,71,.5); }
  }

  h1 {
    animation: headerPulse 2s ease-in-out infinite !important;
  }

  /* Clearance Tags */
  .clearance-tag {
      display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-left: 8px;
  }

  .clearance-tag.classified {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

  .clearance-tag.restricted {
    background: rgba(234, 179, 8, 0.2);
    color: #eab308;
    border: 1px solid rgba(234, 179, 8, 0.4);
  }

  .clearance-tag.public {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.4);
  }

  /* Rotating Seal */
  .fib-seal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    height: 400px;
    opacity: 0.03;
    pointer-events: none;
    animation: rotateSeal 60s linear infinite;
  }

  @keyframes rotateSeal {
    from { transform: translate(-50%, -50%) rotate(0deg); }
    to { transform: translate(-50%, -50%) rotate(360deg); }
  }

  /* Profile Modal */
  .profile-modal {
      display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    backdrop-filter: blur(4px);
  }

  .profile-content {
      position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    background: #0b0b0f;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    padding: 24px;
    overflow-y: auto;
  }

  .profile-header {
    display: flex;
      align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .profile-name {
    flex: 1;
    font-size: 24px;
    font-weight: 700;
      color: #fde047;
  }

  .profile-close {
    background: none;
    border: none;
    color: #fff;
    font-size: 24px;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s;
  }

  .profile-close:hover {
    opacity: 1;
  }

  .profile-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
  }

  .profile-section {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 16px;
  }

  .profile-section-title {
    font-size: 14px;
    font-weight: 600;
        color: #fde047; 
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .profile-info-list {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .profile-info-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .profile-info-item:last-child {
    border-bottom: none;
  }

  .profile-info-label {
    font-size: 12px;
    color: #9ca3af;
    min-width: 120px;
  }

  .profile-info-value {
    font-size: 13px;
    color: #fff;
  }

  .profile-timeline {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .timeline-item {
    position: relative;
    padding-left: 24px;
    padding-bottom: 16px;
    border-left: 2px solid rgba(255, 255, 255, 0.1);
  }

  .timeline-item:last-child {
    border-left: none;
  }

  .timeline-item::before {
    content: '';
    position: absolute;
    left: -5px;
    top: 0;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #fde047;
  }

  .timeline-date {
    font-size: 11px;
    color: #9ca3af;
    margin-bottom: 4px;
  }

  .timeline-content {
    font-size: 13px;
    color: #fff;
  }

  .timeline-instructor {
    font-size: 12px;
        color: #fde047;
    margin-top: 4px;
  }

  .profile-certificates {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  .certificate-badge {
    background: rgba(253, 224, 71, 0.1);
    border: 1px solid rgba(253, 224, 71, 0.2);
        border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
        color: #fde047;
        display: flex;
        align-items: center;
    gap: 8px;
  }

  .certificate-badge::before {
    content: '✓';
    font-weight: bold;
  }

  .profile-strikes {
        color: #ef4444;
  }

  .profile-commendations {
    color: #22c55e;
  }

  /* Department Styles */
  .dept-select-container {
    position: relative;
    display: inline-block;
  }

  .dept-select-btn {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.4);
    border-radius: 4px;
        padding: 4px 8px;
        font-size: 11px;
        cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .dept-select-btn:hover {
    background: rgba(34, 197, 94, 0.3);
  }

  .dept-select-btn::after {
    content: '▼';
    font-size: 8px;
  }

  .dept-select-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 100;
    background: #0b0b0f;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    padding: 4px;
    min-width: 150px;
    display: none;
  }

  .dept-select-container.open .dept-select-dropdown {
    display: block;
  }

  .dept-option {
        display: flex;
        align-items: center;
    gap: 8px;
    padding: 6px 8px;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.2s ease;
  }

  .dept-option:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .dept-option input[type="checkbox"] {
    width: 14px;
    height: 14px;
  }

  .dept-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 8px;
  }

  .dept-badge {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .dept-badge.fa { background: rgba(239, 68, 68, 0.1); color: #ef4444; border-color: rgba(239, 68, 68, 0.2); }
  .dept-badge.inv { background: rgba(234, 179, 8, 0.1); color: #eab308; border-color: rgba(234, 179, 8, 0.2); }
  .dept-badge.ana { background: rgba(147, 51, 234, 0.1); color: #9333ea; border-color: rgba(147, 51, 234, 0.2); }
  .dept-badge.sup { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border-color: rgba(59, 130, 246, 0.2); }

  /* Rank Styles */
  .rank-badge {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    padding: 2px 4px;
    border-radius: 4px;
    font-size: 11px;
    margin-right: 8px;
  }

  .rank-badge.intern { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }
  .rank-badge.trainee { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
  .rank-badge.recruit { background: rgba(234, 179, 8, 0.2); color: #eab308; }
  .rank-badge.agent { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
  .rank-badge.special { background: rgba(168, 85, 247, 0.2); color: #a855f7; }

  .rank-select {
    position: relative;
    display: inline-block;
  }

  .rank-select-btn {
    background: rgba(253, 224, 71, 0.1);
        color: #fde047;
    border: 1px solid rgba(253, 224, 71, 0.2);
    border-radius: 4px;
        padding: 4px 8px;
        font-size: 11px;
        cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .rank-select-btn:hover {
    background: rgba(253, 224, 71, 0.2);
  }

  .rank-select-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 100;
    background: #0b0b0f;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    padding: 4px;
    min-width: 150px;
    display: none;
  }

  .rank-select.open .rank-select-dropdown {
    display: block;
  }

  .rank-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.2s ease;
  }

  .rank-option:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .rank-option.selected {
    background: rgba(253, 224, 71, 0.1);
  }

  /* Agent Info Styles */
  .agent-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .callsign {
      color: #fde047;
    font-family: 'Courier New', monospace;
    font-weight: bold;
  }

  .codename {
    color: #22c55e;
    font-style: italic;
  }

  .uc-name {
    color: #ef4444;
    text-decoration: underline;
  }

  /* Handler Styles */
  .handler-cell {
    position: relative;
  }

  .handler-text {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .handler-text:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .handler-text::after {
    content: '✎';
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .handler-text:hover::after {
    opacity: 0.6;
  }

  .handler-edit {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    padding: 4px;
    border-radius: 4px;
    z-index: 10;
  }

  .handler-edit.active {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .handler-edit input {
    flex: 1;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    padding: 4px 8px;
    color: #fff;
    font-size: 13px;
  }

  .handler-edit button {
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s ease;
    padding: 4px;
  }

  .handler-edit button:hover {
    opacity: 1;
  }

  #mainContent {
    display: none;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
    </style>
    </head>
    <body>
  <img src="https://kappa.lol/3qib3z" alt="FIB Seal" class="fib-seal">
  

    <!-- CLASSIFIED ENTRY SCREEN -->
    <div id="classifiedEntry" class="classified-entry">
    <img src="https://kappa.lol/3qib3z" alt="FIB Logo" class="classified-watermark">
      <div class="classified-content">
          <div class="classified-logo">FIB</div>
          <div class="classified-title">FEDERAL INVESTIGATION BUREAU</div>
      <div class="classified-subtitle">TRAINING DATABASE ACCESS</div>
          
          <div class="access-sequence">
            <div class="access-line">
              <span class="prompt">> INITIALIZING SYSTEM...</span>
            </div>
            <div class="access-line">
              <span class="prompt">> ACCESSING SECURE SERVER...</span>
            </div>
            <div class="access-line">
              <span class="prompt">> ENCRYPTION: AES-256</span>
            </div>
            <div class="access-line">
              <span class="prompt">> AUTHENTICATING USER...</span>
            </div>
            <div class="access-line">
              <span class="prompt">> ACCESS GRANTED</span>
            </div>
            <div class="access-line">
              <span class="prompt">> LOADING DATABASE...</span>
            </div>
            <div class="access-line">
              <span class="prompt">> WELCOME TO FIB TRAINING SYSTEM</span>
            </div>
          </div>
        </div>
      </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="profile-modal">
    <div class="profile-content">
      <div class="profile-header">
        <div class="profile-name" id="profileName"></div>
        <button class="profile-close" onclick="closeProfile()">&times;</button>
          </div>
      <div class="profile-grid">
        <div class="profile-section">
          <div class="profile-section-title">Basic Information</div>
          <ul class="profile-info-list">
            <li class="profile-info-item">
              <span class="profile-info-label">Rank:</span>
              <span class="profile-info-value" id="profileRank"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Callsign:</span>
              <span class="profile-info-value" id="profileCallsign" style="cursor: pointer" onclick="editField(this, 'callsign')"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Code Name:</span>
              <span class="profile-info-value" id="profileCodename" style="cursor: pointer" onclick="editField(this, 'codename')"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Undercover Alias:</span>
              <span class="profile-info-value" id="profileUC" style="cursor: pointer" onclick="editField(this, 'ucAlias')"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Date Joined:</span>
              <span class="profile-info-value" id="profileJoinDate"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Division:</span>
              <span class="profile-info-value" id="profileDivision"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">FIB Handler:</span>
              <span class="profile-info-value" id="profileHandler"></span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Training Status:</span>
              <span class="profile-info-value" id="profileStatus"></span>
            </li>
          </ul>
          </div>
        <div class="profile-section">
          <div class="profile-section-title">Certificates</div>
          <div class="profile-certificates" id="profileCertificates"></div>
        </div>
        <div class="profile-section">
          <div class="profile-section-title">Record</div>
          <ul class="profile-info-list">
            <li class="profile-info-item">
              <span class="profile-info-label">Strikes:</span>
              <span class="profile-info-value profile-strikes" id="profileStrikes">None</span>
            </li>
            <li class="profile-info-item">
              <span class="profile-info-label">Commendations:</span>
              <span class="profile-info-value profile-commendations" id="profileCommendations">None</span>
            </li>
          </ul>
          </div>
        </div>
      <div class="profile-section">
        <div class="profile-section-title">Training Timeline</div>
        <ul class="profile-timeline" id="profileTimeline"></ul>
        </div>
        </div>
        </div>
        
  <div class="wrap" id="mainContent">
    <div id="top" class="toolbar">
      <button id="collapseBtn" class="collapse-btn" type="button">
        <span class="collapse-text">Collapse</span>
      </button>
      <div class="brand">
        <img src="https://kappa.lol/3qib3z" alt="FIB Logo" />
        <h1>FIB TRAINING TRACKER</h1>
    </div>
  </div>

    <div class="add-trainee-form">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div class="form-title">Add New Trainee</div>
        <div id="connectionStatus" style="display: flex; align-items: center; gap: 8px;">
          <span class="status-dot"></span>
          <span class="status-text">Connecting...</span>
    </div>
  </div>
      <div class="form-row">
        <div class="form-group">
          <label for="traineeName">Trainee Name</label>
          <input type="text" id="traineeName" placeholder="Enter trainee name">
          </div>
        <div class="form-group">
          <label for="traineeHandler">FIB Handler</label>
          <input type="text" id="traineeHandler" placeholder="Enter FIB handler">
          </div>
          </div>
      <div class="form-row" style="justify-content: space-between;">
        <button type="button" class="save-btn" id="addTraineeBtn">Add Trainee</button>
        <input type="file" id="loadBackup" accept=".json" style="display: none;">
        <button type="button" class="save-btn" onclick="document.getElementById('loadBackup').click()">Load Backup</button>
          </div>
          </div>

    <div class="training-section">
      <h2>Training Progress</h2>
      <div class="table-container">
        <table class="training-table" id="trainingTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Rank</th>
              <th>Name</th>
              <th>Department</th>
              <th>Code Name</th>
              <th>Alias</th>
              <th>FIB Handler</th>
              <th>Training Progress</th>
            </tr>
          </thead>
          <tbody id="trainingTableBody">
          </tbody>
        </table>
          </div>
          </div>

          </div>

    <script>

    // Handle toolbar collapse/expand

    // Close dropdowns and edit fields when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.dept-select-container')) {
        document.querySelectorAll('.dept-select-container').forEach(container => {
          container.classList.remove('open');
        });
      }
      if (!e.target.closest('.rank-select')) {
        document.querySelectorAll('.rank-select').forEach(select => {
          select.classList.remove('open');
        });
      }
      if (!e.target.closest('.handler-edit') && !e.target.closest('.handler-text')) {
        document.querySelectorAll('.handler-edit').forEach(edit => {
          edit.classList.remove('active');
        });
      }
    });

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Get elements
      const mainContent = document.getElementById('mainContent');
      const classifiedEntry = document.getElementById('classifiedEntry');

      // Initial state
      mainContent.style.display = 'none';
      mainContent.style.opacity = '0';
      classifiedEntry.style.display = 'flex';
      classifiedEntry.style.opacity = '1';

      // Simple animation sequence
      setTimeout(() => {
        // Fade out entry screen
        classifiedEntry.style.transition = 'opacity 1.5s ease-out';
        classifiedEntry.style.opacity = '0';
        
        // Show main content
        setTimeout(() => {
          classifiedEntry.style.display = 'none';
          mainContent.style.display = 'block';
          mainContent.style.opacity = '0';
          mainContent.style.transition = 'opacity 1s ease-in';
          requestAnimationFrame(() => {
            mainContent.style.opacity = '1';
          });
        }, 1500);
      }, 4000);
    });

    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize toolbar
      const toolbar = document.getElementById('top');
      const collapseBtn = document.getElementById('collapseBtn');
      const collapseText = collapseBtn.querySelector('.collapse-text');
      
      collapseBtn.addEventListener('click', () => {
        toolbar.classList.toggle('collapsed');
        collapseText.textContent = toolbar.classList.contains('collapsed') ? 'Expand' : 'Collapse';
      });

      // Load saved trainees
      try {
        // Try to load from Google Sheet first
        await loadTrainees();
      } catch (error) {
        console.error('Failed to load from Google Sheet, trying localStorage:', error);
        // Fall back to localStorage if Google Sheet fails
        const savedTrainees = localStorage.getItem('trainees');
        if (savedTrainees) {
          trainees = JSON.parse(savedTrainees);
          updateTrainingTable();
        }
      }

      // Set up add trainee button
      const addTraineeBtn = document.getElementById('addTraineeBtn');
      if (addTraineeBtn) {
        addTraineeBtn.addEventListener('click', addNewTrainee);
      } else {
        console.error('Add trainee button not found!');
      }

      // Set up backup file loading
      const loadBackup = document.getElementById('loadBackup');
      loadBackup.addEventListener('change', async (event) => {
        try {
          const file = event.target.files[0];
          if (!file) return;
          
          const text = await file.text();
          const data = JSON.parse(text);
          
          if (Array.isArray(data)) {
            trainees = data;
            saveTrainees();
            updateTrainingTable();
            alert('Backup loaded successfully!');
          } else {
            throw new Error('Invalid backup file format');
          }
        } catch (error) {
          console.error('Error loading backup:', error);
          alert('Error loading backup file. Please make sure it is a valid backup file.');
        }
        loadBackup.value = ''; // Reset file input
      });
    });

    // Training data management
    let trainees = [];

    async function loadTrainees() {
      try {
        if (!window.fbRef || !window.fbDatabase) {
          showDatabaseError('Database not initialized. Please refresh the page.');
          return;
        }

        console.log('Loading trainees from database...');
        const traineesRef = fbRef(fbDatabase, 'trainees');
        
        // Set up real-time listener
        fbOnValue(traineesRef, (snapshot) => {
          console.log('Received database update');
          const raw = snapshot.val() || {};
          
          // Preserve IDs as keys when converting to array
          trainees = Object.entries(raw).map(([id, t]) => ({ id, ...t }));
          console.log('Loaded trainees:', trainees);
          
          updateTrainingTable();
        }, (error) => {
          console.error('Database read error:', error);
          showDatabaseError('Error reading from database. Please refresh the page.');
        });
      } catch (error) {
        console.error('Error in loadTrainees:', error);
        showDatabaseError('Failed to load trainees. Please refresh the page.');
      }
    }

    function showDatabaseError(message) {
      // Create error notice
      const notice = document.createElement('div');
      notice.style.background = 'rgba(239, 68, 68, 0.1)';
      notice.style.border = '1px solid #ef4444';
      notice.style.borderRadius = '8px';
      notice.style.padding = '12px';
      notice.style.marginBottom = '16px';
      notice.style.color = '#ef4444';
      notice.style.fontSize = '14px';
      notice.innerHTML = `<strong>⚠️ Database Error:</strong> ${message}`;
      
      // Clear the table and show error message
      const tbody = document.getElementById('trainingTableBody');
      if (tbody) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 20px; color: #ef4444;">
              Database connection required to view trainees
            </td>
          </tr>
        `;
      }

      // Show error notice above the form
      const addTraineeForm = document.querySelector('.add-trainee-form');
      if (addTraineeForm) {
        // Remove any existing notices
        const existingNotice = addTraineeForm.previousElementSibling;
        if (existingNotice && existingNotice.style.background.includes('rgba')) {
          existingNotice.remove();
        }
        addTraineeForm.parentNode.insertBefore(notice, addTraineeForm);
      }

      // Disable form inputs
      disableInterface();
      
      // Update connection status
      const statusDot = document.querySelector('.status-dot');
      const statusText = document.querySelector('.status-text');
      if (statusDot) statusDot.classList.remove('connected');
      if (statusText) {
        statusText.textContent = 'Disconnected';
        statusText.style.color = '#ef4444';
      }
    }

    function enableInterface() {
      // Enable all inputs except collapse button
      const inputs = document.querySelectorAll('input, button, select');
      inputs.forEach(input => {
        if (input.id !== 'collapseBtn') {
          input.disabled = false;
        }
      });

      // Update connection status
      const statusDot = document.querySelector('.status-dot');
      const statusText = document.querySelector('.status-text');
      if (statusDot) statusDot.classList.add('connected');
      if (statusText) {
        statusText.textContent = 'Connected';
        statusText.style.color = '#22c55e';
      }

      // Remove any error messages
      const addTraineeForm = document.querySelector('.add-trainee-form');
      if (addTraineeForm) {
        const existingNotice = addTraineeForm.previousElementSibling;
        if (existingNotice && existingNotice.style.background.includes('rgba')) {
          existingNotice.remove();
        }
      }
    }

    function disableInterface() {
      // Disable all inputs except collapse button
      const inputs = document.querySelectorAll('input, button, select');
      inputs.forEach(input => {
        if (input.id !== 'collapseBtn') {
          input.disabled = true;
        }
      });
    }

    async function saveTrainees() {
      try {
        if (!window.fbRef || !window.fbDatabase) {
          throw new Error('Database not initialized');
        }

        // Structure the data properly for Firebase
        const traineesData = {};
        trainees.forEach((trainee, index) => {
          // Generate a unique ID if one doesn't exist
          const traineeId = trainee.id || `trainee_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          trainee.id = traineeId;
          
          // Ensure all required fields exist with default values
          const structuredTrainee = {
            id: traineeId,
            name: trainee.name || '',
            handler: trainee.handler || '',
            rank: trainee.rank || 'intern',
            callsign: trainee.callsign || '',
            codename: trainee.codename || '',
            ucAlias: trainee.ucAlias || '',
            departments: trainee.departments || [],
            joinDate: trainee.joinDate || new Date().toISOString(),
            skills: trainee.skills || {
              '10Codes': { completed: false, instructor: '', completedDate: null },
              'CaseLaws': { completed: false, instructor: '', completedDate: null },
              'Pursuit': { completed: false, instructor: '', completedDate: null },
              'Hostage': { completed: false, instructor: '', completedDate: null },
              'TrafficStop': { completed: false, instructor: '', completedDate: null },
              'Breaching': { completed: false, instructor: '', completedDate: null },
              'SceneControl': { completed: false, instructor: '', completedDate: null },
              'COMMS': { completed: false, instructor: '', completedDate: null },
              'UseOfForce': { completed: false, instructor: '', completedDate: null },
              'FilingCharges': { completed: false, instructor: '', completedDate: null },
              'Reports': { completed: false, instructor: '', completedDate: null },
              'Gunfight': { completed: false, instructor: '', completedDate: null }
            },
            strikes: trainee.strikes || [],
            commendations: trainee.commendations || [],
            timeline: trainee.timeline || []
          };

          traineesData[traineeId] = structuredTrainee;
        });

        // Save to Firebase using set() to completely replace the data
        const traineesRef = fbRef(fbDatabase, 'trainees');
        await fbSet(traineesRef, traineesData);

        console.log('Successfully saved to database');
        return true;
      } catch (error) {
        console.error('Error saving to database:', error);
        showDatabaseError('Failed to save changes. Please try again.');
        return false;
      }
    }

    async function addNewTrainee() {
      try {
        const nameInput = document.getElementById('traineeName');
        const handlerInput = document.getElementById('traineeHandler');
        
        const name = nameInput.value.trim();
        const handler = handlerInput.value.trim();
        
        if (!name || !handler) {
          alert('Please enter both trainee name and FIB handler');
          return;
        }

        // Create new trainee with proper structure
        const traineeId = `trainee_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const newTrainee = {
          name: name,
          handler: handler,
          rank: 'intern',
          callsign: '',
          codename: '',
          ucAlias: '',
          departments: [],
          joinDate: new Date().toISOString(),
          skills: {
            '10Codes': { completed: false, instructor: '', completedDate: null },
            'CaseLaws': { completed: false, instructor: '', completedDate: null },
            'Pursuit': { completed: false, instructor: '', completedDate: null },
            'Hostage': { completed: false, instructor: '', completedDate: null },
            'TrafficStop': { completed: false, instructor: '', completedDate: null },
            'Breaching': { completed: false, instructor: '', completedDate: null },
            'SceneControl': { completed: false, instructor: '', completedDate: null },
            'COMMS': { completed: false, instructor: '', completedDate: null },
            'UseOfForce': { completed: false, instructor: '', completedDate: null },
            'FilingCharges': { completed: false, instructor: '', completedDate: null },
            'Reports': { completed: false, instructor: '', completedDate: null },
            'Gunfight': { completed: false, instructor: '', completedDate: null }
          },
          strikes: [],
          commendations: [],
          timeline: [{
            date: new Date().toISOString(),
            content: 'Added to training program',
            instructor: handler
          }]
        };

        // Write to specific path in database
        const updates = {};
        updates[`/trainees/${traineeId}`] = newTrainee;
        
        await fbUpdate(fbRef(fbDatabase), updates);
        console.log('Successfully added trainee:', traineeId);

        // Clear inputs
        nameInput.value = '';
        handlerInput.value = '';
      } catch (error) {
        console.error('Error adding trainee:', error);
        showDatabaseError('Failed to add trainee. Please try again.');
      }
    }

    async function deleteTrainee(traineeId) {
      try {
        if (!traineeId) return;
        
        if (confirm('Are you sure you want to delete this trainee?')) {
          // Use update to set the specific trainee to null
          const updates = {};
          updates[`/trainees/${traineeId}`] = null;
          
          await fbUpdate(fbRef(fbDatabase), updates);
          console.log('Successfully deleted trainee:', traineeId);
        }
      } catch (error) {
        console.error('Error deleting trainee:', error);
        showDatabaseError('Failed to delete trainee. Please try again.');
      }
    }

    async function updateTraineeField(traineeId, field, value) {
      try {
        if (!traineeId || !field) return;
        
        // Update specific field only
        const updates = {};
        updates[`/trainees/${traineeId}/${field}`] = value;
        
        await fbUpdate(fbRef(fbDatabase), updates);
        console.log(`Updated trainee ${traineeId} ${field}:`, value);
      } catch (error) {
        console.error('Error updating trainee:', error);
        showDatabaseError('Failed to save changes. Please try again.');
      }
    }




    function updateTrainingTable() {
      try {
        console.log('Updating training table...');
        console.log('Current trainees:', trainees);
        
        // Ensure trainees is an array
        if (!Array.isArray(trainees)) {
          console.error('Trainees is not an array, resetting...');
          trainees = [];
        }
        
        const tbody = document.getElementById('trainingTableBody');
        if (!tbody) {
          console.error('Training table body not found!');
          return;
        }
        
        // Clear the table
        tbody.innerHTML = '';
        
        // If no trainees, show empty message
        if (trainees.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 8; // Updated colspan for our columns
          cell.style.textAlign = 'center';
          cell.style.padding = '20px';
          cell.textContent = 'No trainees added yet';
          row.appendChild(cell);
          tbody.appendChild(row);
          return;
        }

      // Add each trainee to the table
      trainees.forEach((trainee, index) => {
        try {
          const row = document.createElement('tr');

          // # (Callsign) cell
          const callsignCell = document.createElement('td');
          callsignCell.textContent = trainee.callsign || '-';
          callsignCell.className = 'callsign';
          row.appendChild(callsignCell);

          // Rank cell
          const rankCell = document.createElement('td');
          const rankSelect = document.createElement('div');
          rankSelect.className = 'rank-select';
          
          const rankBtn = document.createElement('button');
          rankBtn.className = 'rank-select-btn';
          const currentRank = RANKS.find(r => r.id === trainee.rank) || RANKS[0];
          rankBtn.innerHTML = `<span class="rank-badge ${currentRank.id}">${currentRank.abbr}</span>`;
          rankBtn.onclick = (e) => {
            e.stopPropagation();
            rankSelect.classList.toggle('open');
          };
          rankSelect.appendChild(rankBtn);

          const rankDropdown = document.createElement('div');
          rankDropdown.className = 'rank-select-dropdown';
          RANKS.forEach(rank => {
            const option = document.createElement('div');
            option.className = `rank-option${rank.id === trainee.rank ? ' selected' : ''}`;
            option.innerHTML = `<span class="rank-badge ${rank.id}">${rank.abbr}</span> ${rank.name}`;
            option.onclick = (e) => {
              e.stopPropagation();
              trainee.rank = rank.id;
              saveTrainees();
              updateTrainingTable();
              rankSelect.classList.remove('open');
            };
            rankDropdown.appendChild(option);
          });
          rankSelect.appendChild(rankDropdown);
          rankCell.appendChild(rankSelect);
          row.appendChild(rankCell);

          // Name cell
          const nameCell = document.createElement('td');
          const nameWrapper = document.createElement('div');
          nameWrapper.style.display = 'flex';
          nameWrapper.style.alignItems = 'center';
          nameWrapper.style.gap = '8px';
          
          const nameText = document.createElement('span');
          nameText.textContent = trainee.name || 'Unknown';
          nameText.style.cursor = 'pointer';
          nameText.onclick = () => showProfile(trainee);
          nameWrapper.appendChild(nameText);

          const deleteButton = document.createElement('button');
          deleteButton.className = 'delete-btn';
          deleteButton.textContent = 'Delete';
          deleteButton.onclick = () => deleteTrainee(index);
          nameWrapper.appendChild(deleteButton);
          
          nameCell.appendChild(nameWrapper);
          row.appendChild(nameCell);

          // Department cell
          const deptCell = document.createElement('td');
          const deptContainer = document.createElement('div');
          deptContainer.className = 'dept-select-container';

          const deptButton = document.createElement('button');
          deptButton.className = 'dept-select-btn';
          deptButton.textContent = trainee.departments && trainee.departments.length > 0 ? 'Edit Depts' : 'Add Depts';
          deptButton.onclick = (e) => {
            e.stopPropagation();
            const container = e.target.closest('.dept-select-container');
            container.classList.toggle('open');
          };
          deptContainer.appendChild(deptButton);

          const deptDropdown = document.createElement('div');
          deptDropdown.className = 'dept-select-dropdown';

          const departments = [
            { id: 'fa', name: 'Field Agents', abbr: 'FA' },
            { id: 'inv', name: 'Investigators', abbr: 'INV' },
            { id: 'ana', name: 'Analysts', abbr: 'ANA' },
            { id: 'sup', name: 'Supernatural', abbr: 'SUP' }
          ];

          departments.forEach(dept => {
            const option = document.createElement('label');
            option.className = 'dept-option';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = trainee.departments && trainee.departments.includes(dept.id);
            checkbox.onchange = (e) => {
              e.stopPropagation();
              if (!trainee.departments) trainee.departments = [];
              
              if (e.target.checked) {
                trainee.departments.push(dept.id);
                trainee.timeline.push({
                  date: new Date().toISOString(),
                  content: `Added to ${dept.name} Department`,
                  instructor: 'System'
                });
              } else {
                trainee.departments = trainee.departments.filter(d => d !== dept.id);
                trainee.timeline.push({
                  date: new Date().toISOString(),
                  content: `Removed from ${dept.name} Department`,
                  instructor: 'System'
                });
              }
              saveTrainees();
              updateTrainingTable();
            };

            option.appendChild(checkbox);
            option.appendChild(document.createTextNode(dept.name));
            deptDropdown.appendChild(option);
          });

          deptContainer.appendChild(deptDropdown);
          deptCell.appendChild(deptContainer);

          // Add department badges if any departments are selected
          if (trainee.departments && trainee.departments.length > 0) {
            const badgesContainer = document.createElement('div');
            badgesContainer.className = 'dept-badges';

            trainee.departments.forEach(deptId => {
              const dept = departments.find(d => d.id === deptId);
              if (dept) {
                const badge = document.createElement('div');
                badge.className = `dept-badge ${deptId}`;
                badge.textContent = dept.abbr;
                badgesContainer.appendChild(badge);
              }
            });

            deptCell.appendChild(badgesContainer);
          }

          row.appendChild(deptCell);

          // Code Name cell
          const codenameCell = document.createElement('td');
          codenameCell.textContent = trainee.codename || '-';
          codenameCell.className = 'codename';
          row.appendChild(codenameCell);

          // Alias cell
          const aliasCell = document.createElement('td');
          aliasCell.textContent = trainee.ucAlias || trainee.alias || '-';
          aliasCell.className = 'uc-name';
          aliasCell.style.cursor = 'pointer';
          aliasCell.onclick = () => {
            const newAlias = prompt('Enter new alias:', trainee.ucAlias || trainee.alias || '');
            if (newAlias !== null) {
              trainee.ucAlias = newAlias;
              trainee.timeline.push({
                date: new Date().toISOString(),
                content: `Alias updated to: ${newAlias}`,
                instructor: 'System'
              });
              saveTrainees();
              updateTrainingTable();
            }
          };
          row.appendChild(aliasCell);

          // FIB Handler cell
          const handlerCell = document.createElement('td');
          handlerCell.textContent = trainee.handler || '-';
          row.appendChild(handlerCell);

          // Training Progress cell
          const progressCell = document.createElement('td');
          progressCell.className = 'progress-cell';

          const progressBar = document.createElement('div');
          progressBar.className = 'progress-bar';
          progressBar.onclick = () => showSkillsDialog(trainee, Object.keys(trainee.skills));

          // Calculate progress
          const totalSkills = Object.keys(trainee.skills).length;
          const completedSkills = Object.values(trainee.skills).filter(skill => skill.completed).length;
          const progress = Math.round((completedSkills / totalSkills) * 100);

          const progressFill = document.createElement('div');
          progressFill.className = 'progress-fill';
          progressFill.style.width = `${progress}%`;

          const progressText = document.createElement('div');
          progressText.className = 'progress-text';
          progressText.textContent = `${progress}% Complete`;

          progressBar.appendChild(progressFill);
          progressBar.appendChild(progressText);
          progressCell.appendChild(progressBar);
          row.appendChild(progressCell);

          // Add row to table
          tbody.appendChild(row);
        } catch (error) {
          console.error('Error creating row for trainee:', trainee, error);
        }
      });
      } catch (error) {
        console.error('Error updating training table:', error);
      }
    }

    function showSkillsDialog(trainee, skills) {
      const dialog = document.createElement('div');
      dialog.className = 'password-dialog';
      dialog.style.display = 'block';

      const title = document.createElement('div');
      title.className = 'password-dialog-title';
      title.textContent = `Select Training for ${trainee.name}`;
      dialog.appendChild(title);

      const list = document.createElement('div');
      list.style.marginBottom = '20px';
      list.style.maxHeight = '300px';
      list.style.overflowY = 'auto';

      skills.forEach((skill, index) => {
        const data = trainee.skills[skill];
        const item = document.createElement('div');
        item.style.padding = '8px';
        item.style.cursor = 'pointer';
        item.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.gap = '8px';

        const number = document.createElement('span');
        number.style.color = '#fde047';
        number.style.fontWeight = 'bold';
        number.textContent = `${index + 1}.`;
        item.appendChild(number);

        const text = document.createElement('span');
        text.textContent = `${skill.replace(/([A-Z])/g, ' $1').trim()}`;
        if (data.completed) {
          text.style.color = '#22c55e';
          text.textContent += ` (✓ ${data.instructor})`;
        }
        item.appendChild(text);

        item.onclick = () => {
          dialog.remove();
          toggleSkill(trainee, skill);
        };

        item.onmouseover = () => {
          item.style.backgroundColor = 'rgba(255,255,255,0.05)';
        };
        item.onmouseout = () => {
          item.style.backgroundColor = '';
        };

        list.appendChild(item);
      });
      dialog.appendChild(list);

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'password-dialog-buttons';
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'password-dialog-btn';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.onclick = () => dialog.remove();
      buttonContainer.appendChild(cancelBtn);
      
      dialog.appendChild(buttonContainer);
      document.body.appendChild(dialog);
    }

    function toggleSkill(trainee, skill) {
      
      if (trainee.skills[skill].completed) {
        if (confirm(`Remove completion status for ${skill.replace(/([A-Z])/g, ' $1').trim()}?`)) {
          trainee.skills[skill].completed = false;
          trainee.skills[skill].instructor = '';
          trainee.skills[skill].completedDate = null;
          trainee.timeline = trainee.timeline.filter(event => 
            !event.content.includes(`Completed ${skill.replace(/([A-Z])/g, ' $1').trim()} Training`)
          );
              saveTrainees();
              updateTrainingTable();
        }
          } else {
        const instructor = prompt(`Enter instructor name for ${skill.replace(/([A-Z])/g, ' $1').trim()}:`);
        if (instructor) {
          const now = new Date();
          trainee.skills[skill].completed = true;
          trainee.skills[skill].instructor = instructor;
          trainee.skills[skill].completedDate = now.toISOString();
          trainee.timeline.push({
            date: now.toISOString(),
            content: `Completed ${skill.replace(/([A-Z])/g, ' $1').trim()} Training`,
            instructor: instructor
          });
              saveTrainees();
              updateTrainingTable();
        }
      }
    }

    function showStrikeForm(trainee, type) {
      const dialog = document.createElement('div');
      dialog.className = 'password-dialog';
      dialog.style.display = 'block';

      const title = document.createElement('div');
      title.className = 'password-dialog-title';
      title.textContent = type === 'strike' ? 'Add Strike' : 'Add Commendation';
      dialog.appendChild(title);

      const form = document.createElement('div');
      form.style.marginBottom = '20px';

      // Submitting Agent field
      const agentLabel = document.createElement('div');
      agentLabel.style.marginBottom = '8px';
      agentLabel.textContent = 'Submitting Agent:';
      form.appendChild(agentLabel);

      const agentInput = document.createElement('input');
      agentInput.className = 'password-input';
      agentInput.style.marginBottom = '16px';
      agentInput.placeholder = 'Enter agent name';
      form.appendChild(agentInput);

      // Reason field
      const reasonLabel = document.createElement('div');
      reasonLabel.style.marginBottom = '8px';
      reasonLabel.textContent = type === 'strike' ? 'Strike Reason:' : 'Commendation:';
      form.appendChild(reasonLabel);

      const reasonInput = document.createElement('textarea');
      reasonInput.className = 'password-input';
      reasonInput.style.height = '100px';
      reasonInput.style.resize = 'vertical';
      reasonInput.placeholder = type === 'strike' ? 'Enter detailed strike reason' : 'Enter detailed commendation';
      form.appendChild(reasonInput);

      dialog.appendChild(form);

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'password-dialog-buttons';
      
      const submitBtn = document.createElement('button');
      submitBtn.className = 'password-dialog-btn';
      submitBtn.textContent = 'Submit';
      submitBtn.onclick = () => {
        const agent = agentInput.value.trim();
        const reason = reasonInput.value.trim();
        
        if (!agent || !reason) {
          alert('Please fill in all fields');
          return;
        }

        const entry = `${reason} (by ${agent})`;
        if (type === 'strike') {
          trainee.strikes.push(entry);
        } else {
          trainee.commendations.push(entry);
        }

        trainee.timeline.push({
          date: new Date().toISOString(),
          content: type === 'strike' ? `Received Strike: ${reason}` : `Received Commendation: ${reason}`,
          instructor: agent
        });

        saveTrainees();
        showProfile(trainee);
        dialog.remove();
      };
      buttonContainer.appendChild(submitBtn);
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'password-dialog-btn';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.onclick = () => dialog.remove();
      buttonContainer.appendChild(cancelBtn);
      
      dialog.appendChild(buttonContainer);
      document.body.appendChild(dialog);
    }

    function showRecordDetails(record, type) {
      const dialog = document.createElement('div');
      dialog.className = 'password-dialog';
      dialog.style.display = 'block';

      const title = document.createElement('div');
      title.className = 'password-dialog-title';
      title.textContent = type;
      dialog.appendChild(title);

      const content = document.createElement('div');
      content.style.marginBottom = '20px';
      content.style.whiteSpace = 'pre-wrap';
      content.style.wordBreak = 'break-word';
      
      const reason = record.replace(/\s*\(by .*?\)$/, '');
      const agent = record.match(/by (.*?)\)$/)[1];

      const reasonText = document.createElement('div');
      reasonText.style.marginBottom = '16px';
      reasonText.style.fontSize = '14px';
      reasonText.textContent = reason;
      content.appendChild(reasonText);

      const agentText = document.createElement('div');
      agentText.style.color = '#fde047';
      agentText.style.fontSize = '12px';
      agentText.textContent = `Submitted by: ${agent}`;
      content.appendChild(agentText);

      dialog.appendChild(content);

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'password-dialog-buttons';
      
      const closeBtn = document.createElement('button');
      closeBtn.className = 'password-dialog-btn';
      closeBtn.textContent = 'Close';
      closeBtn.onclick = () => dialog.remove();
      buttonContainer.appendChild(closeBtn);
      
      dialog.appendChild(buttonContainer);
      document.body.appendChild(dialog);
    }

    function editField(element, field) {
      const currentValue = element.textContent;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentValue;
      input.className = 'password-input';
      input.style.margin = '0';
      input.style.padding = '2px 4px';
      input.style.fontSize = '13px';

      const save = () => {
        const newValue = input.value.trim();
        const traineeIndex = trainees.findIndex(t => t.name === currentTrainee.name);
        if (traineeIndex !== -1) {
          trainees[traineeIndex][field] = newValue;
          saveTrainees();
          updateTrainingTable();
          showProfile(trainees[traineeIndex]);
        }
      };

      input.onblur = save;
      input.onkeypress = (e) => {
        if (e.key === 'Enter') {
          save();
        }
      };

      element.innerHTML = '';
      element.appendChild(input);
      input.focus();
    }

    const RANKS = [
      { id: 'intern', name: 'INTERN', abbr: 'INT' },
      { id: 'trainee', name: 'TRAINEE', abbr: 'TRN' },
      { id: 'recruit', name: 'RECRUIT', abbr: 'RCT' },
      { id: 'agent', name: 'AGENT', abbr: 'AGT' },
      { id: 'special', name: 'SPECIAL AGENT', abbr: 'SA' }
    ];

    let currentTrainee = null;

    function showProfile(trainee) {
      currentTrainee = trainee;
      const modal = document.getElementById('profileModal');
      
      // Set basic info
      const currentRank = RANKS.find(r => r.id === trainee.rank) || RANKS[0];
      document.getElementById('profileName').innerHTML = `<span class="rank-badge ${currentRank.id}">${currentRank.abbr}</span> ${trainee.name}`;
      document.getElementById('profileRank').textContent = currentRank.name;
      document.getElementById('profileCallsign').textContent = trainee.callsign || 'Not Set';
      document.getElementById('profileCodename').textContent = trainee.codename || 'Not Set';
      document.getElementById('profileUC').textContent = trainee.ucAlias || 'Not Set';
      document.getElementById('profileJoinDate').textContent = new Date(trainee.joinDate).toLocaleDateString();
      // Show departments as badges
      const deptDiv = document.getElementById('profileDivision');
      deptDiv.innerHTML = '';
      if (trainee.departments && trainee.departments.length > 0) {
        const deptBadges = document.createElement('div');
        deptBadges.className = 'dept-badges';
        trainee.departments.forEach(deptId => {
          const badge = document.createElement('div');
          badge.className = `dept-badge ${deptId}`;
          badge.textContent = {
            'fa': 'FA',
            'inv': 'INV',
            'ana': 'ANA',
            'sup': 'SUP'
          }[deptId] || deptId.toUpperCase();
          deptBadges.appendChild(badge);
        });
        deptDiv.appendChild(deptBadges);
      } else {
        deptDiv.textContent = 'Not Assigned';
      }

      // Show handler
      document.getElementById('profileHandler').textContent = trainee.handler || 'Not Assigned';
      
      // Calculate training status
      const skills = [
        '10Codes', 'CaseLaws', 'Pursuit', 'Hostage', 'TrafficStop', 
        'Breaching', 'SceneControl', 'COMMS', 'UseOfForce', 
        'FilingCharges', 'Reports', 'Gunfight'
      ];
      
      const completedSkills = skills.filter(skill => trainee.skills[skill].completed).length;
      const totalSkills = skills.length;
      const progress = Math.round((completedSkills / totalSkills) * 100);
      
      let status = '';
      if (progress === 100) {
        status = '<span style="color: #22c55e">Training Complete ✓</span>';
          } else {
        status = `<span style="color: #9ca3af">In Training (${progress}%)</span>`;
      }
      document.getElementById('profileStatus').innerHTML = status;
      
      // Set certificates
      const certificates = document.getElementById('profileCertificates');
      certificates.innerHTML = '';
      
      skills.forEach(skill => {
        if (trainee.skills[skill].completed) {
          const badge = document.createElement('div');
          badge.className = 'certificate-badge';
          badge.textContent = skill.replace(/([A-Z])/g, ' $1').trim();
          certificates.appendChild(badge);
        }
      });
      
      // Set record
      // Update strikes with add button
      const strikesDiv = document.getElementById('profileStrikes');
      strikesDiv.innerHTML = '';
      const strikesWrapper = document.createElement('div');
      strikesWrapper.style.display = 'flex';
      strikesWrapper.style.alignItems = 'center';
      strikesWrapper.style.gap = '8px';
      
      const strikesText = document.createElement('span');
      strikesText.className = 'profile-strikes';
      if (trainee.strikes.length > 0) {
        const strikesList = document.createElement('div');
        strikesList.style.display = 'flex';
        strikesList.style.flexDirection = 'column';
        strikesList.style.gap = '4px';
        
        trainee.strikes.forEach(strike => {
          const agent = strike.match(/by (.*?)\)$/)[1];
          const strikeLink = document.createElement('span');
          strikeLink.style.cursor = 'pointer';
          strikeLink.style.textDecoration = 'underline';
          strikeLink.textContent = agent;
          strikeLink.onclick = () => showRecordDetails(strike, 'Strike');
          strikesList.appendChild(strikeLink);
        });
        strikesText.appendChild(strikesList);
      } else {
        strikesText.textContent = 'None';
      }
      strikesWrapper.appendChild(strikesText);
      
      const addStrikeBtn = document.createElement('button');
      addStrikeBtn.className = 'dept-btn';
      addStrikeBtn.textContent = '+';
      addStrikeBtn.onclick = () => showStrikeForm(trainee, 'strike');
      strikesWrapper.appendChild(addStrikeBtn);
      strikesDiv.appendChild(strikesWrapper);

      // Update commendations with add button
      const commsDiv = document.getElementById('profileCommendations');
      commsDiv.innerHTML = '';
      const commsWrapper = document.createElement('div');
      commsWrapper.style.display = 'flex';
      commsWrapper.style.alignItems = 'center';
      commsWrapper.style.gap = '8px';
      
      const commsText = document.createElement('span');
      commsText.className = 'profile-commendations';
      if (trainee.commendations.length > 0) {
        const commsList = document.createElement('div');
        commsList.style.display = 'flex';
        commsList.style.flexDirection = 'column';
        commsList.style.gap = '4px';
        
        trainee.commendations.forEach(comm => {
          const agent = comm.match(/by (.*?)\)$/)[1];
          const commLink = document.createElement('span');
          commLink.style.cursor = 'pointer';
          commLink.style.textDecoration = 'underline';
          commLink.textContent = agent;
          commLink.onclick = () => showRecordDetails(comm, 'Commendation');
          commsList.appendChild(commLink);
        });
        commsText.appendChild(commsList);
      } else {
        commsText.textContent = 'None';
      }
      commsWrapper.appendChild(commsText);
      
      const addCommBtn = document.createElement('button');
      addCommBtn.className = 'dept-btn';
      addCommBtn.textContent = '+';
      addCommBtn.onclick = () => showStrikeForm(trainee, 'commendation');
      commsWrapper.appendChild(addCommBtn);
      commsDiv.appendChild(commsWrapper);
      
      // Set timeline
      const timeline = document.getElementById('profileTimeline');
      timeline.innerHTML = '';
      
      // Add skill completions to timeline
      const events = [];
      
      skills.forEach(skill => {
        const data = trainee.skills[skill];
        if (data.completed && data.completedDate) {
          events.push({
            date: new Date(data.completedDate),
            content: `Completed ${skill.replace(/([A-Z])/g, ' $1').trim()} Training`,
            instructor: data.instructor
          });
        }
      });
      
      // Add custom timeline events
      trainee.timeline.forEach(event => {
        events.push({
          date: new Date(event.date),
          content: event.content,
          instructor: event.instructor
        });
      });
      
      // Sort events by date (newest first)
      events.sort((a, b) => b.date - a.date);
      
      events.forEach(event => {
        const item = document.createElement('li');
        item.className = 'timeline-item';
        
        const date = document.createElement('div');
        date.className = 'timeline-date';
        date.textContent = event.date.toLocaleDateString();
        
        const content = document.createElement('div');
        content.className = 'timeline-content';
        content.textContent = event.content;
        
        const instructor = document.createElement('div');
        instructor.className = 'timeline-instructor';
        instructor.textContent = `Signed by ${event.instructor}`;
        
        item.appendChild(date);
        item.appendChild(content);
        item.appendChild(instructor);
        timeline.appendChild(item);
      });
      
      modal.style.display = 'block';
    }
    
    function closeProfile() {
      document.getElementById('profileModal').style.display = 'none';
    }
    
    function showDeptSkillsDialog(trainee, skills) {
      const skillsList = skills.map(skill => {
        const data = trainee.skills[skill];
        return `${skill} Division: ${data.completed ? '✓' : '✗'}${data.completed ? ` (${data.instructor})` : ''}`;
      }).join('\n');

      const selectedSkill = prompt(`Select a department to toggle for ${trainee.name}:\n\n${skillsList}\n\nType the department name exactly as shown (e.g. "Supernatural"):`);
      
      if (!selectedSkill) return;
      
      const skill = skills.find(s => s.toLowerCase() === selectedSkill.toLowerCase());
      if (!skill) {
        alert('Invalid department name. Please try again.');
        return;
      }
      
      if (trainee.skills[skill].completed) {
        if (confirm(`Remove ${skill} Division assignment?`)) {
          trainee.skills[skill].completed = false;
          trainee.skills[skill].instructor = '';
              saveTrainees();
              updateTrainingTable();
        }
      } else {
        const instructor = prompt(`Enter instructor name for ${skill} Division assignment:`);
        if (instructor) {
          trainee.skills[skill].completed = true;
          trainee.skills[skill].instructor = instructor;
              saveTrainees();
              updateTrainingTable();
        }
      }
    }
    </script>

    <!-- Embedded trainee data -->
    <script id="traineeData" type="application/json">[]</script>
    </body>
    </html>
